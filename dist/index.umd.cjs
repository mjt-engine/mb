(function(g,b){typeof exports=="object"&&typeof module<"u"?b(exports):typeof define=="function"&&define.amd?define(["exports"],b):(g=typeof globalThis<"u"?globalThis:g||self,b(g.Module={}))})(this,function(g){"use strict";const b=e=>{const t=e.split("."),s=t.shift(),n=t.join(".");return{root:s,segments:t,subpath:n}},q=e=>"value"in e&&e.value!==void 0,T=e=>"error"in e&&e.error!==void 0,A=e=>q(e)||T(e),D=e=>{const t=e;return typeof t=="object"&&t!==null&&"data"in t},x=e=>{const t=e;return D(e)&&t.meta?.hasError||!1},V=e=>typeof e=="function",I=e=>e==null||Number.isNaN(e),O=e=>!I(e),B=e=>V(e)?e():e,J={isDefined:O,isUndefined:I,safe:(e,t={})=>{const{quiet:s=!1,def:n=void 0,onError:r}=t;try{return e()}catch(o){return s||(console.error(o),O(r)&&console.log(B(r))),n}}},{isDefined:$,isUndefined:P,safe:C}=J,L=e=>e==null||Number.isNaN(e),K=e=>!L(e),Q={isDefined:K,isUndefined:L},{isDefined:h,isUndefined:F}=Q,G=(e,t,s)=>{if(F(e))return;const n=t.get(e);if(h(n))return n;if(h(s)){const r=s();return t.set(e,r),r}},H=()=>{const e=new Map;let t=performance.now();const s={get:(n,r)=>G(n,e,r),set:(n,r)=>(e.set(n,r),s),delete:n=>e.delete(n),entries:()=>Array.from(e.entries()),clear:()=>e.clear(),size:()=>e.size,findKeys:n=>Array.from(e.entries()).filter(([r,o])=>o===n).map(([r,o])=>r),lastUpdate:()=>t};return s},W={create:H},X=e=>t=>{if(typeof e=="string")return new RegExp(e).test(t.traceId);const{traceId:s,message:n,extra:r=()=>!0,timestamp:o=()=>!0}=e;return!(s&&!new RegExp(s).test(t.traceId)||n&&!new RegExp(n).test(t.message)||t.timestamp&&!o(t.timestamp)||t.extra&&!r(t.extra))},Y=e=>t=>{for(const s of e)if(X(s)(t))return s;return!1},Z=e=>t=>typeof e=="string"?t:e.transform?e.transform(t):t,w=e=>{const t=[],s={length:0,push:n=>{t.length>=e&&t.shift(),t.push(n),s.length=t.length},get:()=>t,clear:()=>{t.length=0,s.length=0},last:()=>t[t.length-1]};return s},z=()=>{let e=performance.now(),t;const s={end:()=>(h(t)||(t=performance.now()),s),getDuration:()=>(t??performance.now())-e};return s},_=(e=100)=>{let t=0;const s=new Map,n=new Map,r=w(e),o={time:()=>{const a=r.last();h(a)&&a.end();const c=z();return r.push(c),c},getTimes:()=>r.get(),timer:a=>{const c=n.get(a)??w(e);n.set(a,c);const d=z();return c.push(d),d},counter:(a,c=1)=>{const d=s.get(a)??0;s.set(a,d+c)},getCounters:()=>new Map(s),getCounter:a=>s.get(a)??0,count:(a=1)=>{t+=a},getCount:()=>t,clearCount:()=>(t=0,o),getTimers:a=>(n.get(a)??w(e)).get(),clearTimers:a=>((n.get(a)??w(e)).clear(),o)};return o},ee=({logMatchers:e=[],logger:t=console.log,clock:s=performance}={})=>{const n=W.create(),r={getTraceIds:()=>n.entries().map(([o])=>o),start:(o,...a)=>{r.getStats(o).count(),r.getStats(o).time(),r.addLog({traceId:o,message:"start",extra:a})},getStats:o=>n.get(o,()=>_()),addLog:({traceId:o,message:a,timestamp:c=s.now(),extra:d=[]})=>{const u={traceId:o,message:a,timestamp:c,extra:d},i=Y(e)(u);if(!i)return;const l=Z(i)(u);t(`${l.timestamp} ${l.traceId}: ${l.message}`,...l.extra??[])},end:(o,...a)=>{r.addLog({traceId:o,message:"end",extra:a})}};return r},U=(e="",t=ee())=>{t.start(e);const s={span:n=>U(`${e}.${n}`,t),counter:(n,r=1)=>(t.getStats(e).counter(n,r),s),timer:n=>t.getStats(e).timer(n),end:()=>(t.end(e),s),log:(n,...r)=>(t.addLog({traceId:e,message:n,extra:r}),s)};return s},E=e=>{const{message:t,stack:s,extra:n,cause:r}=e,o=r?`
Caused by: ${E(r)}`:"",a=n?`
Extra: ${JSON.stringify(n,void 0,2)}`:"";return[t,s].filter($).join(`
`)+a+o},j=e=>typeof e=="string"?e:e instanceof Response?`${e.url} ${e.status} ${e.statusText}`:typeof e=="object"&&e!==null&&"message"in e?E(e):C(()=>JSON.stringify(e,void 0,2))??"",te=async e=>{if(typeof e=="string")return e;if(e instanceof Response){const t=await e.text();return`${e.url} ${e.status} ${e.statusText} ${t}`}return typeof e=="object"&&e!==null&&"message"in e?E(e):C(()=>JSON.stringify(e,void 0,2))??""},R=({error:e,extra:t,stack:s})=>{if(e instanceof Error){const n=$(e.cause)?R({error:e.cause}):void 0;return{message:e.message,stack:e.stack??s,extra:t,cause:n}}return{message:j(e),stack:s,extra:t}},ne={errorToErrorDetail:R,errorToText:j,errorToTextAsync:te},v=async({channel:e,subject:t,connectionListener:s,serializer:n,options:r={}})=>{const{log:o=()=>{},signal:a}=r;o("connectConnectionListenerToSubject: subject: ",t);for await(const c of e.listenOn(t,{callback:async d=>{const u=n.deserialize(d),{data:i,meta:l}=u;if(x(u))throw console.error("Error in message: ",u),new Error(`connectConnectionListenerToSubject: Unexpected error in request message: ${u?.data?.message}`);try{const f=await s(i,{headers:l?.headers,signal:a});return n.serialize({data:f})}catch(f){const m=ne.errorToErrorDetail({error:f});return n.serialize({data:m,meta:{hasError:!0,code:500,status:m.message}})}}}));},se=()=>({serialize:e=>e,deserialize:e=>e}),re=async({channel:e,subscribers:t={},options:s={},obs:n=U()})=>{const r=n.span("MessageBus"),{defaultTimeoutMs:o=60*1e3,signal:a,serializer:c=se()}=s,d=Object.entries(t);r.log("connect: subscribers: ",d);for(const[u,i]of d)P(i)||v({serializer:c,channel:e,subject:u,connectionListener:i,options:s});return{requestMany:async(u,i,l={})=>{const f=r.span("requestMany"),{timeoutMs:m=60*1e3,headers:p,callback:y}=l,M=c.serialize({data:i,meta:{headers:p}}),S=f.span("channel requestMany").log("start requestMany",u),oe=await e.requestMany(u,M,{timeoutMs:m});for await(const ie of oe){if(a?.aborted)return;const ce=c.deserialize(ie);await y?.(ce)}S.end(),f.end()},request:async(u,i,l={})=>{const f=r.span("request").log("subject",u),{timeoutMs:m=o,headers:p}=l,y=c.serialize({data:i,meta:{headers:p}}),M=f.span("channel request").log("requestData",y),S=await e.request(u,y,{timeoutMs:m});return M.end(),f.end(),c.deserialize(S)},publish:async(u,i,l={})=>{const{headers:f}=l,m=c.serialize({data:i,meta:{headers:f}});return r.span("publish").log("subject",u),e.postOn(u,m)},subscribe:async(u,i,l={})=>(r.span("subscribe").log("subject",u),v({channel:e,serializer:c,subject:u,connectionListener:i,options:l}))}},k=({posterProducer:e,listenerProducer:t})=>{const s={postOn:(n,r,o={})=>{const{signal:a,reply:c}=o;e(a)(n)({subject:n,data:r,reply:c})},listenOn:function(n,r={}){const{signal:o,once:a,callback:c}=r,d=new AbortController;if(o?.aborted)throw new Error(`listenOn: Signal is already aborted for ${n}`);o?.addEventListener("abort",()=>{d.abort()});const u=t(d.signal)(n)(async i=>{if(i.subject===n){a&&d.abort();const l=await c?.(i.data,{finished:i.finished??!1});if(i.reply&&l&&(N(l)?(async()=>{for await(const f of l)e(d.signal)(i.reply)({subject:i.reply,data:f});e(d.signal)(i.reply)({subject:i.reply,data:void 0,finished:!0})})():e(d.signal)(i.reply)({subject:i.reply,data:l,finished:!0})),l&&!N(l))return{...i,data:l}}return i});return async function*(){for await(const i of u)yield i.data}()},request:async(n,r,o={})=>{const{signal:a,timeoutMs:c}=o,d=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((u,i)=>{a?.aborted&&i(new Error(`request: Signal is already aborted for ${n}`)),a?.addEventListener("abort",()=>{i(new Error("Request aborted"))});let l;c&&(l=setTimeout(()=>{i(new Error(`request: Request timed out after ${c}ms for ${n}`))},c)),s.listenOn(d,{callback:f=>{clearTimeout(l),u(f)},signal:a,once:!0}),s.postOn(n,r,{reply:d,signal:a})})},requestMany:async(n,r,o={})=>{const{signal:a,timeoutMs:c,callback:d}=o,u=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((i,l)=>{a?.aborted&&l(new Error(`requestMany: Signal is already aborted for ${n}`)),a?.addEventListener("abort",()=>{l(new Error("Request aborted"))});let f;c&&(f=setTimeout(()=>{l(new Error(`requestMany: Request timed out after ${c}ms for ${n}`))},c));const m=s.listenOn(u,{callback:(p,y)=>{if(p!==void 0&&d?.(p),y.finished)return clearTimeout(f),i(m)},signal:a});return s.postOn(n,r,{reply:u,signal:a}),m})}};return s};function N(e){return e!=null&&typeof e[Symbol.asyncIterator]=="function"}const ae=e=>k({posterProducer:t=>s=>n=>{t?.aborted||e.emit(s,n)},listenerProducer:t=>s=>n=>{const r=[],o={resolve:void 0},a=async c=>{if(t?.aborted)return;const d=await n?.(c),u=$(d)?d:c;r.push(u),o.resolve?.()};return t?.addEventListener("abort",()=>{e.off(s,a)}),e.on(s,a),{[Symbol.asyncIterator]:async function*(){for(;!t?.aborted;)r.length>0?yield r.shift():await new Promise(c=>{o.resolve=c})}}}});g.Channel=k,g.EmitterChannel=ae,g.MessageBus=re,g.isError=T,g.isErrorMsg=x,g.isMsg=D,g.isValue=q,g.isValueOrError=A,g.parseSubject=b,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
