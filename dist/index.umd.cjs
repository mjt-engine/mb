(function(N,ne){typeof exports=="object"&&typeof module<"u"?ne(exports):typeof define=="function"&&define.amd?define(["exports"],ne):(N=typeof globalThis<"u"?globalThis:N||self,ne(N.Module={}))})(this,function(N){"use strict";const ne=e=>{const t=e.split("."),r=t.shift(),n=t.join(".");return{root:r,segments:t,subpath:n}},Ne=e=>"value"in e&&e.value!==void 0,qe=e=>"error"in e&&e.error!==void 0,It=e=>Ne(e)||qe(e),$e=e=>{const t=e;return typeof t=="object"&&t!==null&&"data"in t},Fe=e=>{const t=e;return $e(e)&&t.meta?.hasError||!1},ze={"SHA-256":32,"SHA-512":64},be=["SHA-256","SHA-512"];function me(e){if(typeof e=="string")return e;const t=e();return typeof t=="string"?t:(console.error("ASSERTION FAIL VALUE",t),"Assertion Failed")}function ue(e,t="Assertion failed"){if(!e)throw new Error(me(t))}const Je=(e,t,r=()=>(console.error(e,t),`Assertion failed: ${JSON.stringify(e)} is not equal to ${JSON.stringify(t)}`))=>{throw new Error("assertEqualElements: Bitrotted")},Mt=(e,t,r=()=>(console.error(e,t),`Assertion failed: ${JSON.stringify(e)} is not equal to ${JSON.stringify(t)}`))=>Array.isArray(e)&&Array.isArray(t)?Je(e,t,r):ue(e===t,r),Pt=(e,t,r=()=>(console.error(e,t),`Assertion failed: ${JSON.stringify(e)} is equal to ${JSON.stringify(t)}`))=>ue(e!==t,r);function Rt(e,t,r="Assertion failed: Required value is not of correct type"){if(!t(e))throw new Error(me(r));return e}function _t(e,t="Assertion failed: Reached what should be an unreachable section of code"){throw new Error(me(t))}function Lt(e){return e!=null&&!Number.isNaN(e)}function jt(e,t="Assertion failed: Required value not defined"){return ue(Lt(e),t),e}const W={assert:ue,assertUnreachable:_t,assertValue:jt,assertEqual:Mt,assertNotEqual:Pt,assertEqualElements:Je,assertType:Rt},Ae=e=>{const t=e.flatMap(r=>typeof r=="number"?[r]:JSON.stringify(r).split("").map(n=>n.codePointAt(0)));return new Float64Array(t.length).map((r,n)=>t[n])},ee=async e=>e instanceof ArrayBuffer?e:e instanceof Blob?e.arrayBuffer():typeof e=="string"?new TextEncoder().encode(e):ArrayBuffer.isView(e)?e.buffer:Array.isArray(e)?Ae(e):new ArrayBuffer(0),le=async({bytes:e,algorithm:t="SHA-512"})=>{const r=await ee(e);return crypto.subtle.digest(t,r)},He=async(e,t=16)=>{const r=await ee(e);return[...new Uint8Array(r)].map(n=>n.toString(t).padStart(2,"0")).join("")},de=async({bytes:e,algorithm:t="SHA-512",radix:r=16})=>{const n=await le({bytes:e,algorithm:t}),s=await He(n,r);return`${t}:${s}`},Dt=({id:e})=>{const t=e.split(":");W.assert(t.length===2);const[r,n]=t,s=atob(n),c=new Uint8Array(s.length);return s.split("").map(u=>u.charCodeAt(0)).forEach((u,y)=>{c[y]=u}),c},ve=async e=>{if(typeof e=="string")return e;const t=await ee(e);return new TextDecoder().decode(t)},se=[];se.push(async()=>{const e="test",t=await ee(e),r=await ve(t);return W.assertEqual(e,r)}),se.push(async()=>be.map(async e=>{const t=await le({bytes:"test",algorithm:e});return W.assertEqual(t.byteLength,ze[e])})),se.push(async()=>{{const e=await de({bytes:"test",algorithm:"SHA-256"});W.assertEqual(e,"SHA-256:n4bQgYhMfWWaL+qgxVrQFaO/TxsrC4Is0V1sFbDwCgg=")}{const e=await de({bytes:"test",algorithm:"SHA-512"});W.assertEqual(e,"SHA-512:7iaw3Ur350mqGo7jwQrpkj9hiYB3Lkc/iBml1JQODbJ6wYX4oOHV+E+IvIh/1nsUNzLDBMxfqa2Ob1f1ACio/w==")}}),se.push(async()=>be.map(async e=>{const t="test",r=await de({bytes:t,algorithm:e}),n=new Uint8Array(await le({bytes:t,algorithm:e})),s=Dt({id:r});return W.assertEqualElements(s,n)}));const Vt=async()=>{if((await Promise.all(se.map(async t=>{try{return await t(),!0}catch(r){return console.error(r),!1}}))).find(t=>t===!1))throw new Error("TESTS FAILED");return console.log("TESTS PASS"),!0};function Be(e){const t=new Uint8Array(e.slice(0));let r="";for(let n=0;n<t.length;n++)r+=String.fromCharCode(t[n]);return btoa(r)}const Ct=e=>{const t=new Uint8Array(e),r=[];for(let n=0;n<t.length;++n)r.push(t[n].toString(16).padStart(2,"0"));return r.join("")},Nt=e=>new TextDecoder().decode(new Uint8Array(e)),qt=(e,t)=>e.slice(0,e.size,t),$t=e=>{const t=globalThis.atob(e),r=t.length,n=new Uint8Array(r);for(let s=0;s<r;s++)n[s]=t.charCodeAt(s);return n.buffer},Ft=e=>{if(!e)return;const t=e.split(","),n=(t[0].match(/:(.*?);/)??[])[1],s=atob(t[1]);let c=s.length;const u=new Uint8Array(c);for(;c--;)u[c]=s.charCodeAt(c);return new Blob([u],{type:n})},Ee=e=>e instanceof ArrayBuffer?e:typeof e=="string"?new TextEncoder().encode(e):ArrayBuffer.isView(e)?e.buffer:Array.isArray(e)?Ae(e):new ArrayBuffer(0),zt=async(e,t)=>{const r=Ee(e);return crypto.subtle.digest(t,r)},Ue=e=>{const t=e;return!!(t instanceof ArrayBuffer||typeof t=="string"||ArrayBuffer.isView(t)||Array.isArray(t))},Jt=e=>e instanceof Blob?!0:Ue(e),Ht=e=>{if(typeof e=="string")return e.length;if(e instanceof Blob)return e.size;if(e instanceof ArrayBuffer||ArrayBuffer.isView(e))return e.byteLength};var Te;try{Te=new TextDecoder}catch{}var x,z,i=0,I={},B,Y,F=0,J=0,j,v,q=[],A,Qe={useRecords:!1,mapsAsObjects:!0};class Ye{}const Ge=new Ye;Ge.name="MessagePack 0xC1";var G=!1,Ke=2,vt;try{new Function("")}catch{Ke=1/0}class ie{constructor(t){t&&(t.useRecords===!1&&t.mapsAsObjects===void 0&&(t.mapsAsObjects=!0),t.sequential&&t.trusted!==!1&&(t.trusted=!0,!t.structures&&t.useRecords!=!1&&(t.structures=[],t.maxSharedStructures||(t.maxSharedStructures=0))),t.structures?t.structures.sharedLength=t.structures.length:t.getStructures&&((t.structures=[]).uninitialized=!0,t.structures.sharedLength=0),t.int64AsNumber&&(t.int64AsType="number")),Object.assign(this,t)}unpack(t,r){if(x)return ct(()=>(Pe(),this?this.unpack(t,r):ie.prototype.unpack.call(Qe,t,r)));!t.buffer&&t.constructor===ArrayBuffer&&(t=typeof Buffer<"u"?Buffer.from(t):new Uint8Array(t)),typeof r=="object"?(z=r.end||t.length,i=r.start||0):(i=0,z=r>-1?r:t.length),J=0,Y=null,j=null,x=t;try{A=t.dataView||(t.dataView=new DataView(t.buffer,t.byteOffset,t.byteLength))}catch(n){throw x=null,t instanceof Uint8Array?n:new Error("Source must be a Uint8Array or Buffer but was a "+(t&&typeof t=="object"?t.constructor.name:typeof t))}if(this instanceof ie){if(I=this,this.structures)return B=this.structures,xe(r);(!B||B.length>0)&&(B=[])}else I=Qe,(!B||B.length>0)&&(B=[]);return xe(r)}unpackMultiple(t,r){let n,s=0;try{G=!0;let c=t.length,u=this?this.unpack(t,c):ge.unpack(t,c);if(r){if(r(u,s,i)===!1)return;for(;i<c;)if(s=i,r(xe(),s,i)===!1)return}else{for(n=[u];i<c;)s=i,n.push(xe());return n}}catch(c){throw c.lastPosition=s,c.values=n,c}finally{G=!1,Pe()}}_mergeStructures(t,r){t=t||[],Object.isFrozen(t)&&(t=t.map(n=>n.slice(0)));for(let n=0,s=t.length;n<s;n++){let c=t[n];c&&(c.isShared=!0,n>=32&&(c.highByte=n-32>>5))}t.sharedLength=t.length;for(let n in r||[])if(n>=0){let s=t[n],c=r[n];c&&(s&&((t.restoreStructures||(t.restoreStructures=[]))[n]=s),t[n]=c)}return this.structures=t}decode(t,r){return this.unpack(t,r)}}function xe(e){try{if(!I.trusted&&!G){let r=B.sharedLength||0;r<B.length&&(B.length=r)}let t;if(I.randomAccessStructure&&x[i]<64&&x[i]>=32&&vt||(t=_()),j&&(i=j.postBundlePosition,j=null),G&&(B.restoreStructures=null),i==z)B&&B.restoreStructures&&Ze(),B=null,x=null,v&&(v=null);else{if(i>z)throw new Error("Unexpected end of MessagePack data");if(!G){let r;try{r=JSON.stringify(t,(n,s)=>typeof s=="bigint"?`${s}n`:s).slice(0,100)}catch(n){r="(JSON view not available "+n+")"}throw new Error("Data read, but end of buffer not reached "+r)}}return t}catch(t){throw B&&B.restoreStructures&&Ze(),Pe(),(t instanceof RangeError||t.message.startsWith("Unexpected end of buffer")||i>z)&&(t.incomplete=!0),t}}function Ze(){for(let e in B.restoreStructures)B[e]=B.restoreStructures[e];B.restoreStructures=null}function _(){let e=x[i++];if(e<160)if(e<128){if(e<64)return e;{let t=B[e&63]||I.getStructures&&We()[e&63];return t?(t.read||(t.read=ke(t,e&63)),t.read()):e}}else if(e<144)if(e-=128,I.mapsAsObjects){let t={};for(let r=0;r<e;r++){let n=it();n==="__proto__"&&(n="__proto_"),t[n]=_()}return t}else{let t=new Map;for(let r=0;r<e;r++)t.set(_(),_());return t}else{e-=144;let t=new Array(e);for(let r=0;r<e;r++)t[r]=_();return I.freezeData?Object.freeze(t):t}else if(e<192){let t=e-160;if(J>=i)return Y.slice(i-F,(i+=t)-F);if(J==0&&z<140){let r=t<16?Ie(t):rt(t);if(r!=null)return r}return Oe(t)}else{let t;switch(e){case 192:return null;case 193:return j?(t=_(),t>0?j[1].slice(j.position1,j.position1+=t):j[0].slice(j.position0,j.position0-=t)):Ge;case 194:return!1;case 195:return!0;case 196:if(t=x[i++],t===void 0)throw new Error("Unexpected end of buffer");return Me(t);case 197:return t=A.getUint16(i),i+=2,Me(t);case 198:return t=A.getUint32(i),i+=4,Me(t);case 199:return X(x[i++]);case 200:return t=A.getUint16(i),i+=2,X(t);case 201:return t=A.getUint32(i),i+=4,X(t);case 202:if(t=A.getFloat32(i),I.useFloat32>2){let r=Re[(x[i]&127)<<1|x[i+1]>>7];return i+=4,(r*t+(t>0?.5:-.5)>>0)/r}return i+=4,t;case 203:return t=A.getFloat64(i),i+=8,t;case 204:return x[i++];case 205:return t=A.getUint16(i),i+=2,t;case 206:return t=A.getUint32(i),i+=4,t;case 207:return I.int64AsType==="number"?(t=A.getUint32(i)*4294967296,t+=A.getUint32(i+4)):I.int64AsType==="string"?t=A.getBigUint64(i).toString():I.int64AsType==="auto"?(t=A.getBigUint64(i),t<=BigInt(2)<<BigInt(52)&&(t=Number(t))):t=A.getBigUint64(i),i+=8,t;case 208:return A.getInt8(i++);case 209:return t=A.getInt16(i),i+=2,t;case 210:return t=A.getInt32(i),i+=4,t;case 211:return I.int64AsType==="number"?(t=A.getInt32(i)*4294967296,t+=A.getUint32(i+4)):I.int64AsType==="string"?t=A.getBigInt64(i).toString():I.int64AsType==="auto"?(t=A.getBigInt64(i),t>=BigInt(-2)<<BigInt(52)&&t<=BigInt(2)<<BigInt(52)&&(t=Number(t))):t=A.getBigInt64(i),i+=8,t;case 212:if(t=x[i++],t==114)return ot(x[i++]&63);{let r=q[t];if(r)return r.read?(i++,r.read(_())):r.noBuffer?(i++,r()):r(x.subarray(i,++i));throw new Error("Unknown extension "+t)}case 213:return t=x[i],t==114?(i++,ot(x[i++]&63,x[i++])):X(2);case 214:return X(4);case 215:return X(8);case 216:return X(16);case 217:return t=x[i++],J>=i?Y.slice(i-F,(i+=t)-F):Yt(t);case 218:return t=A.getUint16(i),i+=2,J>=i?Y.slice(i-F,(i+=t)-F):Gt(t);case 219:return t=A.getUint32(i),i+=4,J>=i?Y.slice(i-F,(i+=t)-F):Kt(t);case 220:return t=A.getUint16(i),i+=2,et(t);case 221:return t=A.getUint32(i),i+=4,et(t);case 222:return t=A.getUint16(i),i+=2,tt(t);case 223:return t=A.getUint32(i),i+=4,tt(t);default:if(e>=224)return e-256;if(e===void 0){let r=new Error("Unexpected end of MessagePack data");throw r.incomplete=!0,r}throw new Error("Unknown MessagePack token "+e)}}}const Qt=/^[a-zA-Z_$][a-zA-Z\d_$]*$/;function ke(e,t){function r(){if(r.count++>Ke){let s=e.read=new Function("r","return function(){return "+(I.freezeData?"Object.freeze":"")+"({"+e.map(c=>c==="__proto__"?"__proto_:r()":Qt.test(c)?c+":r()":"["+JSON.stringify(c)+"]:r()").join(",")+"})}")(_);return e.highByte===0&&(e.read=Xe(t,e.read)),s()}let n={};for(let s=0,c=e.length;s<c;s++){let u=e[s];u==="__proto__"&&(u="__proto_"),n[u]=_()}return I.freezeData?Object.freeze(n):n}return r.count=0,e.highByte===0?Xe(t,r):r}const Xe=(e,t)=>function(){let r=x[i++];if(r===0)return t();let n=e<32?-(e+(r<<5)):e+(r<<5),s=B[n]||We()[n];if(!s)throw new Error("Record id is not defined for "+n);return s.read||(s.read=ke(s,e)),s.read()};function We(){let e=ct(()=>(x=null,I.getStructures()));return B=I._mergeStructures(e,B)}var Oe=fe,Yt=fe,Gt=fe,Kt=fe;function fe(e){let t;if(e<16&&(t=Ie(e)))return t;if(e>64&&Te)return Te.decode(x.subarray(i,i+=e));const r=i+e,n=[];for(t="";i<r;){const s=x[i++];if((s&128)===0)n.push(s);else if((s&224)===192){const c=x[i++]&63;n.push((s&31)<<6|c)}else if((s&240)===224){const c=x[i++]&63,u=x[i++]&63;n.push((s&31)<<12|c<<6|u)}else if((s&248)===240){const c=x[i++]&63,u=x[i++]&63,y=x[i++]&63;let w=(s&7)<<18|c<<12|u<<6|y;w>65535&&(w-=65536,n.push(w>>>10&1023|55296),w=56320|w&1023),n.push(w)}else n.push(s);n.length>=4096&&(t+=D.apply(String,n),n.length=0)}return n.length>0&&(t+=D.apply(String,n)),t}function et(e){let t=new Array(e);for(let r=0;r<e;r++)t[r]=_();return I.freezeData?Object.freeze(t):t}function tt(e){if(I.mapsAsObjects){let t={};for(let r=0;r<e;r++){let n=it();n==="__proto__"&&(n="__proto_"),t[n]=_()}return t}else{let t=new Map;for(let r=0;r<e;r++)t.set(_(),_());return t}}var D=String.fromCharCode;function rt(e){let t=i,r=new Array(e);for(let n=0;n<e;n++){const s=x[i++];if((s&128)>0){i=t;return}r[n]=s}return D.apply(String,r)}function Ie(e){if(e<4)if(e<2){if(e===0)return"";{let t=x[i++];if((t&128)>1){i-=1;return}return D(t)}}else{let t=x[i++],r=x[i++];if((t&128)>0||(r&128)>0){i-=2;return}if(e<3)return D(t,r);let n=x[i++];if((n&128)>0){i-=3;return}return D(t,r,n)}else{let t=x[i++],r=x[i++],n=x[i++],s=x[i++];if((t&128)>0||(r&128)>0||(n&128)>0||(s&128)>0){i-=4;return}if(e<6){if(e===4)return D(t,r,n,s);{let c=x[i++];if((c&128)>0){i-=5;return}return D(t,r,n,s,c)}}else if(e<8){let c=x[i++],u=x[i++];if((c&128)>0||(u&128)>0){i-=6;return}if(e<7)return D(t,r,n,s,c,u);let y=x[i++];if((y&128)>0){i-=7;return}return D(t,r,n,s,c,u,y)}else{let c=x[i++],u=x[i++],y=x[i++],w=x[i++];if((c&128)>0||(u&128)>0||(y&128)>0||(w&128)>0){i-=8;return}if(e<10){if(e===8)return D(t,r,n,s,c,u,y,w);{let E=x[i++];if((E&128)>0){i-=9;return}return D(t,r,n,s,c,u,y,w,E)}}else if(e<12){let E=x[i++],S=x[i++];if((E&128)>0||(S&128)>0){i-=10;return}if(e<11)return D(t,r,n,s,c,u,y,w,E,S);let b=x[i++];if((b&128)>0){i-=11;return}return D(t,r,n,s,c,u,y,w,E,S,b)}else{let E=x[i++],S=x[i++],b=x[i++],M=x[i++];if((E&128)>0||(S&128)>0||(b&128)>0||(M&128)>0){i-=12;return}if(e<14){if(e===12)return D(t,r,n,s,c,u,y,w,E,S,b,M);{let L=x[i++];if((L&128)>0){i-=13;return}return D(t,r,n,s,c,u,y,w,E,S,b,M,L)}}else{let L=x[i++],$=x[i++];if((L&128)>0||($&128)>0){i-=14;return}if(e<15)return D(t,r,n,s,c,u,y,w,E,S,b,M,L,$);let V=x[i++];if((V&128)>0){i-=15;return}return D(t,r,n,s,c,u,y,w,E,S,b,M,L,$,V)}}}}}function nt(){let e=x[i++],t;if(e<192)t=e-160;else switch(e){case 217:t=x[i++];break;case 218:t=A.getUint16(i),i+=2;break;case 219:t=A.getUint32(i),i+=4;break;default:throw new Error("Expected string")}return fe(t)}function Me(e){return I.copyBuffers?Uint8Array.prototype.slice.call(x,i,i+=e):x.subarray(i,i+=e)}function X(e){let t=x[i++];if(q[t]){let r;return q[t](x.subarray(i,r=i+=e),n=>{i=n;try{return _()}finally{i=r}})}else throw new Error("Unknown extension type "+t)}var st=new Array(4096);function it(){let e=x[i++];if(e>=160&&e<192){if(e=e-160,J>=i)return Y.slice(i-F,(i+=e)-F);if(!(J==0&&z<180))return Oe(e)}else return i--,ft(_());let t=(e<<5^(e>1?A.getUint16(i):e>0?x[i]:0))&4095,r=st[t],n=i,s=i+e-3,c,u=0;if(r&&r.bytes==e){for(;n<s;){if(c=A.getUint32(n),c!=r[u++]){n=1879048192;break}n+=4}for(s+=3;n<s;)if(c=x[n++],c!=r[u++]){n=1879048192;break}if(n===s)return i=n,r.string;s-=3,n=i}for(r=[],st[t]=r,r.bytes=e;n<s;)c=A.getUint32(n),r.push(c),n+=4;for(s+=3;n<s;)c=x[n++],r.push(c);let y=e<16?Ie(e):rt(e);return y!=null?r.string=y:r.string=Oe(e)}function ft(e){if(typeof e=="string")return e;if(typeof e=="number"||typeof e=="boolean"||typeof e=="bigint")return e.toString();if(e==null)return e+"";throw new Error("Invalid property type for record",typeof e)}const ot=(e,t)=>{let r=_().map(ft),n=e;t!==void 0&&(e=e<32?-((t<<5)+e):(t<<5)+e,r.highByte=t);let s=B[e];return s&&(s.isShared||G)&&((B.restoreStructures||(B.restoreStructures=[]))[e]=s),B[e]=r,r.read=ke(r,n),r.read()};q[0]=()=>{},q[0].noBuffer=!0,q[66]=e=>{let t=e.length,r=BigInt(e[0]&128?e[0]-256:e[0]);for(let n=1;n<t;n++)r<<=BigInt(8),r+=BigInt(e[n]);return r};let Zt={Error,TypeError,ReferenceError};q[101]=()=>{let e=_();return(Zt[e[0]]||Error)(e[1],{cause:e[2]})},q[105]=e=>{if(I.structuredClone===!1)throw new Error("Structured clone extension is disabled");let t=A.getUint32(i-4);v||(v=new Map);let r=x[i],n;r>=144&&r<160||r==220||r==221?n=[]:n={};let s={target:n};v.set(t,s);let c=_();return s.used?Object.assign(n,c):(s.target=c,c)},q[112]=e=>{if(I.structuredClone===!1)throw new Error("Structured clone extension is disabled");let t=A.getUint32(i-4),r=v.get(t);return r.used=!0,r.target},q[115]=()=>new Set(_());const at=["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].map(e=>e+"Array");let Xt=typeof globalThis=="object"?globalThis:window;q[116]=e=>{let t=e[0],r=at[t];if(!r){if(t===16){let n=new ArrayBuffer(e.length-1);return new Uint8Array(n).set(e.subarray(1)),n}throw new Error("Could not find typed array for code "+t)}return new Xt[r](Uint8Array.prototype.slice.call(e,1).buffer)},q[120]=()=>{let e=_();return new RegExp(e[0],e[1])};const Wt=[];q[98]=e=>{let t=(e[0]<<24)+(e[1]<<16)+(e[2]<<8)+e[3],r=i;return i+=t-e.length,j=Wt,j=[nt(),nt()],j.position0=0,j.position1=0,j.postBundlePosition=i,i=r,_()},q[255]=e=>e.length==4?new Date((e[0]*16777216+(e[1]<<16)+(e[2]<<8)+e[3])*1e3):e.length==8?new Date(((e[0]<<22)+(e[1]<<14)+(e[2]<<6)+(e[3]>>2))/1e6+((e[3]&3)*4294967296+e[4]*16777216+(e[5]<<16)+(e[6]<<8)+e[7])*1e3):e.length==12?new Date(((e[0]<<24)+(e[1]<<16)+(e[2]<<8)+e[3])/1e6+((e[4]&128?-281474976710656:0)+e[6]*1099511627776+e[7]*4294967296+e[8]*16777216+(e[9]<<16)+(e[10]<<8)+e[11])*1e3):new Date("invalid");function ct(e){let t=z,r=i,n=F,s=J,c=Y,u=v,y=j,w=new Uint8Array(x.slice(0,z)),E=B,S=B.slice(0,B.length),b=I,M=G,L=e();return z=t,i=r,F=n,J=s,Y=c,v=u,j=y,x=w,G=M,B=E,B.splice(0,B.length,...S),I=b,A=new DataView(x.buffer,x.byteOffset,x.byteLength),L}function Pe(){x=null,v=null,B=null}const Re=new Array(147);for(let e=0;e<256;e++)Re[e]=+("1e"+Math.floor(45.15-e*.30103));var ge=new ie({useRecords:!1});ge.unpack,ge.unpackMultiple,ge.unpack;let er=new Float32Array(1);new Uint8Array(er.buffer,0,4);let he;try{he=new TextEncoder}catch{}let _e,ut;const ye=typeof Buffer<"u",we=ye?function(e){return Buffer.allocUnsafeSlow(e)}:Uint8Array,lt=ye?Buffer:Uint8Array,dt=ye?4294967296:2144337920;let o,oe,O,f=0,C,P=null,tr;const rr=21760,nr=/[\u0080-\uFFFF]/,te=Symbol("record-id");class Le extends ie{constructor(t){super(t),this.offset=0;let r,n,s,c,u=lt.prototype.utf8Write?function(a,h){return o.utf8Write(a,h,o.byteLength-h)}:he&&he.encodeInto?function(a,h){return he.encodeInto(a,o.subarray(h)).written}:!1,y=this;t||(t={});let w=t&&t.sequential,E=t.structures||t.saveStructures,S=t.maxSharedStructures;if(S==null&&(S=E?32:0),S>8160)throw new Error("Maximum maxSharedStructure is 8160");t.structuredClone&&t.moreTypes==null&&(this.moreTypes=!0);let b=t.maxOwnStructures;b==null&&(b=E?32:64),!this.structures&&t.useRecords!=!1&&(this.structures=[]);let M=S>32||b+S>64,L=S+64,$=S+b+64;if($>8256)throw new Error("Maximum maxSharedStructure + maxOwnStructure is 8192");let V=[],ae=0,re=0;this.pack=this.encode=function(a,h){if(o||(o=new we(8192),O=o.dataView||(o.dataView=new DataView(o.buffer,0,8192)),f=0),C=o.length-10,C-f<2048?(o=new we(o.length),O=o.dataView||(o.dataView=new DataView(o.buffer,0,o.length)),C=o.length-10,f=0):f=f+7&2147483640,r=f,h&cr&&(f+=h&255),c=y.structuredClone?new Map:null,y.bundleStrings&&typeof a!="string"?(P=[],P.size=1/0):P=null,s=y.structures,s){s.uninitialized&&(s=y._mergeStructures(y.getStructures()));let l=s.sharedLength||0;if(l>S)throw new Error("Shared structures is larger than maximum shared structures, try increasing maxSharedStructures to "+s.sharedLength);if(!s.transitions){s.transitions=Object.create(null);for(let g=0;g<l;g++){let p=s[g];if(!p)continue;let U,m=s.transitions;for(let T=0,k=p.length;T<k;T++){let H=p[T];U=m[H],U||(U=m[H]=Object.create(null)),m=U}m[te]=g+64}this.lastNamedStructuresLength=l}w||(s.nextId=l+64)}n&&(n=!1);let d;try{y.randomAccessStructure&&a&&a.constructor&&a.constructor===Object?Br(a):R(a);let l=P;if(P&&ht(r,R,0),c&&c.idsToInsert){let g=c.idsToInsert.sort((T,k)=>T.offset>k.offset?1:-1),p=g.length,U=-1;for(;l&&p>0;){let T=g[--p].offset+r;T<l.stringsPosition+r&&U===-1&&(U=0),T>l.position+r?U>=0&&(U+=6):(U>=0&&(O.setUint32(l.position+r,O.getUint32(l.position+r)+U),U=-1),l=l.previous,p++)}U>=0&&l&&O.setUint32(l.position+r,O.getUint32(l.position+r)+U),f+=g.length*6,f>C&&K(f),y.offset=f;let m=ir(o.subarray(r,f),g);return c=null,m}return y.offset=f,h&or?(o.start=r,o.end=f,o):o.subarray(r,f)}catch(l){throw d=l,l}finally{if(s&&(pe(),n&&y.saveStructures)){let l=s.sharedLength||0,g=o.subarray(r,f),p=fr(s,y);if(!d)return y.saveStructures(p,p.isCompatible)===!1?y.pack(a,h):(y.lastNamedStructuresLength=l,o.length>1073741824&&(o=null),g)}o.length>1073741824&&(o=null),h&ar&&(f=r)}};const pe=()=>{re<10&&re++;let a=s.sharedLength||0;if(s.length>a&&!w&&(s.length=a),ae>1e4)s.transitions=null,re=0,ae=0,V.length>0&&(V=[]);else if(V.length>0&&!w){for(let h=0,d=V.length;h<d;h++)V[h][te]=0;V=[]}},Ve=a=>{var h=a.length;h<16?o[f++]=144|h:h<65536?(o[f++]=220,o[f++]=h>>8,o[f++]=h&255):(o[f++]=221,O.setUint32(f,h),f+=4);for(let d=0;d<h;d++)R(a[d])},R=a=>{f>C&&(o=K(f));var h=typeof a,d;if(h==="string"){let l=a.length;if(P&&l>=4&&l<4096){if((P.size+=l)>rr){let m,T=(P[0]?P[0].length*3+P[1].length:0)+10;f+T>C&&(o=K(f+T));let k;P.position?(k=P,o[f]=200,f+=3,o[f++]=98,m=f-r,f+=4,ht(r,R,0),O.setUint16(m+r-3,f-r-m)):(o[f++]=214,o[f++]=98,m=f-r,f+=4),P=["",""],P.previous=k,P.size=0,P.position=m}let U=nr.test(a);P[U?0:1]+=a,o[f++]=193,R(U?-l:l);return}let g;l<32?g=1:l<256?g=2:l<65536?g=3:g=5;let p=l*3;if(f+p>C&&(o=K(f+p)),l<64||!u){let U,m,T,k=f+g;for(U=0;U<l;U++)m=a.charCodeAt(U),m<128?o[k++]=m:m<2048?(o[k++]=m>>6|192,o[k++]=m&63|128):(m&64512)===55296&&((T=a.charCodeAt(U+1))&64512)===56320?(m=65536+((m&1023)<<10)+(T&1023),U++,o[k++]=m>>18|240,o[k++]=m>>12&63|128,o[k++]=m>>6&63|128,o[k++]=m&63|128):(o[k++]=m>>12|224,o[k++]=m>>6&63|128,o[k++]=m&63|128);d=k-f-g}else d=u(a,f+g);d<32?o[f++]=160|d:d<256?(g<2&&o.copyWithin(f+2,f+1,f+1+d),o[f++]=217,o[f++]=d):d<65536?(g<3&&o.copyWithin(f+3,f+2,f+2+d),o[f++]=218,o[f++]=d>>8,o[f++]=d&255):(g<5&&o.copyWithin(f+5,f+3,f+3+d),o[f++]=219,O.setUint32(f,d),f+=4),f+=d}else if(h==="number")if(a>>>0===a)a<32||a<128&&this.useRecords===!1||a<64&&!this.randomAccessStructure?o[f++]=a:a<256?(o[f++]=204,o[f++]=a):a<65536?(o[f++]=205,o[f++]=a>>8,o[f++]=a&255):(o[f++]=206,O.setUint32(f,a),f+=4);else if(a>>0===a)a>=-32?o[f++]=256+a:a>=-128?(o[f++]=208,o[f++]=a+256):a>=-32768?(o[f++]=209,O.setInt16(f,a),f+=2):(o[f++]=210,O.setInt32(f,a),f+=4);else{let l;if((l=this.useFloat32)>0&&a<4294967296&&a>=-2147483648){o[f++]=202,O.setFloat32(f,a);let g;if(l<4||(g=a*Re[(o[f]&127)<<1|o[f+1]>>7])>>0===g){f+=4;return}else f--}o[f++]=203,O.setFloat64(f,a),f+=8}else if(h==="object"||h==="function")if(!a)o[f++]=192;else{if(c){let g=c.get(a);if(g){if(!g.id){let p=c.idsToInsert||(c.idsToInsert=[]);g.id=p.push(g)}o[f++]=214,o[f++]=112,O.setUint32(f,g.id),f+=4;return}else c.set(a,{offset:f-r})}let l=a.constructor;if(l===Object)Se(a);else if(l===Array)Ve(a);else if(l===Map)if(this.mapAsEmptyObject)o[f++]=128;else{d=a.size,d<16?o[f++]=128|d:d<65536?(o[f++]=222,o[f++]=d>>8,o[f++]=d&255):(o[f++]=223,O.setUint32(f,d),f+=4);for(let[g,p]of a)R(g),R(p)}else{for(let g=0,p=_e.length;g<p;g++){let U=ut[g];if(a instanceof U){let m=_e[g];if(m.write){m.type&&(o[f++]=212,o[f++]=m.type,o[f++]=0);let ce=m.write.call(this,a);ce===a?Array.isArray(a)?Ve(a):Se(a):R(ce);return}let T=o,k=O,H=f;o=null;let Z;try{Z=m.pack.call(this,a,ce=>(o=T,T=null,f+=ce,f>C&&K(f),{target:o,targetView:O,position:f-ce}),R)}finally{T&&(o=T,O=k,f=H,C=o.length-10)}Z&&(Z.length+f>C&&K(Z.length+f),f=sr(Z,o,f,m.type));return}}if(Array.isArray(a))Ve(a);else{if(a.toJSON){const g=a.toJSON();if(g!==a)return R(g)}if(h==="function")return R(this.writeFunction&&this.writeFunction(a));Se(a)}}}else if(h==="boolean")o[f++]=a?195:194;else if(h==="bigint"){if(a<BigInt(1)<<BigInt(63)&&a>=-(BigInt(1)<<BigInt(63)))o[f++]=211,O.setBigInt64(f,a);else if(a<BigInt(1)<<BigInt(64)&&a>0)o[f++]=207,O.setBigUint64(f,a);else if(this.largeBigIntToFloat)o[f++]=203,O.setFloat64(f,Number(a));else{if(this.largeBigIntToString)return R(a.toString());if(this.useBigIntExtension&&a<BigInt(2)**BigInt(1023)&&a>-(BigInt(2)**BigInt(1023))){o[f++]=199,f++,o[f++]=66;let l=[],g;do{let p=a&BigInt(255);g=(p&BigInt(128))===(a<BigInt(0)?BigInt(128):BigInt(0)),l.push(p),a>>=BigInt(8)}while(!((a===BigInt(0)||a===BigInt(-1))&&g));o[f-2]=l.length;for(let p=l.length;p>0;)o[f++]=Number(l[--p]);return}else throw new RangeError(a+" was too large to fit in MessagePack 64-bit integer format, use useBigIntExtension, or set largeBigIntToFloat to convert to float-64, or set largeBigIntToString to convert to string")}f+=8}else if(h==="undefined")this.encodeUndefinedAsNil?o[f++]=192:(o[f++]=212,o[f++]=0,o[f++]=0);else throw new Error("Unknown type: "+h)},Ut=this.variableMapSize||this.coercibleKeyAsNumber||this.skipValues?a=>{let h;if(this.skipValues){h=[];for(let g in a)(typeof a.hasOwnProperty!="function"||a.hasOwnProperty(g))&&!this.skipValues.includes(a[g])&&h.push(g)}else h=Object.keys(a);let d=h.length;d<16?o[f++]=128|d:d<65536?(o[f++]=222,o[f++]=d>>8,o[f++]=d&255):(o[f++]=223,O.setUint32(f,d),f+=4);let l;if(this.coercibleKeyAsNumber)for(let g=0;g<d;g++){l=h[g];let p=Number(l);R(isNaN(p)?l:p),R(a[l])}else for(let g=0;g<d;g++)R(l=h[g]),R(a[l])}:a=>{o[f++]=222;let h=f-r;f+=2;let d=0;for(let l in a)(typeof a.hasOwnProperty!="function"||a.hasOwnProperty(l))&&(R(l),R(a[l]),d++);if(d>65535)throw new Error('Object is too large to serialize with fast 16-bit map size, use the "variableMapSize" option to serialize this object');o[h+++r]=d>>8,o[h+r]=d&255},Tt=this.useRecords===!1?Ut:t.progressiveRecords&&!M?a=>{let h,d=s.transitions||(s.transitions=Object.create(null)),l=f++-r,g;for(let p in a)if(typeof a.hasOwnProperty!="function"||a.hasOwnProperty(p)){if(h=d[p],h)d=h;else{let U=Object.keys(a),m=d;d=s.transitions;let T=0;for(let k=0,H=U.length;k<H;k++){let Z=U[k];h=d[Z],h||(h=d[Z]=Object.create(null),T++),d=h}l+r+1==f?(f--,Ce(d,U,T)):Ot(d,U,l,T),g=!0,d=m[p]}R(a[p])}if(!g){let p=d[te];p?o[l+r]=p:Ot(d,Object.keys(a),l,0)}}:a=>{let h,d=s.transitions||(s.transitions=Object.create(null)),l=0;for(let p in a)(typeof a.hasOwnProperty!="function"||a.hasOwnProperty(p))&&(h=d[p],h||(h=d[p]=Object.create(null),l++),d=h);let g=d[te];g?g>=96&&M?(o[f++]=((g-=96)&31)+96,o[f++]=g>>5):o[f++]=g:Ce(d,d.__keys__||Object.keys(a),l);for(let p in a)(typeof a.hasOwnProperty!="function"||a.hasOwnProperty(p))&&R(a[p])},kt=typeof this.useRecords=="function"&&this.useRecords,Se=kt?a=>{kt(a)?Tt(a):Ut(a)}:Tt,K=a=>{let h;if(a>16777216){if(a-r>dt)throw new Error("Packed buffer would be larger than maximum buffer size");h=Math.min(dt,Math.round(Math.max((a-r)*(a>67108864?1.25:2),4194304)/4096)*4096)}else h=(Math.max(a-r<<2,o.length-1)>>12)+1<<12;let d=new we(h);return O=d.dataView||(d.dataView=new DataView(d.buffer,0,h)),a=Math.min(a,o.length),o.copy?o.copy(d,0,r,a):d.set(o.slice(r,a)),f-=r,r=0,C=d.length-10,o=d},Ce=(a,h,d)=>{let l=s.nextId;l||(l=64),l<L&&this.shouldShareStructure&&!this.shouldShareStructure(h)?(l=s.nextOwnId,l<$||(l=L),s.nextOwnId=l+1):(l>=$&&(l=L),s.nextId=l+1);let g=h.highByte=l>=96&&M?l-96>>5:-1;a[te]=l,a.__keys__=h,s[l-64]=h,l<L?(h.isShared=!0,s.sharedLength=l-63,n=!0,g>=0?(o[f++]=(l&31)+96,o[f++]=g):o[f++]=l):(g>=0?(o[f++]=213,o[f++]=114,o[f++]=(l&31)+96,o[f++]=g):(o[f++]=212,o[f++]=114,o[f++]=l),d&&(ae+=re*d),V.length>=b&&(V.shift()[te]=0),V.push(a),R(h))},Ot=(a,h,d,l)=>{let g=o,p=f,U=C,m=r;o=oe,f=0,r=0,o||(oe=o=new we(8192)),C=o.length-10,Ce(a,h,l),oe=o;let T=f;if(o=g,f=p,C=U,r=m,T>1){let k=f+T-1;k>C&&K(k);let H=d+r;o.copyWithin(H+T,H+1,f),o.set(oe.slice(0,T),H),f=k}else o[d+r]=oe[0]},Br=a=>{let h=tr(a,o,r,f,s,K,(d,l,g)=>{if(g)return n=!0;f=l;let p=o;return R(d),pe(),p!==o?{position:f,targetView:O,target:o}:f},this);if(h===0)return Se(a);f=h}}useBuffer(t){o=t,o.dataView||(o.dataView=new DataView(o.buffer,o.byteOffset,o.byteLength)),f=0}set position(t){f=t}get position(){return f}clearSharedData(){this.structures&&(this.structures=[]),this.typedStructs&&(this.typedStructs=[])}}ut=[Date,Set,Error,RegExp,ArrayBuffer,Object.getPrototypeOf(Uint8Array.prototype).constructor,Ye],_e=[{pack(e,t,r){let n=e.getTime()/1e3;if((this.useTimestamp32||e.getMilliseconds()===0)&&n>=0&&n<4294967296){let{target:s,targetView:c,position:u}=t(6);s[u++]=214,s[u++]=255,c.setUint32(u,n)}else if(n>0&&n<4294967296){let{target:s,targetView:c,position:u}=t(10);s[u++]=215,s[u++]=255,c.setUint32(u,e.getMilliseconds()*4e6+(n/1e3/4294967296>>0)),c.setUint32(u+4,n)}else if(isNaN(n)){if(this.onInvalidDate)return t(0),r(this.onInvalidDate());let{target:s,targetView:c,position:u}=t(3);s[u++]=212,s[u++]=255,s[u++]=255}else{let{target:s,targetView:c,position:u}=t(15);s[u++]=199,s[u++]=12,s[u++]=255,c.setUint32(u,e.getMilliseconds()*1e6),c.setBigInt64(u+4,BigInt(Math.floor(n)))}}},{pack(e,t,r){if(this.setAsEmptyObject)return t(0),r({});let n=Array.from(e),{target:s,position:c}=t(this.moreTypes?3:0);this.moreTypes&&(s[c++]=212,s[c++]=115,s[c++]=0),r(n)}},{pack(e,t,r){let{target:n,position:s}=t(this.moreTypes?3:0);this.moreTypes&&(n[s++]=212,n[s++]=101,n[s++]=0),r([e.name,e.message,e.cause])}},{pack(e,t,r){let{target:n,position:s}=t(this.moreTypes?3:0);this.moreTypes&&(n[s++]=212,n[s++]=120,n[s++]=0),r([e.source,e.flags])}},{pack(e,t){this.moreTypes?xt(e,16,t):gt(ye?Buffer.from(e):new Uint8Array(e),t)}},{pack(e,t){let r=e.constructor;r!==lt&&this.moreTypes?xt(e,at.indexOf(r.name),t):gt(e,t)}},{pack(e,t){let{target:r,position:n}=t(1);r[n]=193}}];function xt(e,t,r,n){let s=e.byteLength;if(s+1<256){var{target:c,position:u}=r(4+s);c[u++]=199,c[u++]=s+1}else if(s+1<65536){var{target:c,position:u}=r(5+s);c[u++]=200,c[u++]=s+1>>8,c[u++]=s+1&255}else{var{target:c,position:u,targetView:y}=r(7+s);c[u++]=201,y.setUint32(u,s+1),u+=4}c[u++]=116,c[u++]=t,e.buffer||(e=new Uint8Array(e)),c.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),u)}function gt(e,t){let r=e.byteLength;var n,s;if(r<256){var{target:n,position:s}=t(r+2);n[s++]=196,n[s++]=r}else if(r<65536){var{target:n,position:s}=t(r+3);n[s++]=197,n[s++]=r>>8,n[s++]=r&255}else{var{target:n,position:s,targetView:c}=t(r+5);n[s++]=198,c.setUint32(s,r),s+=4}n.set(e,s)}function sr(e,t,r,n){let s=e.length;switch(s){case 1:t[r++]=212;break;case 2:t[r++]=213;break;case 4:t[r++]=214;break;case 8:t[r++]=215;break;case 16:t[r++]=216;break;default:s<256?(t[r++]=199,t[r++]=s):s<65536?(t[r++]=200,t[r++]=s>>8,t[r++]=s&255):(t[r++]=201,t[r++]=s>>24,t[r++]=s>>16&255,t[r++]=s>>8&255,t[r++]=s&255)}return t[r++]=n,t.set(e,r),r+=s,r}function ir(e,t){let r,n=t.length*6,s=e.length-n;for(;r=t.pop();){let c=r.offset,u=r.id;e.copyWithin(c+n,c,s),n-=6;let y=c+n;e[y++]=214,e[y++]=105,e[y++]=u>>24,e[y++]=u>>16&255,e[y++]=u>>8&255,e[y++]=u&255,s=c}return e}function ht(e,t,r){if(P.length>0){O.setUint32(P.position+e,f+r-P.position-e),P.stringsPosition=f-e;let n=P;P=null,t(n[0]),t(n[1])}}function fr(e,t){return e.isCompatible=r=>{let n=!r||(t.lastNamedStructuresLength||0)===r.length;return n||t._mergeStructures(r),n},e}let yt=new Le({useRecords:!1});yt.pack,yt.pack;const or=512,ar=1024,cr=2048,ur=e=>new Le({structuredClone:!0}).unpack(new Uint8Array(e));function lr(e){return Ue(e)?xr(e):dr(e)}async function dr(e){const t=await ee(e);return Be(t)}function xr(e){const t=Ee(e);return Be(t)}const wt=(e,t="application/octet-stream")=>e instanceof Blob?e:e instanceof ArrayBuffer?new Blob([e],{type:t}):typeof e=="string"?new Blob([e],{type:t}):ArrayBuffer.isView(e)?new Blob([e],{type:t}):Array.isArray(e)?new Blob([Ae(e)],{type:t}):new Blob([]),Q={toMsgPack:e=>{const t=new Le({structuredClone:!0});return new Uint8Array(t.encode(e))},msgPackToObject:ur,typeOfBytes:e=>{if(e instanceof Blob)return"Blob";if(e instanceof ArrayBuffer)return"ArrayBuffer";if(typeof e=="string")return"string";if(ArrayBuffer.isView(e))return"ArrayBufferView";if(Array.isArray(e))return"Array"},toDataUrl:async e=>{const t=wt(e),r=new FileReader;return new Promise((n,s)=>{const c=u=>typeof u=="string"?n(u):(console.log({bytes:e}),s("Unable to convert to data URL"));r.onload=function(u){c(u.target?.result)},r.readAsDataURL(t)})},dataUrlToBlob:Ft,lengthOf:Ht,isByteLike:Jt,isImmediateByteLike:Ue,hashOf:le,immediateHashOf:zt,addressStringOf:de,toArrayBuffer:ee,immediateToArrayBuffer:Ee,toBlob:wt,toText:ve,toBase64:lr,encodeAsString:He,test:Vt,assignMediaTypeToBlob:qt,utf8ToUint8Array:e=>new TextEncoder().encode(e),base64ToArrayBuffer:$t,arrayBufferToHex:Ct,arrayBufferToUtf8:Nt,arrayBufferToBase64:Be,ALL_ALGORITHMS:be,ALGORITHM_BYTE_LENGTHS:ze},gr=e=>typeof e=="function",pt=e=>e==null||Number.isNaN(e),St=e=>!pt(e),hr=e=>gr(e)?e():e,yr={isDefined:St,isUndefined:pt,safe:(e,t={})=>{const{quiet:r=!1,def:n=void 0,onError:s}=t;try{return e()}catch(c){return r||(console.error(c),St(s)&&console.log(hr(s))),n}}},{isDefined:je,isUndefined:wr,safe:bt}=yr,De=e=>{const{message:t,stack:r,extra:n,cause:s}=e,c=s?`
Caused by: ${De(s)}`:"",u=n?`
Extra: ${JSON.stringify(n,void 0,2)}`:"";return[t,r].filter(je).join(`
`)+u+c},mt=e=>typeof e=="string"?e:e instanceof Response?`${e.url} ${e.status} ${e.statusText}`:typeof e=="object"&&e!==null&&"message"in e?De(e):bt(()=>JSON.stringify(e,void 0,2))??"",pr=async e=>{if(typeof e=="string")return e;if(e instanceof Response){const t=await e.text();return`${e.url} ${e.status} ${e.statusText} ${t}`}return typeof e=="object"&&e!==null&&"message"in e?De(e):bt(()=>JSON.stringify(e,void 0,2))??""},At=({error:e,extra:t,stack:r})=>{if(e instanceof Error){const n=je(e.cause)?At({error:e.cause}):void 0;return{message:e.message,stack:e.stack??r,extra:t,cause:n}}return{message:mt(e),stack:r,extra:t}},Sr={errorToErrorDetail:At,errorToText:mt,errorToTextAsync:pr},br=async({channel:e,subject:t,connectionListener:r,options:n={},signal:s})=>{const{log:c=()=>{}}=n;c("connectConnectionListenerToSubject: subject: ",t);for await(const u of e.listenOn(t,{callback:async y=>{const w=Q.msgPackToObject(y),{data:E,meta:S}=w;if(Fe(w))throw console.error("Error in message: ",w),new Error(`connectConnectionListenerToSubject: Unexpected error in request message: ${w?.data?.message}`);try{const b=await r(E,{headers:S?.headers,signal:s});return Q.toMsgPack({data:b})}catch(b){const M=Sr.errorToErrorDetail({error:b});return Q.toMsgPack({data:M,meta:{hasError:!0,code:500,status:M.message}})}}}));},mr=async({channel:e,subscribers:t={},options:r={},signal:n})=>{const{log:s=()=>{},defaultTimeoutMs:c=60*1e3}=r,u=Object.entries(t);s("connect: subscribers: ",u);for(const[y,w]of u)wr(w)||br({channel:e,subject:y,connectionListener:w,options:r,signal:n});return{requestMany:async y=>{const{request:w,subject:E,headers:S,options:b={},onResponse:M,signal:L}=y,$=Q.toMsgPack({data:w,meta:{headers:S}}),{timeoutMs:V=60*1e3}=b,ae=await e.requestMany(E,$,{timeoutMs:V});for await(const re of ae){if(L?.aborted)return;const pe=Q.msgPackToObject(re);await M(pe)}},request:async y=>{const{request:w,subject:E,headers:S,options:b={}}=y,{timeoutMs:M=c}=b,L=Q.toMsgPack({data:w,meta:{headers:S}}),$=await e.request(E,L,{timeoutMs:M});return Q.msgPackToObject($)},publish:async y=>{const{payload:w,subject:E,headers:S}=y;Q.toMsgPack({value:w});const b=Q.toMsgPack({data:w,meta:{headers:S}});return e.postOn(E,b)}}},Bt=({posterProducer:e,listenerProducer:t})=>{const r={postOn:(n,s,c={})=>{const{signal:u,reply:y}=c;e(u)({subject:n,data:s,reply:y})},listenOn:function(n,s={}){const{signal:c,once:u,callback:y}=s,w=new AbortController;c?.addEventListener("abort",()=>{w.abort()});const E=t(w.signal)(async S=>{if(typeof n=="string"?S.subject===n:n.test(S.subject)){const b=await y?.(S.data,{finished:S.finished??!1});if(S.reply&&b&&(Et(b)?(async()=>{for await(const M of b)e(w.signal)({subject:S.reply,data:M});e(w.signal)({subject:S.reply,data:void 0,finished:!0})})():e(w.signal)({subject:S.reply,data:b,finished:!0}),u&&w.abort()),b&&!Et(b))return{...S,data:b}}return S});return async function*(){for await(const S of E)yield S.data}()},request:async(n,s,c={})=>{const{signal:u,timeoutMs:y}=c,w=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((E,S)=>{u?.addEventListener("abort",()=>{S(new Error("Request aborted"))});let b;y&&(b=setTimeout(()=>{S(new Error("Request timed out"))},y)),r.listenOn(w,{callback:M=>{clearTimeout(b),E(M)},signal:u,once:!0}),r.postOn(n,s,{reply:w,signal:u})})},requestMany:async(n,s,c={})=>{const{signal:u,timeoutMs:y,callback:w}=c,E=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((S,b)=>{u?.addEventListener("abort",()=>{b(new Error("Request aborted"))});let M;y&&(M=setTimeout(()=>{b(new Error("Request timed out"))},y));const L=r.listenOn(E,{callback:($,V)=>{if($!==void 0&&w?.($),V.finished)return clearTimeout(M),S(L)},signal:u});return r.postOn(n,s,{reply:E,signal:u}),L})}};return r};function Et(e){return e!=null&&typeof e[Symbol.asyncIterator]=="function"}const Ar=(e,t="channel_message")=>Bt({posterProducer:r=>n=>{r?.aborted||e.emit(t,n)},listenerProducer:r=>n=>{const s=[],c={resolve:void 0},u=async y=>{if(r?.aborted)return;const w=await n?.(y),E=je(w)?w:y;s.push(E),c.resolve?.()};return r?.addEventListener("abort",()=>{e.off(t,u)}),e.on(t,u),{[Symbol.asyncIterator]:async function*(){for(;!r?.aborted;)s.length>0?yield s.shift():await new Promise(y=>{c.resolve=y})}}}});N.Channel=Bt,N.EmitterChannel=Ar,N.MessageBus=mr,N.isError=qe,N.isErrorMsg=Fe,N.isMsg=$e,N.isValue=Ne,N.isValueOrError=It,N.parseSubject=ne,Object.defineProperty(N,Symbol.toStringTag,{value:"Module"})});
