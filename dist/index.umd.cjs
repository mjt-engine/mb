(function($,se){typeof exports=="object"&&typeof module<"u"?se(exports):typeof define=="function"&&define.amd?define(["exports"],se):($=typeof globalThis<"u"?globalThis:$||self,se($.Module={}))})(this,function($){"use strict";const se=e=>{const t=e.split("."),r=t.shift(),n=t.join(".");return{root:r,segments:t,subpath:n}},je=e=>"value"in e&&e.value!==void 0,ze=e=>"error"in e&&e.error!==void 0,Dt=e=>je(e)||ze(e),Fe=e=>{const t=e;return typeof t=="object"&&t!==null&&"data"in t},Je=e=>{const t=e;return Fe(e)&&t.meta?.hasError||!1},He={"SHA-256":32,"SHA-512":64},Be=["SHA-256","SHA-512"];function Ee(e){if(typeof e=="string")return e;const t=e();return typeof t=="string"?t:(console.error("ASSERTION FAIL VALUE",t),"Assertion Failed")}function le(e,t="Assertion failed"){if(!e)throw new Error(Ee(t))}const ve=(e,t,r=()=>(console.error(e,t),`Assertion failed: ${JSON.stringify(e)} is not equal to ${JSON.stringify(t)}`))=>{throw new Error("assertEqualElements: Bitrotted")},qt=(e,t,r=()=>(console.error(e,t),`Assertion failed: ${JSON.stringify(e)} is not equal to ${JSON.stringify(t)}`))=>Array.isArray(e)&&Array.isArray(t)?ve(e,t,r):le(e===t,r),Ct=(e,t,r=()=>(console.error(e,t),`Assertion failed: ${JSON.stringify(e)} is equal to ${JSON.stringify(t)}`))=>le(e!==t,r);function Nt(e,t,r="Assertion failed: Required value is not of correct type"){if(!t(e))throw new Error(Ee(r));return e}function Vt(e,t="Assertion failed: Reached what should be an unreachable section of code"){throw new Error(Ee(t))}function $t(e){return e!=null&&!Number.isNaN(e)}function jt(e,t="Assertion failed: Required value not defined"){return le($t(e),t),e}const ee={assert:le,assertUnreachable:Vt,assertValue:jt,assertEqual:qt,assertNotEqual:Ct,assertEqualElements:ve,assertType:Nt},Ue=e=>{const t=e.flatMap(r=>typeof r=="number"?[r]:JSON.stringify(r).split("").map(n=>n.codePointAt(0)));return new Float64Array(t.length).map((r,n)=>t[n])},te=async e=>e instanceof ArrayBuffer?e:e instanceof Blob?e.arrayBuffer():typeof e=="string"?new TextEncoder().encode(e):ArrayBuffer.isView(e)?e.buffer:Array.isArray(e)?Ue(e):new ArrayBuffer(0),de=async({bytes:e,algorithm:t="SHA-512"})=>{const r=await te(e);return crypto.subtle.digest(t,r)},Ke=async(e,t=16)=>{const r=await te(e);return[...new Uint8Array(r)].map(n=>n.toString(t).padStart(2,"0")).join("")},ge=async({bytes:e,algorithm:t="SHA-512",radix:r=16})=>{const n=await de({bytes:e,algorithm:t}),s=await Ke(n,r);return`${t}:${s}`},zt=({id:e})=>{const t=e.split(":");ee.assert(t.length===2);const[r,n]=t,s=atob(n),o=new Uint8Array(s.length);return s.split("").map(u=>u.charCodeAt(0)).forEach((u,g)=>{o[g]=u}),o},Qe=async e=>{if(typeof e=="string")return e;const t=await te(e);return new TextDecoder().decode(t)},ie=[];ie.push(async()=>{const e="test",t=await te(e),r=await Qe(t);return ee.assertEqual(e,r)}),ie.push(async()=>Be.map(async e=>{const t=await de({bytes:"test",algorithm:e});return ee.assertEqual(t.byteLength,He[e])})),ie.push(async()=>{{const e=await ge({bytes:"test",algorithm:"SHA-256"});ee.assertEqual(e,"SHA-256:n4bQgYhMfWWaL+qgxVrQFaO/TxsrC4Is0V1sFbDwCgg=")}{const e=await ge({bytes:"test",algorithm:"SHA-512"});ee.assertEqual(e,"SHA-512:7iaw3Ur350mqGo7jwQrpkj9hiYB3Lkc/iBml1JQODbJ6wYX4oOHV+E+IvIh/1nsUNzLDBMxfqa2Ob1f1ACio/w==")}}),ie.push(async()=>Be.map(async e=>{const t="test",r=await ge({bytes:t,algorithm:e}),n=new Uint8Array(await de({bytes:t,algorithm:e})),s=zt({id:r});return ee.assertEqualElements(s,n)}));const Ft=async()=>{if((await Promise.all(ie.map(async t=>{try{return await t(),!0}catch(r){return console.error(r),!1}}))).find(t=>t===!1))throw new Error("TESTS FAILED");return console.log("TESTS PASS"),!0};function Te(e){const t=new Uint8Array(e.slice(0));let r="";for(let n=0;n<t.length;n++)r+=String.fromCharCode(t[n]);return btoa(r)}const Jt=e=>{const t=new Uint8Array(e),r=[];for(let n=0;n<t.length;++n)r.push(t[n].toString(16).padStart(2,"0"));return r.join("")},Ht=e=>new TextDecoder().decode(new Uint8Array(e)),vt=(e,t)=>e.slice(0,e.size,t),Kt=e=>{const t=globalThis.atob(e),r=t.length,n=new Uint8Array(r);for(let s=0;s<r;s++)n[s]=t.charCodeAt(s);return n.buffer},Qt=e=>{if(!e)return;const t=e.split(","),n=(t[0].match(/:(.*?);/)??[])[1],s=atob(t[1]);let o=s.length;const u=new Uint8Array(o);for(;o--;)u[o]=s.charCodeAt(o);return new Blob([u],{type:n})},ke=e=>e instanceof ArrayBuffer?e:typeof e=="string"?new TextEncoder().encode(e):ArrayBuffer.isView(e)?e.buffer:Array.isArray(e)?Ue(e):new ArrayBuffer(0),Yt=async(e,t)=>{const r=ke(e);return crypto.subtle.digest(t,r)},Oe=e=>{const t=e;return!!(t instanceof ArrayBuffer||typeof t=="string"||ArrayBuffer.isView(t)||Array.isArray(t))},Gt=e=>e instanceof Blob?!0:Oe(e),Zt=e=>{if(typeof e=="string")return e.length;if(e instanceof Blob)return e.size;if(e instanceof ArrayBuffer||ArrayBuffer.isView(e))return e.byteLength};var Ie;try{Ie=new TextDecoder}catch{}var x,F,i=0,M={},E,K,z=0,J=0,D,v,j=[],B,Ye={useRecords:!1,mapsAsObjects:!0};class Ge{}const Ze=new Ge;Ze.name="MessagePack 0xC1";var Q=!1,Xe=2,Xt;try{new Function("")}catch{Xe=1/0}class ae{constructor(t){t&&(t.useRecords===!1&&t.mapsAsObjects===void 0&&(t.mapsAsObjects=!0),t.sequential&&t.trusted!==!1&&(t.trusted=!0,!t.structures&&t.useRecords!=!1&&(t.structures=[],t.maxSharedStructures||(t.maxSharedStructures=0))),t.structures?t.structures.sharedLength=t.structures.length:t.getStructures&&((t.structures=[]).uninitialized=!0,t.structures.sharedLength=0),t.int64AsNumber&&(t.int64AsType="number")),Object.assign(this,t)}unpack(t,r){if(x)return lt(()=>(_e(),this?this.unpack(t,r):ae.prototype.unpack.call(Ye,t,r)));!t.buffer&&t.constructor===ArrayBuffer&&(t=typeof Buffer<"u"?Buffer.from(t):new Uint8Array(t)),typeof r=="object"?(F=r.end||t.length,i=r.start||0):(i=0,F=r>-1?r:t.length),J=0,K=null,D=null,x=t;try{B=t.dataView||(t.dataView=new DataView(t.buffer,t.byteOffset,t.byteLength))}catch(n){throw x=null,t instanceof Uint8Array?n:new Error("Source must be a Uint8Array or Buffer but was a "+(t&&typeof t=="object"?t.constructor.name:typeof t))}if(this instanceof ae){if(M=this,this.structures)return E=this.structures,xe(r);(!E||E.length>0)&&(E=[])}else M=Ye,(!E||E.length>0)&&(E=[]);return xe(r)}unpackMultiple(t,r){let n,s=0;try{Q=!0;let o=t.length,u=this?this.unpack(t,o):he.unpack(t,o);if(r){if(r(u,s,i)===!1)return;for(;i<o;)if(s=i,r(xe(),s,i)===!1)return}else{for(n=[u];i<o;)s=i,n.push(xe());return n}}catch(o){throw o.lastPosition=s,o.values=n,o}finally{Q=!1,_e()}}_mergeStructures(t,r){t=t||[],Object.isFrozen(t)&&(t=t.map(n=>n.slice(0)));for(let n=0,s=t.length;n<s;n++){let o=t[n];o&&(o.isShared=!0,n>=32&&(o.highByte=n-32>>5))}t.sharedLength=t.length;for(let n in r||[])if(n>=0){let s=t[n],o=r[n];o&&(s&&((t.restoreStructures||(t.restoreStructures=[]))[n]=s),t[n]=o)}return this.structures=t}decode(t,r){return this.unpack(t,r)}}function xe(e){try{if(!M.trusted&&!Q){let r=E.sharedLength||0;r<E.length&&(E.length=r)}let t;if(M.randomAccessStructure&&x[i]<64&&x[i]>=32&&Xt||(t=P()),D&&(i=D.postBundlePosition,D=null),Q&&(E.restoreStructures=null),i==F)E&&E.restoreStructures&&We(),E=null,x=null,v&&(v=null);else{if(i>F)throw new Error("Unexpected end of MessagePack data");if(!Q){let r;try{r=JSON.stringify(t,(n,s)=>typeof s=="bigint"?`${s}n`:s).slice(0,100)}catch(n){r="(JSON view not available "+n+")"}throw new Error("Data read, but end of buffer not reached "+r)}}return t}catch(t){throw E&&E.restoreStructures&&We(),_e(),(t instanceof RangeError||t.message.startsWith("Unexpected end of buffer")||i>F)&&(t.incomplete=!0),t}}function We(){for(let e in E.restoreStructures)E[e]=E.restoreStructures[e];E.restoreStructures=null}function P(){let e=x[i++];if(e<160)if(e<128){if(e<64)return e;{let t=E[e&63]||M.getStructures&&tt()[e&63];return t?(t.read||(t.read=Me(t,e&63)),t.read()):e}}else if(e<144)if(e-=128,M.mapsAsObjects){let t={};for(let r=0;r<e;r++){let n=ft();n==="__proto__"&&(n="__proto_"),t[n]=P()}return t}else{let t=new Map;for(let r=0;r<e;r++)t.set(P(),P());return t}else{e-=144;let t=new Array(e);for(let r=0;r<e;r++)t[r]=P();return M.freezeData?Object.freeze(t):t}else if(e<192){let t=e-160;if(J>=i)return K.slice(i-z,(i+=t)-z);if(J==0&&F<140){let r=t<16?Le(t):st(t);if(r!=null)return r}return Re(t)}else{let t;switch(e){case 192:return null;case 193:return D?(t=P(),t>0?D[1].slice(D.position1,D.position1+=t):D[0].slice(D.position0,D.position0-=t)):Ze;case 194:return!1;case 195:return!0;case 196:if(t=x[i++],t===void 0)throw new Error("Unexpected end of buffer");return Pe(t);case 197:return t=B.getUint16(i),i+=2,Pe(t);case 198:return t=B.getUint32(i),i+=4,Pe(t);case 199:return X(x[i++]);case 200:return t=B.getUint16(i),i+=2,X(t);case 201:return t=B.getUint32(i),i+=4,X(t);case 202:if(t=B.getFloat32(i),M.useFloat32>2){let r=De[(x[i]&127)<<1|x[i+1]>>7];return i+=4,(r*t+(t>0?.5:-.5)>>0)/r}return i+=4,t;case 203:return t=B.getFloat64(i),i+=8,t;case 204:return x[i++];case 205:return t=B.getUint16(i),i+=2,t;case 206:return t=B.getUint32(i),i+=4,t;case 207:return M.int64AsType==="number"?(t=B.getUint32(i)*4294967296,t+=B.getUint32(i+4)):M.int64AsType==="string"?t=B.getBigUint64(i).toString():M.int64AsType==="auto"?(t=B.getBigUint64(i),t<=BigInt(2)<<BigInt(52)&&(t=Number(t))):t=B.getBigUint64(i),i+=8,t;case 208:return B.getInt8(i++);case 209:return t=B.getInt16(i),i+=2,t;case 210:return t=B.getInt32(i),i+=4,t;case 211:return M.int64AsType==="number"?(t=B.getInt32(i)*4294967296,t+=B.getUint32(i+4)):M.int64AsType==="string"?t=B.getBigInt64(i).toString():M.int64AsType==="auto"?(t=B.getBigInt64(i),t>=BigInt(-2)<<BigInt(52)&&t<=BigInt(2)<<BigInt(52)&&(t=Number(t))):t=B.getBigInt64(i),i+=8,t;case 212:if(t=x[i++],t==114)return ct(x[i++]&63);{let r=j[t];if(r)return r.read?(i++,r.read(P())):r.noBuffer?(i++,r()):r(x.subarray(i,++i));throw new Error("Unknown extension "+t)}case 213:return t=x[i],t==114?(i++,ct(x[i++]&63,x[i++])):X(2);case 214:return X(4);case 215:return X(8);case 216:return X(16);case 217:return t=x[i++],J>=i?K.slice(i-z,(i+=t)-z):er(t);case 218:return t=B.getUint16(i),i+=2,J>=i?K.slice(i-z,(i+=t)-z):tr(t);case 219:return t=B.getUint32(i),i+=4,J>=i?K.slice(i-z,(i+=t)-z):rr(t);case 220:return t=B.getUint16(i),i+=2,rt(t);case 221:return t=B.getUint32(i),i+=4,rt(t);case 222:return t=B.getUint16(i),i+=2,nt(t);case 223:return t=B.getUint32(i),i+=4,nt(t);default:if(e>=224)return e-256;if(e===void 0){let r=new Error("Unexpected end of MessagePack data");throw r.incomplete=!0,r}throw new Error("Unknown MessagePack token "+e)}}}const Wt=/^[a-zA-Z_$][a-zA-Z\d_$]*$/;function Me(e,t){function r(){if(r.count++>Xe){let s=e.read=new Function("r","return function(){return "+(M.freezeData?"Object.freeze":"")+"({"+e.map(o=>o==="__proto__"?"__proto_:r()":Wt.test(o)?o+":r()":"["+JSON.stringify(o)+"]:r()").join(",")+"})}")(P);return e.highByte===0&&(e.read=et(t,e.read)),s()}let n={};for(let s=0,o=e.length;s<o;s++){let u=e[s];u==="__proto__"&&(u="__proto_"),n[u]=P()}return M.freezeData?Object.freeze(n):n}return r.count=0,e.highByte===0?et(t,r):r}const et=(e,t)=>function(){let r=x[i++];if(r===0)return t();let n=e<32?-(e+(r<<5)):e+(r<<5),s=E[n]||tt()[n];if(!s)throw new Error("Record id is not defined for "+n);return s.read||(s.read=Me(s,e)),s.read()};function tt(){let e=lt(()=>(x=null,M.getStructures()));return E=M._mergeStructures(e,E)}var Re=fe,er=fe,tr=fe,rr=fe;function fe(e){let t;if(e<16&&(t=Le(e)))return t;if(e>64&&Ie)return Ie.decode(x.subarray(i,i+=e));const r=i+e,n=[];for(t="";i<r;){const s=x[i++];if((s&128)===0)n.push(s);else if((s&224)===192){const o=x[i++]&63;n.push((s&31)<<6|o)}else if((s&240)===224){const o=x[i++]&63,u=x[i++]&63;n.push((s&31)<<12|o<<6|u)}else if((s&248)===240){const o=x[i++]&63,u=x[i++]&63,g=x[i++]&63;let w=(s&7)<<18|o<<12|u<<6|g;w>65535&&(w-=65536,n.push(w>>>10&1023|55296),w=56320|w&1023),n.push(w)}else n.push(s);n.length>=4096&&(t+=q.apply(String,n),n.length=0)}return n.length>0&&(t+=q.apply(String,n)),t}function rt(e){let t=new Array(e);for(let r=0;r<e;r++)t[r]=P();return M.freezeData?Object.freeze(t):t}function nt(e){if(M.mapsAsObjects){let t={};for(let r=0;r<e;r++){let n=ft();n==="__proto__"&&(n="__proto_"),t[n]=P()}return t}else{let t=new Map;for(let r=0;r<e;r++)t.set(P(),P());return t}}var q=String.fromCharCode;function st(e){let t=i,r=new Array(e);for(let n=0;n<e;n++){const s=x[i++];if((s&128)>0){i=t;return}r[n]=s}return q.apply(String,r)}function Le(e){if(e<4)if(e<2){if(e===0)return"";{let t=x[i++];if((t&128)>1){i-=1;return}return q(t)}}else{let t=x[i++],r=x[i++];if((t&128)>0||(r&128)>0){i-=2;return}if(e<3)return q(t,r);let n=x[i++];if((n&128)>0){i-=3;return}return q(t,r,n)}else{let t=x[i++],r=x[i++],n=x[i++],s=x[i++];if((t&128)>0||(r&128)>0||(n&128)>0||(s&128)>0){i-=4;return}if(e<6){if(e===4)return q(t,r,n,s);{let o=x[i++];if((o&128)>0){i-=5;return}return q(t,r,n,s,o)}}else if(e<8){let o=x[i++],u=x[i++];if((o&128)>0||(u&128)>0){i-=6;return}if(e<7)return q(t,r,n,s,o,u);let g=x[i++];if((g&128)>0){i-=7;return}return q(t,r,n,s,o,u,g)}else{let o=x[i++],u=x[i++],g=x[i++],w=x[i++];if((o&128)>0||(u&128)>0||(g&128)>0||(w&128)>0){i-=8;return}if(e<10){if(e===8)return q(t,r,n,s,o,u,g,w);{let b=x[i++];if((b&128)>0){i-=9;return}return q(t,r,n,s,o,u,g,w,b)}}else if(e<12){let b=x[i++],p=x[i++];if((b&128)>0||(p&128)>0){i-=10;return}if(e<11)return q(t,r,n,s,o,u,g,w,b,p);let m=x[i++];if((m&128)>0){i-=11;return}return q(t,r,n,s,o,u,g,w,b,p,m)}else{let b=x[i++],p=x[i++],m=x[i++],O=x[i++];if((b&128)>0||(p&128)>0||(m&128)>0||(O&128)>0){i-=12;return}if(e<14){if(e===12)return q(t,r,n,s,o,u,g,w,b,p,m,O);{let _=x[i++];if((_&128)>0){i-=13;return}return q(t,r,n,s,o,u,g,w,b,p,m,O,_)}}else{let _=x[i++],V=x[i++];if((_&128)>0||(V&128)>0){i-=14;return}if(e<15)return q(t,r,n,s,o,u,g,w,b,p,m,O,_,V);let C=x[i++];if((C&128)>0){i-=15;return}return q(t,r,n,s,o,u,g,w,b,p,m,O,_,V,C)}}}}}function it(){let e=x[i++],t;if(e<192)t=e-160;else switch(e){case 217:t=x[i++];break;case 218:t=B.getUint16(i),i+=2;break;case 219:t=B.getUint32(i),i+=4;break;default:throw new Error("Expected string")}return fe(t)}function Pe(e){return M.copyBuffers?Uint8Array.prototype.slice.call(x,i,i+=e):x.subarray(i,i+=e)}function X(e){let t=x[i++];if(j[t]){let r;return j[t](x.subarray(i,r=i+=e),n=>{i=n;try{return P()}finally{i=r}})}else throw new Error("Unknown extension type "+t)}var at=new Array(4096);function ft(){let e=x[i++];if(e>=160&&e<192){if(e=e-160,J>=i)return K.slice(i-z,(i+=e)-z);if(!(J==0&&F<180))return Re(e)}else return i--,ot(P());let t=(e<<5^(e>1?B.getUint16(i):e>0?x[i]:0))&4095,r=at[t],n=i,s=i+e-3,o,u=0;if(r&&r.bytes==e){for(;n<s;){if(o=B.getUint32(n),o!=r[u++]){n=1879048192;break}n+=4}for(s+=3;n<s;)if(o=x[n++],o!=r[u++]){n=1879048192;break}if(n===s)return i=n,r.string;s-=3,n=i}for(r=[],at[t]=r,r.bytes=e;n<s;)o=B.getUint32(n),r.push(o),n+=4;for(s+=3;n<s;)o=x[n++],r.push(o);let g=e<16?Le(e):st(e);return g!=null?r.string=g:r.string=Re(e)}function ot(e){if(typeof e=="string")return e;if(typeof e=="number"||typeof e=="boolean"||typeof e=="bigint")return e.toString();if(e==null)return e+"";throw new Error("Invalid property type for record",typeof e)}const ct=(e,t)=>{let r=P().map(ot),n=e;t!==void 0&&(e=e<32?-((t<<5)+e):(t<<5)+e,r.highByte=t);let s=E[e];return s&&(s.isShared||Q)&&((E.restoreStructures||(E.restoreStructures=[]))[e]=s),E[e]=r,r.read=Me(r,n),r.read()};j[0]=()=>{},j[0].noBuffer=!0,j[66]=e=>{let t=e.length,r=BigInt(e[0]&128?e[0]-256:e[0]);for(let n=1;n<t;n++)r<<=BigInt(8),r+=BigInt(e[n]);return r};let nr={Error,TypeError,ReferenceError};j[101]=()=>{let e=P();return(nr[e[0]]||Error)(e[1],{cause:e[2]})},j[105]=e=>{if(M.structuredClone===!1)throw new Error("Structured clone extension is disabled");let t=B.getUint32(i-4);v||(v=new Map);let r=x[i],n;r>=144&&r<160||r==220||r==221?n=[]:n={};let s={target:n};v.set(t,s);let o=P();return s.used?Object.assign(n,o):(s.target=o,o)},j[112]=e=>{if(M.structuredClone===!1)throw new Error("Structured clone extension is disabled");let t=B.getUint32(i-4),r=v.get(t);return r.used=!0,r.target},j[115]=()=>new Set(P());const ut=["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].map(e=>e+"Array");let sr=typeof globalThis=="object"?globalThis:window;j[116]=e=>{let t=e[0],r=ut[t];if(!r){if(t===16){let n=new ArrayBuffer(e.length-1);return new Uint8Array(n).set(e.subarray(1)),n}throw new Error("Could not find typed array for code "+t)}return new sr[r](Uint8Array.prototype.slice.call(e,1).buffer)},j[120]=()=>{let e=P();return new RegExp(e[0],e[1])};const ir=[];j[98]=e=>{let t=(e[0]<<24)+(e[1]<<16)+(e[2]<<8)+e[3],r=i;return i+=t-e.length,D=ir,D=[it(),it()],D.position0=0,D.position1=0,D.postBundlePosition=i,i=r,P()},j[255]=e=>e.length==4?new Date((e[0]*16777216+(e[1]<<16)+(e[2]<<8)+e[3])*1e3):e.length==8?new Date(((e[0]<<22)+(e[1]<<14)+(e[2]<<6)+(e[3]>>2))/1e6+((e[3]&3)*4294967296+e[4]*16777216+(e[5]<<16)+(e[6]<<8)+e[7])*1e3):e.length==12?new Date(((e[0]<<24)+(e[1]<<16)+(e[2]<<8)+e[3])/1e6+((e[4]&128?-281474976710656:0)+e[6]*1099511627776+e[7]*4294967296+e[8]*16777216+(e[9]<<16)+(e[10]<<8)+e[11])*1e3):new Date("invalid");function lt(e){let t=F,r=i,n=z,s=J,o=K,u=v,g=D,w=new Uint8Array(x.slice(0,F)),b=E,p=E.slice(0,E.length),m=M,O=Q,_=e();return F=t,i=r,z=n,J=s,K=o,v=u,D=g,x=w,Q=O,E=b,E.splice(0,E.length,...p),M=m,B=new DataView(x.buffer,x.byteOffset,x.byteLength),_}function _e(){x=null,v=null,E=null}const De=new Array(147);for(let e=0;e<256;e++)De[e]=+("1e"+Math.floor(45.15-e*.30103));var he=new ae({useRecords:!1});he.unpack,he.unpackMultiple,he.unpack;let ar=new Float32Array(1);new Uint8Array(ar.buffer,0,4);let ye;try{ye=new TextEncoder}catch{}let qe,dt;const we=typeof Buffer<"u",pe=we?function(e){return Buffer.allocUnsafeSlow(e)}:Uint8Array,gt=we?Buffer:Uint8Array,xt=we?4294967296:2144337920;let f,oe,I,a=0,N,R=null,fr;const or=21760,cr=/[\u0080-\uFFFF]/,re=Symbol("record-id");class Ce extends ae{constructor(t){super(t),this.offset=0;let r,n,s,o,u=gt.prototype.utf8Write?function(c,y){return f.utf8Write(c,y,f.byteLength-y)}:ye&&ye.encodeInto?function(c,y){return ye.encodeInto(c,f.subarray(y)).written}:!1,g=this;t||(t={});let w=t&&t.sequential,b=t.structures||t.saveStructures,p=t.maxSharedStructures;if(p==null&&(p=b?32:0),p>8160)throw new Error("Maximum maxSharedStructure is 8160");t.structuredClone&&t.moreTypes==null&&(this.moreTypes=!0);let m=t.maxOwnStructures;m==null&&(m=b?32:64),!this.structures&&t.useRecords!=!1&&(this.structures=[]);let O=p>32||m+p>64,_=p+64,V=p+m+64;if(V>8256)throw new Error("Maximum maxSharedStructure + maxOwnStructure is 8192");let C=[],W=0,ne=0;this.pack=this.encode=function(c,y){if(f||(f=new pe(8192),I=f.dataView||(f.dataView=new DataView(f.buffer,0,8192)),a=0),N=f.length-10,N-a<2048?(f=new pe(f.length),I=f.dataView||(f.dataView=new DataView(f.buffer,0,f.length)),N=f.length-10,a=0):a=a+7&2147483640,r=a,y&hr&&(a+=y&255),o=g.structuredClone?new Map:null,g.bundleStrings&&typeof c!="string"?(R=[],R.size=1/0):R=null,s=g.structures,s){s.uninitialized&&(s=g._mergeStructures(g.getStructures()));let l=s.sharedLength||0;if(l>p)throw new Error("Shared structures is larger than maximum shared structures, try increasing maxSharedStructures to "+s.sharedLength);if(!s.transitions){s.transitions=Object.create(null);for(let h=0;h<l;h++){let S=s[h];if(!S)continue;let U,A=s.transitions;for(let T=0,k=S.length;T<k;T++){let H=S[T];U=A[H],U||(U=A[H]=Object.create(null)),A=U}A[re]=h+64}this.lastNamedStructuresLength=l}w||(s.nextId=l+64)}n&&(n=!1);let d;try{g.randomAccessStructure&&c&&c.constructor&&c.constructor===Object?Vr(c):L(c);let l=R;if(R&&wt(r,L,0),o&&o.idsToInsert){let h=o.idsToInsert.sort((T,k)=>T.offset>k.offset?1:-1),S=h.length,U=-1;for(;l&&S>0;){let T=h[--S].offset+r;T<l.stringsPosition+r&&U===-1&&(U=0),T>l.position+r?U>=0&&(U+=6):(U>=0&&(I.setUint32(l.position+r,I.getUint32(l.position+r)+U),U=-1),l=l.previous,S++)}U>=0&&l&&I.setUint32(l.position+r,I.getUint32(l.position+r)+U),a+=h.length*6,a>N&&G(a),g.offset=a;let A=lr(f.subarray(r,a),h);return o=null,A}return g.offset=a,y&gr?(f.start=r,f.end=a,f):f.subarray(r,a)}catch(l){throw d=l,l}finally{if(s&&(be(),n&&g.saveStructures)){let l=s.sharedLength||0,h=f.subarray(r,a),S=dr(s,g);if(!d)return g.saveStructures(S,S.isCompatible)===!1?g.pack(c,y):(g.lastNamedStructuresLength=l,f.length>1073741824&&(f=null),h)}f.length>1073741824&&(f=null),y&xr&&(a=r)}};const be=()=>{ne<10&&ne++;let c=s.sharedLength||0;if(s.length>c&&!w&&(s.length=c),W>1e4)s.transitions=null,ne=0,W=0,C.length>0&&(C=[]);else if(C.length>0&&!w){for(let y=0,d=C.length;y<d;y++)C[y][re]=0;C=[]}},ce=c=>{var y=c.length;y<16?f[a++]=144|y:y<65536?(f[a++]=220,f[a++]=y>>8,f[a++]=y&255):(f[a++]=221,I.setUint32(a,y),a+=4);for(let d=0;d<y;d++)L(c[d])},L=c=>{a>N&&(f=G(a));var y=typeof c,d;if(y==="string"){let l=c.length;if(R&&l>=4&&l<4096){if((R.size+=l)>or){let A,T=(R[0]?R[0].length*3+R[1].length:0)+10;a+T>N&&(f=G(a+T));let k;R.position?(k=R,f[a]=200,a+=3,f[a++]=98,A=a-r,a+=4,wt(r,L,0),I.setUint16(A+r-3,a-r-A)):(f[a++]=214,f[a++]=98,A=a-r,a+=4),R=["",""],R.previous=k,R.size=0,R.position=A}let U=cr.test(c);R[U?0:1]+=c,f[a++]=193,L(U?-l:l);return}let h;l<32?h=1:l<256?h=2:l<65536?h=3:h=5;let S=l*3;if(a+S>N&&(f=G(a+S)),l<64||!u){let U,A,T,k=a+h;for(U=0;U<l;U++)A=c.charCodeAt(U),A<128?f[k++]=A:A<2048?(f[k++]=A>>6|192,f[k++]=A&63|128):(A&64512)===55296&&((T=c.charCodeAt(U+1))&64512)===56320?(A=65536+((A&1023)<<10)+(T&1023),U++,f[k++]=A>>18|240,f[k++]=A>>12&63|128,f[k++]=A>>6&63|128,f[k++]=A&63|128):(f[k++]=A>>12|224,f[k++]=A>>6&63|128,f[k++]=A&63|128);d=k-a-h}else d=u(c,a+h);d<32?f[a++]=160|d:d<256?(h<2&&f.copyWithin(a+2,a+1,a+1+d),f[a++]=217,f[a++]=d):d<65536?(h<3&&f.copyWithin(a+3,a+2,a+2+d),f[a++]=218,f[a++]=d>>8,f[a++]=d&255):(h<5&&f.copyWithin(a+5,a+3,a+3+d),f[a++]=219,I.setUint32(a,d),a+=4),a+=d}else if(y==="number")if(c>>>0===c)c<32||c<128&&this.useRecords===!1||c<64&&!this.randomAccessStructure?f[a++]=c:c<256?(f[a++]=204,f[a++]=c):c<65536?(f[a++]=205,f[a++]=c>>8,f[a++]=c&255):(f[a++]=206,I.setUint32(a,c),a+=4);else if(c>>0===c)c>=-32?f[a++]=256+c:c>=-128?(f[a++]=208,f[a++]=c+256):c>=-32768?(f[a++]=209,I.setInt16(a,c),a+=2):(f[a++]=210,I.setInt32(a,c),a+=4);else{let l;if((l=this.useFloat32)>0&&c<4294967296&&c>=-2147483648){f[a++]=202,I.setFloat32(a,c);let h;if(l<4||(h=c*De[(f[a]&127)<<1|f[a+1]>>7])>>0===h){a+=4;return}else a--}f[a++]=203,I.setFloat64(a,c),a+=8}else if(y==="object"||y==="function")if(!c)f[a++]=192;else{if(o){let h=o.get(c);if(h){if(!h.id){let S=o.idsToInsert||(o.idsToInsert=[]);h.id=S.push(h)}f[a++]=214,f[a++]=112,I.setUint32(a,h.id),a+=4;return}else o.set(c,{offset:a-r})}let l=c.constructor;if(l===Object)Ae(c);else if(l===Array)ce(c);else if(l===Map)if(this.mapAsEmptyObject)f[a++]=128;else{d=c.size,d<16?f[a++]=128|d:d<65536?(f[a++]=222,f[a++]=d>>8,f[a++]=d&255):(f[a++]=223,I.setUint32(a,d),a+=4);for(let[h,S]of c)L(h),L(S)}else{for(let h=0,S=qe.length;h<S;h++){let U=dt[h];if(c instanceof U){let A=qe[h];if(A.write){A.type&&(f[a++]=212,f[a++]=A.type,f[a++]=0);let ue=A.write.call(this,c);ue===c?Array.isArray(c)?ce(c):Ae(c):L(ue);return}let T=f,k=I,H=a;f=null;let Z;try{Z=A.pack.call(this,c,ue=>(f=T,T=null,a+=ue,a>N&&G(a),{target:f,targetView:I,position:a-ue}),L)}finally{T&&(f=T,I=k,a=H,N=f.length-10)}Z&&(Z.length+a>N&&G(Z.length+a),a=ur(Z,f,a,A.type));return}}if(Array.isArray(c))ce(c);else{if(c.toJSON){const h=c.toJSON();if(h!==c)return L(h)}if(y==="function")return L(this.writeFunction&&this.writeFunction(c));Ae(c)}}}else if(y==="boolean")f[a++]=c?195:194;else if(y==="bigint"){if(c<BigInt(1)<<BigInt(63)&&c>=-(BigInt(1)<<BigInt(63)))f[a++]=211,I.setBigInt64(a,c);else if(c<BigInt(1)<<BigInt(64)&&c>0)f[a++]=207,I.setBigUint64(a,c);else if(this.largeBigIntToFloat)f[a++]=203,I.setFloat64(a,Number(c));else{if(this.largeBigIntToString)return L(c.toString());if(this.useBigIntExtension&&c<BigInt(2)**BigInt(1023)&&c>-(BigInt(2)**BigInt(1023))){f[a++]=199,a++,f[a++]=66;let l=[],h;do{let S=c&BigInt(255);h=(S&BigInt(128))===(c<BigInt(0)?BigInt(128):BigInt(0)),l.push(S),c>>=BigInt(8)}while(!((c===BigInt(0)||c===BigInt(-1))&&h));f[a-2]=l.length;for(let S=l.length;S>0;)f[a++]=Number(l[--S]);return}else throw new RangeError(c+" was too large to fit in MessagePack 64-bit integer format, use useBigIntExtension, or set largeBigIntToFloat to convert to float-64, or set largeBigIntToString to convert to string")}a+=8}else if(y==="undefined")this.encodeUndefinedAsNil?f[a++]=192:(f[a++]=212,f[a++]=0,f[a++]=0);else throw new Error("Unknown type: "+y)},Rt=this.variableMapSize||this.coercibleKeyAsNumber||this.skipValues?c=>{let y;if(this.skipValues){y=[];for(let h in c)(typeof c.hasOwnProperty!="function"||c.hasOwnProperty(h))&&!this.skipValues.includes(c[h])&&y.push(h)}else y=Object.keys(c);let d=y.length;d<16?f[a++]=128|d:d<65536?(f[a++]=222,f[a++]=d>>8,f[a++]=d&255):(f[a++]=223,I.setUint32(a,d),a+=4);let l;if(this.coercibleKeyAsNumber)for(let h=0;h<d;h++){l=y[h];let S=Number(l);L(isNaN(S)?l:S),L(c[l])}else for(let h=0;h<d;h++)L(l=y[h]),L(c[l])}:c=>{f[a++]=222;let y=a-r;a+=2;let d=0;for(let l in c)(typeof c.hasOwnProperty!="function"||c.hasOwnProperty(l))&&(L(l),L(c[l]),d++);if(d>65535)throw new Error('Object is too large to serialize with fast 16-bit map size, use the "variableMapSize" option to serialize this object');f[y+++r]=d>>8,f[y+r]=d&255},Lt=this.useRecords===!1?Rt:t.progressiveRecords&&!O?c=>{let y,d=s.transitions||(s.transitions=Object.create(null)),l=a++-r,h;for(let S in c)if(typeof c.hasOwnProperty!="function"||c.hasOwnProperty(S)){if(y=d[S],y)d=y;else{let U=Object.keys(c),A=d;d=s.transitions;let T=0;for(let k=0,H=U.length;k<H;k++){let Z=U[k];y=d[Z],y||(y=d[Z]=Object.create(null),T++),d=y}l+r+1==a?(a--,$e(d,U,T)):_t(d,U,l,T),h=!0,d=A[S]}L(c[S])}if(!h){let S=d[re];S?f[l+r]=S:_t(d,Object.keys(c),l,0)}}:c=>{let y,d=s.transitions||(s.transitions=Object.create(null)),l=0;for(let S in c)(typeof c.hasOwnProperty!="function"||c.hasOwnProperty(S))&&(y=d[S],y||(y=d[S]=Object.create(null),l++),d=y);let h=d[re];h?h>=96&&O?(f[a++]=((h-=96)&31)+96,f[a++]=h>>5):f[a++]=h:$e(d,d.__keys__||Object.keys(c),l);for(let S in c)(typeof c.hasOwnProperty!="function"||c.hasOwnProperty(S))&&L(c[S])},Pt=typeof this.useRecords=="function"&&this.useRecords,Ae=Pt?c=>{Pt(c)?Lt(c):Rt(c)}:Lt,G=c=>{let y;if(c>16777216){if(c-r>xt)throw new Error("Packed buffer would be larger than maximum buffer size");y=Math.min(xt,Math.round(Math.max((c-r)*(c>67108864?1.25:2),4194304)/4096)*4096)}else y=(Math.max(c-r<<2,f.length-1)>>12)+1<<12;let d=new pe(y);return I=d.dataView||(d.dataView=new DataView(d.buffer,0,y)),c=Math.min(c,f.length),f.copy?f.copy(d,0,r,c):d.set(f.slice(r,c)),a-=r,r=0,N=d.length-10,f=d},$e=(c,y,d)=>{let l=s.nextId;l||(l=64),l<_&&this.shouldShareStructure&&!this.shouldShareStructure(y)?(l=s.nextOwnId,l<V||(l=_),s.nextOwnId=l+1):(l>=V&&(l=_),s.nextId=l+1);let h=y.highByte=l>=96&&O?l-96>>5:-1;c[re]=l,c.__keys__=y,s[l-64]=y,l<_?(y.isShared=!0,s.sharedLength=l-63,n=!0,h>=0?(f[a++]=(l&31)+96,f[a++]=h):f[a++]=l):(h>=0?(f[a++]=213,f[a++]=114,f[a++]=(l&31)+96,f[a++]=h):(f[a++]=212,f[a++]=114,f[a++]=l),d&&(W+=ne*d),C.length>=m&&(C.shift()[re]=0),C.push(c),L(y))},_t=(c,y,d,l)=>{let h=f,S=a,U=N,A=r;f=oe,a=0,r=0,f||(oe=f=new pe(8192)),N=f.length-10,$e(c,y,l),oe=f;let T=a;if(f=h,a=S,N=U,r=A,T>1){let k=a+T-1;k>N&&G(k);let H=d+r;f.copyWithin(H+T,H+1,a),f.set(oe.slice(0,T),H),a=k}else f[d+r]=oe[0]},Vr=c=>{let y=fr(c,f,r,a,s,G,(d,l,h)=>{if(h)return n=!0;a=l;let S=f;return L(d),be(),S!==f?{position:a,targetView:I,target:f}:a},this);if(y===0)return Ae(c);a=y}}useBuffer(t){f=t,f.dataView||(f.dataView=new DataView(f.buffer,f.byteOffset,f.byteLength)),a=0}set position(t){a=t}get position(){return a}clearSharedData(){this.structures&&(this.structures=[]),this.typedStructs&&(this.typedStructs=[])}}dt=[Date,Set,Error,RegExp,ArrayBuffer,Object.getPrototypeOf(Uint8Array.prototype).constructor,Ge],qe=[{pack(e,t,r){let n=e.getTime()/1e3;if((this.useTimestamp32||e.getMilliseconds()===0)&&n>=0&&n<4294967296){let{target:s,targetView:o,position:u}=t(6);s[u++]=214,s[u++]=255,o.setUint32(u,n)}else if(n>0&&n<4294967296){let{target:s,targetView:o,position:u}=t(10);s[u++]=215,s[u++]=255,o.setUint32(u,e.getMilliseconds()*4e6+(n/1e3/4294967296>>0)),o.setUint32(u+4,n)}else if(isNaN(n)){if(this.onInvalidDate)return t(0),r(this.onInvalidDate());let{target:s,targetView:o,position:u}=t(3);s[u++]=212,s[u++]=255,s[u++]=255}else{let{target:s,targetView:o,position:u}=t(15);s[u++]=199,s[u++]=12,s[u++]=255,o.setUint32(u,e.getMilliseconds()*1e6),o.setBigInt64(u+4,BigInt(Math.floor(n)))}}},{pack(e,t,r){if(this.setAsEmptyObject)return t(0),r({});let n=Array.from(e),{target:s,position:o}=t(this.moreTypes?3:0);this.moreTypes&&(s[o++]=212,s[o++]=115,s[o++]=0),r(n)}},{pack(e,t,r){let{target:n,position:s}=t(this.moreTypes?3:0);this.moreTypes&&(n[s++]=212,n[s++]=101,n[s++]=0),r([e.name,e.message,e.cause])}},{pack(e,t,r){let{target:n,position:s}=t(this.moreTypes?3:0);this.moreTypes&&(n[s++]=212,n[s++]=120,n[s++]=0),r([e.source,e.flags])}},{pack(e,t){this.moreTypes?ht(e,16,t):yt(we?Buffer.from(e):new Uint8Array(e),t)}},{pack(e,t){let r=e.constructor;r!==gt&&this.moreTypes?ht(e,ut.indexOf(r.name),t):yt(e,t)}},{pack(e,t){let{target:r,position:n}=t(1);r[n]=193}}];function ht(e,t,r,n){let s=e.byteLength;if(s+1<256){var{target:o,position:u}=r(4+s);o[u++]=199,o[u++]=s+1}else if(s+1<65536){var{target:o,position:u}=r(5+s);o[u++]=200,o[u++]=s+1>>8,o[u++]=s+1&255}else{var{target:o,position:u,targetView:g}=r(7+s);o[u++]=201,g.setUint32(u,s+1),u+=4}o[u++]=116,o[u++]=t,e.buffer||(e=new Uint8Array(e)),o.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),u)}function yt(e,t){let r=e.byteLength;var n,s;if(r<256){var{target:n,position:s}=t(r+2);n[s++]=196,n[s++]=r}else if(r<65536){var{target:n,position:s}=t(r+3);n[s++]=197,n[s++]=r>>8,n[s++]=r&255}else{var{target:n,position:s,targetView:o}=t(r+5);n[s++]=198,o.setUint32(s,r),s+=4}n.set(e,s)}function ur(e,t,r,n){let s=e.length;switch(s){case 1:t[r++]=212;break;case 2:t[r++]=213;break;case 4:t[r++]=214;break;case 8:t[r++]=215;break;case 16:t[r++]=216;break;default:s<256?(t[r++]=199,t[r++]=s):s<65536?(t[r++]=200,t[r++]=s>>8,t[r++]=s&255):(t[r++]=201,t[r++]=s>>24,t[r++]=s>>16&255,t[r++]=s>>8&255,t[r++]=s&255)}return t[r++]=n,t.set(e,r),r+=s,r}function lr(e,t){let r,n=t.length*6,s=e.length-n;for(;r=t.pop();){let o=r.offset,u=r.id;e.copyWithin(o+n,o,s),n-=6;let g=o+n;e[g++]=214,e[g++]=105,e[g++]=u>>24,e[g++]=u>>16&255,e[g++]=u>>8&255,e[g++]=u&255,s=o}return e}function wt(e,t,r){if(R.length>0){I.setUint32(R.position+e,a+r-R.position-e),R.stringsPosition=a-e;let n=R;R=null,t(n[0]),t(n[1])}}function dr(e,t){return e.isCompatible=r=>{let n=!r||(t.lastNamedStructuresLength||0)===r.length;return n||t._mergeStructures(r),n},e}let pt=new Ce({useRecords:!1});pt.pack,pt.pack;const gr=512,xr=1024,hr=2048,yr=e=>new Ce({structuredClone:!0}).unpack(new Uint8Array(e));function wr(e){return Oe(e)?mr(e):pr(e)}async function pr(e){const t=await te(e);return Te(t)}function mr(e){const t=ke(e);return Te(t)}const mt=(e,t="application/octet-stream")=>e instanceof Blob?e:e instanceof ArrayBuffer?new Blob([e],{type:t}):typeof e=="string"?new Blob([e],{type:t}):ArrayBuffer.isView(e)?new Blob([e],{type:t}):Array.isArray(e)?new Blob([Ue(e)],{type:t}):new Blob([]),Y={toMsgPack:e=>{const t=new Ce({structuredClone:!0});return new Uint8Array(t.encode(e))},msgPackToObject:yr,typeOfBytes:e=>{if(e instanceof Blob)return"Blob";if(e instanceof ArrayBuffer)return"ArrayBuffer";if(typeof e=="string")return"string";if(ArrayBuffer.isView(e))return"ArrayBufferView";if(Array.isArray(e))return"Array"},toDataUrl:async e=>{const t=mt(e),r=new FileReader;return new Promise((n,s)=>{const o=u=>typeof u=="string"?n(u):(console.log({bytes:e}),s("Unable to convert to data URL"));r.onload=function(u){o(u.target?.result)},r.readAsDataURL(t)})},dataUrlToBlob:Qt,lengthOf:Zt,isByteLike:Gt,isImmediateByteLike:Oe,hashOf:de,immediateHashOf:Yt,addressStringOf:ge,toArrayBuffer:te,immediateToArrayBuffer:ke,toBlob:mt,toText:Qe,toBase64:wr,encodeAsString:Ke,test:Ft,assignMediaTypeToBlob:vt,utf8ToUint8Array:e=>new TextEncoder().encode(e),base64ToArrayBuffer:Kt,arrayBufferToHex:Jt,arrayBufferToUtf8:Ht,arrayBufferToBase64:Te,ALL_ALGORITHMS:Be,ALGORITHM_BYTE_LENGTHS:He},Sr=e=>typeof e=="function",St=e=>e==null||Number.isNaN(e),bt=e=>!St(e),br=e=>Sr(e)?e():e,Ar={isDefined:bt,isUndefined:St,safe:(e,t={})=>{const{quiet:r=!1,def:n=void 0,onError:s}=t;try{return e()}catch(o){return r||(console.error(o),bt(s)&&console.log(br(s))),n}}},{isDefined:Ne,isUndefined:Br,safe:At}=Ar,Bt=e=>e==null||Number.isNaN(e),Er=e=>!Bt(e),Ur={isDefined:Er,isUndefined:Bt},{isDefined:me,isUndefined:Tr}=Ur,kr=(e,t,r)=>{if(Tr(e))return;const n=t.get(e);if(me(n))return n;if(me(r)){const s=r();return t.set(e,s),s}},Or=()=>{const e=new Map;let t=performance.now();const r={get:(n,s)=>kr(n,e,s),set:(n,s)=>(e.set(n,s),r),delete:n=>e.delete(n),entries:()=>Array.from(e.entries()),clear:()=>e.clear(),size:()=>e.size,findKeys:n=>Array.from(e.entries()).filter(([s,o])=>o===n).map(([s,o])=>s),lastUpdate:()=>t};return r},Ir={create:Or},Mr=e=>t=>{if(typeof e=="string")return new RegExp(e).test(t.traceId);const{traceId:r,message:n,extra:s=()=>!0,timestamp:o=()=>!0}=e;return!(r&&!new RegExp(r).test(t.traceId)||n&&!new RegExp(n).test(t.message)||t.timestamp&&!o(t.timestamp)||t.extra&&!s(t.extra))},Rr=e=>t=>{for(const r of e)if(Mr(r)(t))return r;return!1},Lr=e=>t=>typeof e=="string"?t:e.transform?e.transform(t):t,Se=e=>{const t=[],r={length:0,push:n=>{t.length>=e&&t.shift(),t.push(n),r.length=t.length},get:()=>t,clear:()=>{t.length=0,r.length=0},last:()=>t[t.length-1]};return r},Et=()=>{let e=performance.now(),t;const r={end:()=>(me(t)||(t=performance.now()),r),getDuration:()=>(t??performance.now())-e};return r},Pr=(e=100)=>{let t=0;const r=new Map,n=new Map,s=Se(e),o={time:()=>{const u=s.last();me(u)&&u.end();const g=Et();return s.push(g),g},getTimes:()=>s.get(),timer:u=>{const g=n.get(u)??Se(e);n.set(u,g);const w=Et();return g.push(w),w},counter:(u,g=1)=>{const w=r.get(u)??0;r.set(u,w+g)},getCounters:()=>new Map(r),getCounter:u=>r.get(u)??0,count:(u=1)=>{t+=u},getCount:()=>t,clearCount:()=>(t=0,o),getTimers:u=>(n.get(u)??Se(e)).get(),clearTimers:u=>((n.get(u)??Se(e)).clear(),o)};return o},_r=({logMatchers:e=[],logger:t=console.log,clock:r=performance}={})=>{const n=Ir.create(),s={getTraceIds:()=>n.entries().map(([o])=>o),start:(o,...u)=>{s.getStats(o).count(),s.getStats(o).time(),s.addLog({traceId:o,message:"start",extra:u})},getStats:o=>n.get(o,()=>Pr()),addLog:({traceId:o,message:u,timestamp:g=r.now(),extra:w=[]})=>{const b={traceId:o,message:u,timestamp:g,extra:w},p=Rr(e)(b);if(!p)return;const m=Lr(p)(b);t(`${m.timestamp} ${m.traceId}: ${m.message}`,...m.extra??[])},end:(o,...u)=>{s.addLog({traceId:o,message:"end",extra:u})}};return s},Ut=(e="",t=_r())=>{t.start(e);const r={span:n=>Ut(`${e}.${n}`,t),counter:(n,s=1)=>(t.getStats(e).counter(n,s),r),timer:n=>t.getStats(e).timer(n),end:()=>(t.end(e),r),log:(n,...s)=>(t.addLog({traceId:e,message:n,extra:s}),r)};return r},Ve=e=>{const{message:t,stack:r,extra:n,cause:s}=e,o=s?`
Caused by: ${Ve(s)}`:"",u=n?`
Extra: ${JSON.stringify(n,void 0,2)}`:"";return[t,r].filter(Ne).join(`
`)+u+o},Tt=e=>typeof e=="string"?e:e instanceof Response?`${e.url} ${e.status} ${e.statusText}`:typeof e=="object"&&e!==null&&"message"in e?Ve(e):At(()=>JSON.stringify(e,void 0,2))??"",Dr=async e=>{if(typeof e=="string")return e;if(e instanceof Response){const t=await e.text();return`${e.url} ${e.status} ${e.statusText} ${t}`}return typeof e=="object"&&e!==null&&"message"in e?Ve(e):At(()=>JSON.stringify(e,void 0,2))??""},kt=({error:e,extra:t,stack:r})=>{if(e instanceof Error){const n=Ne(e.cause)?kt({error:e.cause}):void 0;return{message:e.message,stack:e.stack??r,extra:t,cause:n}}return{message:Tt(e),stack:r,extra:t}},qr={errorToErrorDetail:kt,errorToText:Tt,errorToTextAsync:Dr},Ot=async({channel:e,subject:t,connectionListener:r,options:n={}})=>{const{log:s=()=>{},signal:o}=n;s("connectConnectionListenerToSubject: subject: ",t);for await(const u of e.listenOn(t,{callback:async g=>{const w=Y.msgPackToObject(g),{data:b,meta:p}=w;if(Je(w))throw console.error("Error in message: ",w),new Error(`connectConnectionListenerToSubject: Unexpected error in request message: ${w?.data?.message}`);try{const m=await r(b,{headers:p?.headers,signal:o});return Y.toMsgPack({data:m})}catch(m){const O=qr.errorToErrorDetail({error:m});return Y.toMsgPack({data:O,meta:{hasError:!0,code:500,status:O.message}})}}}));},Cr=async({channel:e,subscribers:t={},options:r={},obs:n=Ut()})=>{const s=n.span("MessageBus"),{defaultTimeoutMs:o=60*1e3,signal:u}=r,g=Object.entries(t);s.log("connect: subscribers: ",g);for(const[w,b]of g)Br(b)||Ot({channel:e,subject:w,connectionListener:b,options:r});return{requestMany:async(w,b,p={})=>{const m=s.span("requestMany"),{timeoutMs:O=60*1e3,headers:_,callback:V}=p,C=Y.toMsgPack({data:b,meta:{headers:_}}),W=m.span("channel requestMany").log("start requestMany",w),ne=await e.requestMany(w,C,{timeoutMs:O});for await(const be of ne){if(u?.aborted)return;const ce=Y.msgPackToObject(be);await V?.(ce)}W.end(),m.end()},request:async(w,b,p={})=>{const m=s.span("request").log("subject",w),{timeoutMs:O=o,headers:_}=p,V=Y.toMsgPack({data:b,meta:{headers:_}}),C=m.span("channel request").log("requestData",V),W=await e.request(w,V,{timeoutMs:O});return C.end(),m.end(),Y.msgPackToObject(W)},publish:async(w,b,p={})=>{const{headers:m}=p,O=Y.toMsgPack({data:b,meta:{headers:m}});return s.span("publish").log("subject",w),e.postOn(w,O)},subscribe:async(w,b,p={})=>(s.span("subscribe").log("subject",w),Ot({channel:e,subject:w,connectionListener:b,options:p}))}},It=({posterProducer:e,listenerProducer:t})=>{const r={postOn:(n,s,o={})=>{const{signal:u,reply:g}=o;e(u)(n)({subject:n,data:s,reply:g})},listenOn:function(n,s={}){const{signal:o,once:u,callback:g}=s,w=new AbortController;if(o?.aborted)throw new Error(`listenOn: Signal is already aborted for ${n}`);o?.addEventListener("abort",()=>{w.abort()});const b=t(w.signal)(n)(async p=>{if(p.subject===n){u&&w.abort();const m=await g?.(p.data,{finished:p.finished??!1});if(p.reply&&m&&(Mt(m)?(async()=>{for await(const O of m)e(w.signal)(p.reply)({subject:p.reply,data:O});e(w.signal)(p.reply)({subject:p.reply,data:void 0,finished:!0})})():e(w.signal)(p.reply)({subject:p.reply,data:m,finished:!0})),m&&!Mt(m))return{...p,data:m}}return p});return async function*(){for await(const p of b)yield p.data}()},request:async(n,s,o={})=>{const{signal:u,timeoutMs:g}=o,w=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((b,p)=>{u?.aborted&&p(new Error(`request: Signal is already aborted for ${n}`)),u?.addEventListener("abort",()=>{p(new Error("Request aborted"))});let m;g&&(m=setTimeout(()=>{p(new Error(`request: Request timed out after ${g}ms for ${n}`))},g)),r.listenOn(w,{callback:O=>{clearTimeout(m),b(O)},signal:u,once:!0}),r.postOn(n,s,{reply:w,signal:u})})},requestMany:async(n,s,o={})=>{const{signal:u,timeoutMs:g,callback:w}=o,b=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((p,m)=>{u?.aborted&&m(new Error(`requestMany: Signal is already aborted for ${n}`)),u?.addEventListener("abort",()=>{m(new Error("Request aborted"))});let O;g&&(O=setTimeout(()=>{m(new Error(`requestMany: Request timed out after ${g}ms for ${n}`))},g));const _=r.listenOn(b,{callback:(V,C)=>{if(V!==void 0&&w?.(V),C.finished)return clearTimeout(O),p(_)},signal:u});return r.postOn(n,s,{reply:b,signal:u}),_})}};return r};function Mt(e){return e!=null&&typeof e[Symbol.asyncIterator]=="function"}const Nr=e=>It({posterProducer:t=>r=>n=>{t?.aborted||e.emit(r,n)},listenerProducer:t=>r=>n=>{const s=[],o={resolve:void 0},u=async g=>{if(t?.aborted)return;const w=await n?.(g),b=Ne(w)?w:g;s.push(b),o.resolve?.()};return t?.addEventListener("abort",()=>{e.off(r,u)}),e.on(r,u),{[Symbol.asyncIterator]:async function*(){for(;!t?.aborted;)s.length>0?yield s.shift():await new Promise(g=>{o.resolve=g})}}}});$.Channel=It,$.EmitterChannel=Nr,$.MessageBus=Cr,$.isError=ze,$.isErrorMsg=Je,$.isMsg=Fe,$.isValue=je,$.isValueOrError=Dt,$.parseSubject=se,Object.defineProperty($,Symbol.toStringTag,{value:"Module"})});
