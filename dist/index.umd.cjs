(function(N,re){typeof exports=="object"&&typeof module<"u"?re(exports):typeof define=="function"&&define.amd?define(["exports"],re):(N=typeof globalThis<"u"?globalThis:N||self,re(N.Module={}))})(this,function(N){"use strict";const re=e=>{const t=e.split("."),r=t.shift(),n=t.join(".");return{root:r,segments:t,subpath:n}},Ce=e=>"value"in e&&e.value!==void 0,Ne=e=>"error"in e&&e.error!==void 0,Mt=e=>Ce(e)||Ne(e),qe=e=>{const t=e;return typeof t=="object"&&t!==null&&"data"in t},$e=e=>{const t=e;return qe(e)&&t.meta?.hasError||!1},Fe={"SHA-256":32,"SHA-512":64},Se=["SHA-256","SHA-512"];function be(e){if(typeof e=="string")return e;const t=e();return typeof t=="string"?t:(console.error("ASSERTION FAIL VALUE",t),"Assertion Failed")}function ce(e,t="Assertion failed"){if(!e)throw new Error(be(t))}const ze=(e,t,r=()=>(console.error(e,t),`Assertion failed: ${JSON.stringify(e)} is not equal to ${JSON.stringify(t)}`))=>{throw new Error("assertEqualElements: Bitrotted")},Pt=(e,t,r=()=>(console.error(e,t),`Assertion failed: ${JSON.stringify(e)} is not equal to ${JSON.stringify(t)}`))=>Array.isArray(e)&&Array.isArray(t)?ze(e,t,r):ce(e===t,r),_t=(e,t,r=()=>(console.error(e,t),`Assertion failed: ${JSON.stringify(e)} is equal to ${JSON.stringify(t)}`))=>ce(e!==t,r);function Rt(e,t,r="Assertion failed: Required value is not of correct type"){if(!t(e))throw new Error(be(r));return e}function Lt(e,t="Assertion failed: Reached what should be an unreachable section of code"){throw new Error(be(t))}function Dt(e){return e!=null&&!Number.isNaN(e)}function jt(e,t="Assertion failed: Required value not defined"){return ce(Dt(e),t),e}const W={assert:ce,assertUnreachable:Lt,assertValue:jt,assertEqual:Pt,assertNotEqual:_t,assertEqualElements:ze,assertType:Rt},me=e=>{const t=e.flatMap(r=>typeof r=="number"?[r]:JSON.stringify(r).split("").map(n=>n.codePointAt(0)));return new Float64Array(t.length).map((r,n)=>t[n])},ee=async e=>e instanceof ArrayBuffer?e:e instanceof Blob?e.arrayBuffer():typeof e=="string"?new TextEncoder().encode(e):ArrayBuffer.isView(e)?e.buffer:Array.isArray(e)?me(e):new ArrayBuffer(0),ue=async({bytes:e,algorithm:t="SHA-512"})=>{const r=await ee(e);return crypto.subtle.digest(t,r)},Je=async(e,t=16)=>{const r=await ee(e);return[...new Uint8Array(r)].map(n=>n.toString(t).padStart(2,"0")).join("")},le=async({bytes:e,algorithm:t="SHA-512",radix:r=16})=>{const n=await ue({bytes:e,algorithm:t}),i=await Je(n,r);return`${t}:${i}`},Vt=({id:e})=>{const t=e.split(":");W.assert(t.length===2);const[r,n]=t,i=atob(n),c=new Uint8Array(i.length);return i.split("").map(u=>u.charCodeAt(0)).forEach((u,y)=>{c[y]=u}),c},He=async e=>{if(typeof e=="string")return e;const t=await ee(e);return new TextDecoder().decode(t)},ne=[];ne.push(async()=>{const e="test",t=await ee(e),r=await He(t);return W.assertEqual(e,r)}),ne.push(async()=>Se.map(async e=>{const t=await ue({bytes:"test",algorithm:e});return W.assertEqual(t.byteLength,Fe[e])})),ne.push(async()=>{{const e=await le({bytes:"test",algorithm:"SHA-256"});W.assertEqual(e,"SHA-256:n4bQgYhMfWWaL+qgxVrQFaO/TxsrC4Is0V1sFbDwCgg=")}{const e=await le({bytes:"test",algorithm:"SHA-512"});W.assertEqual(e,"SHA-512:7iaw3Ur350mqGo7jwQrpkj9hiYB3Lkc/iBml1JQODbJ6wYX4oOHV+E+IvIh/1nsUNzLDBMxfqa2Ob1f1ACio/w==")}}),ne.push(async()=>Se.map(async e=>{const t="test",r=await le({bytes:t,algorithm:e}),n=new Uint8Array(await ue({bytes:t,algorithm:e})),i=Vt({id:r});return W.assertEqualElements(i,n)}));const Ct=async()=>{if((await Promise.all(ne.map(async t=>{try{return await t(),!0}catch(r){return console.error(r),!1}}))).find(t=>t===!1))throw new Error("TESTS FAILED");return console.log("TESTS PASS"),!0};function Ae(e){const t=new Uint8Array(e.slice(0));let r="";for(let n=0;n<t.length;n++)r+=String.fromCharCode(t[n]);return btoa(r)}const Nt=e=>{const t=new Uint8Array(e),r=[];for(let n=0;n<t.length;++n)r.push(t[n].toString(16).padStart(2,"0"));return r.join("")},qt=e=>new TextDecoder().decode(new Uint8Array(e)),$t=(e,t)=>e.slice(0,e.size,t),Ft=e=>{const t=globalThis.atob(e),r=t.length,n=new Uint8Array(r);for(let i=0;i<r;i++)n[i]=t.charCodeAt(i);return n.buffer},zt=e=>{if(!e)return;const t=e.split(","),n=(t[0].match(/:(.*?);/)??[])[1],i=atob(t[1]);let c=i.length;const u=new Uint8Array(c);for(;c--;)u[c]=i.charCodeAt(c);return new Blob([u],{type:n})},Be=e=>e instanceof ArrayBuffer?e:typeof e=="string"?new TextEncoder().encode(e):ArrayBuffer.isView(e)?e.buffer:Array.isArray(e)?me(e):new ArrayBuffer(0),Jt=async(e,t)=>{const r=Be(e);return crypto.subtle.digest(t,r)},Ee=e=>{const t=e;return!!(t instanceof ArrayBuffer||typeof t=="string"||ArrayBuffer.isView(t)||Array.isArray(t))},Ht=e=>e instanceof Blob?!0:Ee(e),Qt=e=>{if(typeof e=="string")return e.length;if(e instanceof Blob)return e.size;if(e instanceof ArrayBuffer||ArrayBuffer.isView(e))return e.byteLength};var Ue;try{Ue=new TextDecoder}catch{}var x,z,s=0,I={},E,Y,$=0,J=0,D,Q,q=[],A,Qe={useRecords:!1,mapsAsObjects:!0};class Ye{}const ve=new Ye;ve.name="MessagePack 0xC1";var v=!1,Ge=2,Yt;try{new Function("")}catch{Ge=1/0}class ie{constructor(t){t&&(t.useRecords===!1&&t.mapsAsObjects===void 0&&(t.mapsAsObjects=!0),t.sequential&&t.trusted!==!1&&(t.trusted=!0,!t.structures&&t.useRecords!=!1&&(t.structures=[],t.maxSharedStructures||(t.maxSharedStructures=0))),t.structures?t.structures.sharedLength=t.structures.length:t.getStructures&&((t.structures=[]).uninitialized=!0,t.structures.sharedLength=0),t.int64AsNumber&&(t.int64AsType="number")),Object.assign(this,t)}unpack(t,r){if(x)return at(()=>(Me(),this?this.unpack(t,r):ie.prototype.unpack.call(Qe,t,r)));!t.buffer&&t.constructor===ArrayBuffer&&(t=typeof Buffer<"u"?Buffer.from(t):new Uint8Array(t)),typeof r=="object"?(z=r.end||t.length,s=r.start||0):(s=0,z=r>-1?r:t.length),J=0,Y=null,D=null,x=t;try{A=t.dataView||(t.dataView=new DataView(t.buffer,t.byteOffset,t.byteLength))}catch(n){throw x=null,t instanceof Uint8Array?n:new Error("Source must be a Uint8Array or Buffer but was a "+(t&&typeof t=="object"?t.constructor.name:typeof t))}if(this instanceof ie){if(I=this,this.structures)return E=this.structures,de(r);(!E||E.length>0)&&(E=[])}else I=Qe,(!E||E.length>0)&&(E=[]);return de(r)}unpackMultiple(t,r){let n,i=0;try{v=!0;let c=t.length,u=this?this.unpack(t,c):xe.unpack(t,c);if(r){if(r(u,i,s)===!1)return;for(;s<c;)if(i=s,r(de(),i,s)===!1)return}else{for(n=[u];s<c;)i=s,n.push(de());return n}}catch(c){throw c.lastPosition=i,c.values=n,c}finally{v=!1,Me()}}_mergeStructures(t,r){t=t||[],Object.isFrozen(t)&&(t=t.map(n=>n.slice(0)));for(let n=0,i=t.length;n<i;n++){let c=t[n];c&&(c.isShared=!0,n>=32&&(c.highByte=n-32>>5))}t.sharedLength=t.length;for(let n in r||[])if(n>=0){let i=t[n],c=r[n];c&&(i&&((t.restoreStructures||(t.restoreStructures=[]))[n]=i),t[n]=c)}return this.structures=t}decode(t,r){return this.unpack(t,r)}}function de(e){try{if(!I.trusted&&!v){let r=E.sharedLength||0;r<E.length&&(E.length=r)}let t;if(I.randomAccessStructure&&x[s]<64&&x[s]>=32&&Yt||(t=R()),D&&(s=D.postBundlePosition,D=null),v&&(E.restoreStructures=null),s==z)E&&E.restoreStructures&&Ke(),E=null,x=null,Q&&(Q=null);else{if(s>z)throw new Error("Unexpected end of MessagePack data");if(!v){let r;try{r=JSON.stringify(t,(n,i)=>typeof i=="bigint"?`${i}n`:i).slice(0,100)}catch(n){r="(JSON view not available "+n+")"}throw new Error("Data read, but end of buffer not reached "+r)}}return t}catch(t){throw E&&E.restoreStructures&&Ke(),Me(),(t instanceof RangeError||t.message.startsWith("Unexpected end of buffer")||s>z)&&(t.incomplete=!0),t}}function Ke(){for(let e in E.restoreStructures)E[e]=E.restoreStructures[e];E.restoreStructures=null}function R(){let e=x[s++];if(e<160)if(e<128){if(e<64)return e;{let t=E[e&63]||I.getStructures&&Xe()[e&63];return t?(t.read||(t.read=Te(t,e&63)),t.read()):e}}else if(e<144)if(e-=128,I.mapsAsObjects){let t={};for(let r=0;r<e;r++){let n=it();n==="__proto__"&&(n="__proto_"),t[n]=R()}return t}else{let t=new Map;for(let r=0;r<e;r++)t.set(R(),R());return t}else{e-=144;let t=new Array(e);for(let r=0;r<e;r++)t[r]=R();return I.freezeData?Object.freeze(t):t}else if(e<192){let t=e-160;if(J>=s)return Y.slice(s-$,(s+=t)-$);if(J==0&&z<140){let r=t<16?Oe(t):tt(t);if(r!=null)return r}return ke(t)}else{let t;switch(e){case 192:return null;case 193:return D?(t=R(),t>0?D[1].slice(D.position1,D.position1+=t):D[0].slice(D.position0,D.position0-=t)):ve;case 194:return!1;case 195:return!0;case 196:if(t=x[s++],t===void 0)throw new Error("Unexpected end of buffer");return Ie(t);case 197:return t=A.getUint16(s),s+=2,Ie(t);case 198:return t=A.getUint32(s),s+=4,Ie(t);case 199:return X(x[s++]);case 200:return t=A.getUint16(s),s+=2,X(t);case 201:return t=A.getUint32(s),s+=4,X(t);case 202:if(t=A.getFloat32(s),I.useFloat32>2){let r=Pe[(x[s]&127)<<1|x[s+1]>>7];return s+=4,(r*t+(t>0?.5:-.5)>>0)/r}return s+=4,t;case 203:return t=A.getFloat64(s),s+=8,t;case 204:return x[s++];case 205:return t=A.getUint16(s),s+=2,t;case 206:return t=A.getUint32(s),s+=4,t;case 207:return I.int64AsType==="number"?(t=A.getUint32(s)*4294967296,t+=A.getUint32(s+4)):I.int64AsType==="string"?t=A.getBigUint64(s).toString():I.int64AsType==="auto"?(t=A.getBigUint64(s),t<=BigInt(2)<<BigInt(52)&&(t=Number(t))):t=A.getBigUint64(s),s+=8,t;case 208:return A.getInt8(s++);case 209:return t=A.getInt16(s),s+=2,t;case 210:return t=A.getInt32(s),s+=4,t;case 211:return I.int64AsType==="number"?(t=A.getInt32(s)*4294967296,t+=A.getUint32(s+4)):I.int64AsType==="string"?t=A.getBigInt64(s).toString():I.int64AsType==="auto"?(t=A.getBigInt64(s),t>=BigInt(-2)<<BigInt(52)&&t<=BigInt(2)<<BigInt(52)&&(t=Number(t))):t=A.getBigInt64(s),s+=8,t;case 212:if(t=x[s++],t==114)return ft(x[s++]&63);{let r=q[t];if(r)return r.read?(s++,r.read(R())):r.noBuffer?(s++,r()):r(x.subarray(s,++s));throw new Error("Unknown extension "+t)}case 213:return t=x[s],t==114?(s++,ft(x[s++]&63,x[s++])):X(2);case 214:return X(4);case 215:return X(8);case 216:return X(16);case 217:return t=x[s++],J>=s?Y.slice(s-$,(s+=t)-$):Gt(t);case 218:return t=A.getUint16(s),s+=2,J>=s?Y.slice(s-$,(s+=t)-$):Kt(t);case 219:return t=A.getUint32(s),s+=4,J>=s?Y.slice(s-$,(s+=t)-$):Zt(t);case 220:return t=A.getUint16(s),s+=2,We(t);case 221:return t=A.getUint32(s),s+=4,We(t);case 222:return t=A.getUint16(s),s+=2,et(t);case 223:return t=A.getUint32(s),s+=4,et(t);default:if(e>=224)return e-256;if(e===void 0){let r=new Error("Unexpected end of MessagePack data");throw r.incomplete=!0,r}throw new Error("Unknown MessagePack token "+e)}}}const vt=/^[a-zA-Z_$][a-zA-Z\d_$]*$/;function Te(e,t){function r(){if(r.count++>Ge){let i=e.read=new Function("r","return function(){return "+(I.freezeData?"Object.freeze":"")+"({"+e.map(c=>c==="__proto__"?"__proto_:r()":vt.test(c)?c+":r()":"["+JSON.stringify(c)+"]:r()").join(",")+"})}")(R);return e.highByte===0&&(e.read=Ze(t,e.read)),i()}let n={};for(let i=0,c=e.length;i<c;i++){let u=e[i];u==="__proto__"&&(u="__proto_"),n[u]=R()}return I.freezeData?Object.freeze(n):n}return r.count=0,e.highByte===0?Ze(t,r):r}const Ze=(e,t)=>function(){let r=x[s++];if(r===0)return t();let n=e<32?-(e+(r<<5)):e+(r<<5),i=E[n]||Xe()[n];if(!i)throw new Error("Record id is not defined for "+n);return i.read||(i.read=Te(i,e)),i.read()};function Xe(){let e=at(()=>(x=null,I.getStructures()));return E=I._mergeStructures(e,E)}var ke=se,Gt=se,Kt=se,Zt=se;function se(e){let t;if(e<16&&(t=Oe(e)))return t;if(e>64&&Ue)return Ue.decode(x.subarray(s,s+=e));const r=s+e,n=[];for(t="";s<r;){const i=x[s++];if((i&128)===0)n.push(i);else if((i&224)===192){const c=x[s++]&63;n.push((i&31)<<6|c)}else if((i&240)===224){const c=x[s++]&63,u=x[s++]&63;n.push((i&31)<<12|c<<6|u)}else if((i&248)===240){const c=x[s++]&63,u=x[s++]&63,y=x[s++]&63;let w=(i&7)<<18|c<<12|u<<6|y;w>65535&&(w-=65536,n.push(w>>>10&1023|55296),w=56320|w&1023),n.push(w)}else n.push(i);n.length>=4096&&(t+=j.apply(String,n),n.length=0)}return n.length>0&&(t+=j.apply(String,n)),t}function We(e){let t=new Array(e);for(let r=0;r<e;r++)t[r]=R();return I.freezeData?Object.freeze(t):t}function et(e){if(I.mapsAsObjects){let t={};for(let r=0;r<e;r++){let n=it();n==="__proto__"&&(n="__proto_"),t[n]=R()}return t}else{let t=new Map;for(let r=0;r<e;r++)t.set(R(),R());return t}}var j=String.fromCharCode;function tt(e){let t=s,r=new Array(e);for(let n=0;n<e;n++){const i=x[s++];if((i&128)>0){s=t;return}r[n]=i}return j.apply(String,r)}function Oe(e){if(e<4)if(e<2){if(e===0)return"";{let t=x[s++];if((t&128)>1){s-=1;return}return j(t)}}else{let t=x[s++],r=x[s++];if((t&128)>0||(r&128)>0){s-=2;return}if(e<3)return j(t,r);let n=x[s++];if((n&128)>0){s-=3;return}return j(t,r,n)}else{let t=x[s++],r=x[s++],n=x[s++],i=x[s++];if((t&128)>0||(r&128)>0||(n&128)>0||(i&128)>0){s-=4;return}if(e<6){if(e===4)return j(t,r,n,i);{let c=x[s++];if((c&128)>0){s-=5;return}return j(t,r,n,i,c)}}else if(e<8){let c=x[s++],u=x[s++];if((c&128)>0||(u&128)>0){s-=6;return}if(e<7)return j(t,r,n,i,c,u);let y=x[s++];if((y&128)>0){s-=7;return}return j(t,r,n,i,c,u,y)}else{let c=x[s++],u=x[s++],y=x[s++],w=x[s++];if((c&128)>0||(u&128)>0||(y&128)>0||(w&128)>0){s-=8;return}if(e<10){if(e===8)return j(t,r,n,i,c,u,y,w);{let B=x[s++];if((B&128)>0){s-=9;return}return j(t,r,n,i,c,u,y,w,B)}}else if(e<12){let B=x[s++],S=x[s++];if((B&128)>0||(S&128)>0){s-=10;return}if(e<11)return j(t,r,n,i,c,u,y,w,B,S);let b=x[s++];if((b&128)>0){s-=11;return}return j(t,r,n,i,c,u,y,w,B,S,b)}else{let B=x[s++],S=x[s++],b=x[s++],M=x[s++];if((B&128)>0||(S&128)>0||(b&128)>0||(M&128)>0){s-=12;return}if(e<14){if(e===12)return j(t,r,n,i,c,u,y,w,B,S,b,M);{let L=x[s++];if((L&128)>0){s-=13;return}return j(t,r,n,i,c,u,y,w,B,S,b,M,L)}}else{let L=x[s++],F=x[s++];if((L&128)>0||(F&128)>0){s-=14;return}if(e<15)return j(t,r,n,i,c,u,y,w,B,S,b,M,L,F);let V=x[s++];if((V&128)>0){s-=15;return}return j(t,r,n,i,c,u,y,w,B,S,b,M,L,F,V)}}}}}function rt(){let e=x[s++],t;if(e<192)t=e-160;else switch(e){case 217:t=x[s++];break;case 218:t=A.getUint16(s),s+=2;break;case 219:t=A.getUint32(s),s+=4;break;default:throw new Error("Expected string")}return se(t)}function Ie(e){return I.copyBuffers?Uint8Array.prototype.slice.call(x,s,s+=e):x.subarray(s,s+=e)}function X(e){let t=x[s++];if(q[t]){let r;return q[t](x.subarray(s,r=s+=e),n=>{s=n;try{return R()}finally{s=r}})}else throw new Error("Unknown extension type "+t)}var nt=new Array(4096);function it(){let e=x[s++];if(e>=160&&e<192){if(e=e-160,J>=s)return Y.slice(s-$,(s+=e)-$);if(!(J==0&&z<180))return ke(e)}else return s--,st(R());let t=(e<<5^(e>1?A.getUint16(s):e>0?x[s]:0))&4095,r=nt[t],n=s,i=s+e-3,c,u=0;if(r&&r.bytes==e){for(;n<i;){if(c=A.getUint32(n),c!=r[u++]){n=1879048192;break}n+=4}for(i+=3;n<i;)if(c=x[n++],c!=r[u++]){n=1879048192;break}if(n===i)return s=n,r.string;i-=3,n=s}for(r=[],nt[t]=r,r.bytes=e;n<i;)c=A.getUint32(n),r.push(c),n+=4;for(i+=3;n<i;)c=x[n++],r.push(c);let y=e<16?Oe(e):tt(e);return y!=null?r.string=y:r.string=ke(e)}function st(e){if(typeof e=="string")return e;if(typeof e=="number"||typeof e=="boolean"||typeof e=="bigint")return e.toString();if(e==null)return e+"";throw new Error("Invalid property type for record",typeof e)}const ft=(e,t)=>{let r=R().map(st),n=e;t!==void 0&&(e=e<32?-((t<<5)+e):(t<<5)+e,r.highByte=t);let i=E[e];return i&&(i.isShared||v)&&((E.restoreStructures||(E.restoreStructures=[]))[e]=i),E[e]=r,r.read=Te(r,n),r.read()};q[0]=()=>{},q[0].noBuffer=!0,q[66]=e=>{let t=e.length,r=BigInt(e[0]&128?e[0]-256:e[0]);for(let n=1;n<t;n++)r<<=BigInt(8),r+=BigInt(e[n]);return r};let Xt={Error,TypeError,ReferenceError};q[101]=()=>{let e=R();return(Xt[e[0]]||Error)(e[1],{cause:e[2]})},q[105]=e=>{if(I.structuredClone===!1)throw new Error("Structured clone extension is disabled");let t=A.getUint32(s-4);Q||(Q=new Map);let r=x[s],n;r>=144&&r<160||r==220||r==221?n=[]:n={};let i={target:n};Q.set(t,i);let c=R();return i.used?Object.assign(n,c):(i.target=c,c)},q[112]=e=>{if(I.structuredClone===!1)throw new Error("Structured clone extension is disabled");let t=A.getUint32(s-4),r=Q.get(t);return r.used=!0,r.target},q[115]=()=>new Set(R());const ot=["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].map(e=>e+"Array");let Wt=typeof globalThis=="object"?globalThis:window;q[116]=e=>{let t=e[0],r=ot[t];if(!r){if(t===16){let n=new ArrayBuffer(e.length-1);return new Uint8Array(n).set(e.subarray(1)),n}throw new Error("Could not find typed array for code "+t)}return new Wt[r](Uint8Array.prototype.slice.call(e,1).buffer)},q[120]=()=>{let e=R();return new RegExp(e[0],e[1])};const er=[];q[98]=e=>{let t=(e[0]<<24)+(e[1]<<16)+(e[2]<<8)+e[3],r=s;return s+=t-e.length,D=er,D=[rt(),rt()],D.position0=0,D.position1=0,D.postBundlePosition=s,s=r,R()},q[255]=e=>e.length==4?new Date((e[0]*16777216+(e[1]<<16)+(e[2]<<8)+e[3])*1e3):e.length==8?new Date(((e[0]<<22)+(e[1]<<14)+(e[2]<<6)+(e[3]>>2))/1e6+((e[3]&3)*4294967296+e[4]*16777216+(e[5]<<16)+(e[6]<<8)+e[7])*1e3):e.length==12?new Date(((e[0]<<24)+(e[1]<<16)+(e[2]<<8)+e[3])/1e6+((e[4]&128?-281474976710656:0)+e[6]*1099511627776+e[7]*4294967296+e[8]*16777216+(e[9]<<16)+(e[10]<<8)+e[11])*1e3):new Date("invalid");function at(e){let t=z,r=s,n=$,i=J,c=Y,u=Q,y=D,w=new Uint8Array(x.slice(0,z)),B=E,S=E.slice(0,E.length),b=I,M=v,L=e();return z=t,s=r,$=n,J=i,Y=c,Q=u,D=y,x=w,v=M,E=B,E.splice(0,E.length,...S),I=b,A=new DataView(x.buffer,x.byteOffset,x.byteLength),L}function Me(){x=null,Q=null,E=null}const Pe=new Array(147);for(let e=0;e<256;e++)Pe[e]=+("1e"+Math.floor(45.15-e*.30103));var xe=new ie({useRecords:!1});xe.unpack,xe.unpackMultiple,xe.unpack;let tr=new Float32Array(1);new Uint8Array(tr.buffer,0,4);let ge;try{ge=new TextEncoder}catch{}let _e,ct;const he=typeof Buffer<"u",ye=he?function(e){return Buffer.allocUnsafeSlow(e)}:Uint8Array,ut=he?Buffer:Uint8Array,lt=he?4294967296:2144337920;let o,fe,O,f=0,C,P=null,rr;const nr=21760,ir=/[\u0080-\uFFFF]/,te=Symbol("record-id");class Re extends ie{constructor(t){super(t),this.offset=0;let r,n,i,c,u=ut.prototype.utf8Write?function(a,h){return o.utf8Write(a,h,o.byteLength-h)}:ge&&ge.encodeInto?function(a,h){return ge.encodeInto(a,o.subarray(h)).written}:!1,y=this;t||(t={});let w=t&&t.sequential,B=t.structures||t.saveStructures,S=t.maxSharedStructures;if(S==null&&(S=B?32:0),S>8160)throw new Error("Maximum maxSharedStructure is 8160");t.structuredClone&&t.moreTypes==null&&(this.moreTypes=!0);let b=t.maxOwnStructures;b==null&&(b=B?32:64),!this.structures&&t.useRecords!=!1&&(this.structures=[]);let M=S>32||b+S>64,L=S+64,F=S+b+64;if(F>8256)throw new Error("Maximum maxSharedStructure + maxOwnStructure is 8192");let V=[],oe=0,we=0;this.pack=this.encode=function(a,h){if(o||(o=new ye(8192),O=o.dataView||(o.dataView=new DataView(o.buffer,0,8192)),f=0),C=o.length-10,C-f<2048?(o=new ye(o.length),O=o.dataView||(o.dataView=new DataView(o.buffer,0,o.length)),C=o.length-10,f=0):f=f+7&2147483640,r=f,h&ur&&(f+=h&255),c=y.structuredClone?new Map:null,y.bundleStrings&&typeof a!="string"?(P=[],P.size=1/0):P=null,i=y.structures,i){i.uninitialized&&(i=y._mergeStructures(y.getStructures()));let l=i.sharedLength||0;if(l>S)throw new Error("Shared structures is larger than maximum shared structures, try increasing maxSharedStructures to "+i.sharedLength);if(!i.transitions){i.transitions=Object.create(null);for(let g=0;g<l;g++){let p=i[g];if(!p)continue;let U,m=i.transitions;for(let T=0,k=p.length;T<k;T++){let H=p[T];U=m[H],U||(U=m[H]=Object.create(null)),m=U}m[te]=g+64}this.lastNamedStructuresLength=l}w||(i.nextId=l+64)}n&&(n=!1);let d;try{y.randomAccessStructure&&a&&a.constructor&&a.constructor===Object?Br(a):_(a);let l=P;if(P&&gt(r,_,0),c&&c.idsToInsert){let g=c.idsToInsert.sort((T,k)=>T.offset>k.offset?1:-1),p=g.length,U=-1;for(;l&&p>0;){let T=g[--p].offset+r;T<l.stringsPosition+r&&U===-1&&(U=0),T>l.position+r?U>=0&&(U+=6):(U>=0&&(O.setUint32(l.position+r,O.getUint32(l.position+r)+U),U=-1),l=l.previous,p++)}U>=0&&l&&O.setUint32(l.position+r,O.getUint32(l.position+r)+U),f+=g.length*6,f>C&&K(f),y.offset=f;let m=fr(o.subarray(r,f),g);return c=null,m}return y.offset=f,h&ar?(o.start=r,o.end=f,o):o.subarray(r,f)}catch(l){throw d=l,l}finally{if(i&&(Ut(),n&&y.saveStructures)){let l=i.sharedLength||0,g=o.subarray(r,f),p=or(i,y);if(!d)return y.saveStructures(p,p.isCompatible)===!1?y.pack(a,h):(y.lastNamedStructuresLength=l,o.length>1073741824&&(o=null),g)}o.length>1073741824&&(o=null),h&cr&&(f=r)}};const Ut=()=>{we<10&&we++;let a=i.sharedLength||0;if(i.length>a&&!w&&(i.length=a),oe>1e4)i.transitions=null,we=0,oe=0,V.length>0&&(V=[]);else if(V.length>0&&!w){for(let h=0,d=V.length;h<d;h++)V[h][te]=0;V=[]}},je=a=>{var h=a.length;h<16?o[f++]=144|h:h<65536?(o[f++]=220,o[f++]=h>>8,o[f++]=h&255):(o[f++]=221,O.setUint32(f,h),f+=4);for(let d=0;d<h;d++)_(a[d])},_=a=>{f>C&&(o=K(f));var h=typeof a,d;if(h==="string"){let l=a.length;if(P&&l>=4&&l<4096){if((P.size+=l)>nr){let m,T=(P[0]?P[0].length*3+P[1].length:0)+10;f+T>C&&(o=K(f+T));let k;P.position?(k=P,o[f]=200,f+=3,o[f++]=98,m=f-r,f+=4,gt(r,_,0),O.setUint16(m+r-3,f-r-m)):(o[f++]=214,o[f++]=98,m=f-r,f+=4),P=["",""],P.previous=k,P.size=0,P.position=m}let U=ir.test(a);P[U?0:1]+=a,o[f++]=193,_(U?-l:l);return}let g;l<32?g=1:l<256?g=2:l<65536?g=3:g=5;let p=l*3;if(f+p>C&&(o=K(f+p)),l<64||!u){let U,m,T,k=f+g;for(U=0;U<l;U++)m=a.charCodeAt(U),m<128?o[k++]=m:m<2048?(o[k++]=m>>6|192,o[k++]=m&63|128):(m&64512)===55296&&((T=a.charCodeAt(U+1))&64512)===56320?(m=65536+((m&1023)<<10)+(T&1023),U++,o[k++]=m>>18|240,o[k++]=m>>12&63|128,o[k++]=m>>6&63|128,o[k++]=m&63|128):(o[k++]=m>>12|224,o[k++]=m>>6&63|128,o[k++]=m&63|128);d=k-f-g}else d=u(a,f+g);d<32?o[f++]=160|d:d<256?(g<2&&o.copyWithin(f+2,f+1,f+1+d),o[f++]=217,o[f++]=d):d<65536?(g<3&&o.copyWithin(f+3,f+2,f+2+d),o[f++]=218,o[f++]=d>>8,o[f++]=d&255):(g<5&&o.copyWithin(f+5,f+3,f+3+d),o[f++]=219,O.setUint32(f,d),f+=4),f+=d}else if(h==="number")if(a>>>0===a)a<32||a<128&&this.useRecords===!1||a<64&&!this.randomAccessStructure?o[f++]=a:a<256?(o[f++]=204,o[f++]=a):a<65536?(o[f++]=205,o[f++]=a>>8,o[f++]=a&255):(o[f++]=206,O.setUint32(f,a),f+=4);else if(a>>0===a)a>=-32?o[f++]=256+a:a>=-128?(o[f++]=208,o[f++]=a+256):a>=-32768?(o[f++]=209,O.setInt16(f,a),f+=2):(o[f++]=210,O.setInt32(f,a),f+=4);else{let l;if((l=this.useFloat32)>0&&a<4294967296&&a>=-2147483648){o[f++]=202,O.setFloat32(f,a);let g;if(l<4||(g=a*Pe[(o[f]&127)<<1|o[f+1]>>7])>>0===g){f+=4;return}else f--}o[f++]=203,O.setFloat64(f,a),f+=8}else if(h==="object"||h==="function")if(!a)o[f++]=192;else{if(c){let g=c.get(a);if(g){if(!g.id){let p=c.idsToInsert||(c.idsToInsert=[]);g.id=p.push(g)}o[f++]=214,o[f++]=112,O.setUint32(f,g.id),f+=4;return}else c.set(a,{offset:f-r})}let l=a.constructor;if(l===Object)pe(a);else if(l===Array)je(a);else if(l===Map)if(this.mapAsEmptyObject)o[f++]=128;else{d=a.size,d<16?o[f++]=128|d:d<65536?(o[f++]=222,o[f++]=d>>8,o[f++]=d&255):(o[f++]=223,O.setUint32(f,d),f+=4);for(let[g,p]of a)_(g),_(p)}else{for(let g=0,p=_e.length;g<p;g++){let U=ct[g];if(a instanceof U){let m=_e[g];if(m.write){m.type&&(o[f++]=212,o[f++]=m.type,o[f++]=0);let ae=m.write.call(this,a);ae===a?Array.isArray(a)?je(a):pe(a):_(ae);return}let T=o,k=O,H=f;o=null;let Z;try{Z=m.pack.call(this,a,ae=>(o=T,T=null,f+=ae,f>C&&K(f),{target:o,targetView:O,position:f-ae}),_)}finally{T&&(o=T,O=k,f=H,C=o.length-10)}Z&&(Z.length+f>C&&K(Z.length+f),f=sr(Z,o,f,m.type));return}}if(Array.isArray(a))je(a);else{if(a.toJSON){const g=a.toJSON();if(g!==a)return _(g)}if(h==="function")return _(this.writeFunction&&this.writeFunction(a));pe(a)}}}else if(h==="boolean")o[f++]=a?195:194;else if(h==="bigint"){if(a<BigInt(1)<<BigInt(63)&&a>=-(BigInt(1)<<BigInt(63)))o[f++]=211,O.setBigInt64(f,a);else if(a<BigInt(1)<<BigInt(64)&&a>0)o[f++]=207,O.setBigUint64(f,a);else if(this.largeBigIntToFloat)o[f++]=203,O.setFloat64(f,Number(a));else{if(this.largeBigIntToString)return _(a.toString());if(this.useBigIntExtension&&a<BigInt(2)**BigInt(1023)&&a>-(BigInt(2)**BigInt(1023))){o[f++]=199,f++,o[f++]=66;let l=[],g;do{let p=a&BigInt(255);g=(p&BigInt(128))===(a<BigInt(0)?BigInt(128):BigInt(0)),l.push(p),a>>=BigInt(8)}while(!((a===BigInt(0)||a===BigInt(-1))&&g));o[f-2]=l.length;for(let p=l.length;p>0;)o[f++]=Number(l[--p]);return}else throw new RangeError(a+" was too large to fit in MessagePack 64-bit integer format, use useBigIntExtension, or set largeBigIntToFloat to convert to float-64, or set largeBigIntToString to convert to string")}f+=8}else if(h==="undefined")this.encodeUndefinedAsNil?o[f++]=192:(o[f++]=212,o[f++]=0,o[f++]=0);else throw new Error("Unknown type: "+h)},Tt=this.variableMapSize||this.coercibleKeyAsNumber||this.skipValues?a=>{let h;if(this.skipValues){h=[];for(let g in a)(typeof a.hasOwnProperty!="function"||a.hasOwnProperty(g))&&!this.skipValues.includes(a[g])&&h.push(g)}else h=Object.keys(a);let d=h.length;d<16?o[f++]=128|d:d<65536?(o[f++]=222,o[f++]=d>>8,o[f++]=d&255):(o[f++]=223,O.setUint32(f,d),f+=4);let l;if(this.coercibleKeyAsNumber)for(let g=0;g<d;g++){l=h[g];let p=Number(l);_(isNaN(p)?l:p),_(a[l])}else for(let g=0;g<d;g++)_(l=h[g]),_(a[l])}:a=>{o[f++]=222;let h=f-r;f+=2;let d=0;for(let l in a)(typeof a.hasOwnProperty!="function"||a.hasOwnProperty(l))&&(_(l),_(a[l]),d++);if(d>65535)throw new Error('Object is too large to serialize with fast 16-bit map size, use the "variableMapSize" option to serialize this object');o[h+++r]=d>>8,o[h+r]=d&255},kt=this.useRecords===!1?Tt:t.progressiveRecords&&!M?a=>{let h,d=i.transitions||(i.transitions=Object.create(null)),l=f++-r,g;for(let p in a)if(typeof a.hasOwnProperty!="function"||a.hasOwnProperty(p)){if(h=d[p],h)d=h;else{let U=Object.keys(a),m=d;d=i.transitions;let T=0;for(let k=0,H=U.length;k<H;k++){let Z=U[k];h=d[Z],h||(h=d[Z]=Object.create(null),T++),d=h}l+r+1==f?(f--,Ve(d,U,T)):It(d,U,l,T),g=!0,d=m[p]}_(a[p])}if(!g){let p=d[te];p?o[l+r]=p:It(d,Object.keys(a),l,0)}}:a=>{let h,d=i.transitions||(i.transitions=Object.create(null)),l=0;for(let p in a)(typeof a.hasOwnProperty!="function"||a.hasOwnProperty(p))&&(h=d[p],h||(h=d[p]=Object.create(null),l++),d=h);let g=d[te];g?g>=96&&M?(o[f++]=((g-=96)&31)+96,o[f++]=g>>5):o[f++]=g:Ve(d,d.__keys__||Object.keys(a),l);for(let p in a)(typeof a.hasOwnProperty!="function"||a.hasOwnProperty(p))&&_(a[p])},Ot=typeof this.useRecords=="function"&&this.useRecords,pe=Ot?a=>{Ot(a)?kt(a):Tt(a)}:kt,K=a=>{let h;if(a>16777216){if(a-r>lt)throw new Error("Packed buffer would be larger than maximum buffer size");h=Math.min(lt,Math.round(Math.max((a-r)*(a>67108864?1.25:2),4194304)/4096)*4096)}else h=(Math.max(a-r<<2,o.length-1)>>12)+1<<12;let d=new ye(h);return O=d.dataView||(d.dataView=new DataView(d.buffer,0,h)),a=Math.min(a,o.length),o.copy?o.copy(d,0,r,a):d.set(o.slice(r,a)),f-=r,r=0,C=d.length-10,o=d},Ve=(a,h,d)=>{let l=i.nextId;l||(l=64),l<L&&this.shouldShareStructure&&!this.shouldShareStructure(h)?(l=i.nextOwnId,l<F||(l=L),i.nextOwnId=l+1):(l>=F&&(l=L),i.nextId=l+1);let g=h.highByte=l>=96&&M?l-96>>5:-1;a[te]=l,a.__keys__=h,i[l-64]=h,l<L?(h.isShared=!0,i.sharedLength=l-63,n=!0,g>=0?(o[f++]=(l&31)+96,o[f++]=g):o[f++]=l):(g>=0?(o[f++]=213,o[f++]=114,o[f++]=(l&31)+96,o[f++]=g):(o[f++]=212,o[f++]=114,o[f++]=l),d&&(oe+=we*d),V.length>=b&&(V.shift()[te]=0),V.push(a),_(h))},It=(a,h,d,l)=>{let g=o,p=f,U=C,m=r;o=fe,f=0,r=0,o||(fe=o=new ye(8192)),C=o.length-10,Ve(a,h,l),fe=o;let T=f;if(o=g,f=p,C=U,r=m,T>1){let k=f+T-1;k>C&&K(k);let H=d+r;o.copyWithin(H+T,H+1,f),o.set(fe.slice(0,T),H),f=k}else o[d+r]=fe[0]},Br=a=>{let h=rr(a,o,r,f,i,K,(d,l,g)=>{if(g)return n=!0;f=l;let p=o;return _(d),Ut(),p!==o?{position:f,targetView:O,target:o}:f},this);if(h===0)return pe(a);f=h}}useBuffer(t){o=t,o.dataView||(o.dataView=new DataView(o.buffer,o.byteOffset,o.byteLength)),f=0}set position(t){f=t}get position(){return f}clearSharedData(){this.structures&&(this.structures=[]),this.typedStructs&&(this.typedStructs=[])}}ct=[Date,Set,Error,RegExp,ArrayBuffer,Object.getPrototypeOf(Uint8Array.prototype).constructor,Ye],_e=[{pack(e,t,r){let n=e.getTime()/1e3;if((this.useTimestamp32||e.getMilliseconds()===0)&&n>=0&&n<4294967296){let{target:i,targetView:c,position:u}=t(6);i[u++]=214,i[u++]=255,c.setUint32(u,n)}else if(n>0&&n<4294967296){let{target:i,targetView:c,position:u}=t(10);i[u++]=215,i[u++]=255,c.setUint32(u,e.getMilliseconds()*4e6+(n/1e3/4294967296>>0)),c.setUint32(u+4,n)}else if(isNaN(n)){if(this.onInvalidDate)return t(0),r(this.onInvalidDate());let{target:i,targetView:c,position:u}=t(3);i[u++]=212,i[u++]=255,i[u++]=255}else{let{target:i,targetView:c,position:u}=t(15);i[u++]=199,i[u++]=12,i[u++]=255,c.setUint32(u,e.getMilliseconds()*1e6),c.setBigInt64(u+4,BigInt(Math.floor(n)))}}},{pack(e,t,r){if(this.setAsEmptyObject)return t(0),r({});let n=Array.from(e),{target:i,position:c}=t(this.moreTypes?3:0);this.moreTypes&&(i[c++]=212,i[c++]=115,i[c++]=0),r(n)}},{pack(e,t,r){let{target:n,position:i}=t(this.moreTypes?3:0);this.moreTypes&&(n[i++]=212,n[i++]=101,n[i++]=0),r([e.name,e.message,e.cause])}},{pack(e,t,r){let{target:n,position:i}=t(this.moreTypes?3:0);this.moreTypes&&(n[i++]=212,n[i++]=120,n[i++]=0),r([e.source,e.flags])}},{pack(e,t){this.moreTypes?dt(e,16,t):xt(he?Buffer.from(e):new Uint8Array(e),t)}},{pack(e,t){let r=e.constructor;r!==ut&&this.moreTypes?dt(e,ot.indexOf(r.name),t):xt(e,t)}},{pack(e,t){let{target:r,position:n}=t(1);r[n]=193}}];function dt(e,t,r,n){let i=e.byteLength;if(i+1<256){var{target:c,position:u}=r(4+i);c[u++]=199,c[u++]=i+1}else if(i+1<65536){var{target:c,position:u}=r(5+i);c[u++]=200,c[u++]=i+1>>8,c[u++]=i+1&255}else{var{target:c,position:u,targetView:y}=r(7+i);c[u++]=201,y.setUint32(u,i+1),u+=4}c[u++]=116,c[u++]=t,e.buffer||(e=new Uint8Array(e)),c.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),u)}function xt(e,t){let r=e.byteLength;var n,i;if(r<256){var{target:n,position:i}=t(r+2);n[i++]=196,n[i++]=r}else if(r<65536){var{target:n,position:i}=t(r+3);n[i++]=197,n[i++]=r>>8,n[i++]=r&255}else{var{target:n,position:i,targetView:c}=t(r+5);n[i++]=198,c.setUint32(i,r),i+=4}n.set(e,i)}function sr(e,t,r,n){let i=e.length;switch(i){case 1:t[r++]=212;break;case 2:t[r++]=213;break;case 4:t[r++]=214;break;case 8:t[r++]=215;break;case 16:t[r++]=216;break;default:i<256?(t[r++]=199,t[r++]=i):i<65536?(t[r++]=200,t[r++]=i>>8,t[r++]=i&255):(t[r++]=201,t[r++]=i>>24,t[r++]=i>>16&255,t[r++]=i>>8&255,t[r++]=i&255)}return t[r++]=n,t.set(e,r),r+=i,r}function fr(e,t){let r,n=t.length*6,i=e.length-n;for(;r=t.pop();){let c=r.offset,u=r.id;e.copyWithin(c+n,c,i),n-=6;let y=c+n;e[y++]=214,e[y++]=105,e[y++]=u>>24,e[y++]=u>>16&255,e[y++]=u>>8&255,e[y++]=u&255,i=c}return e}function gt(e,t,r){if(P.length>0){O.setUint32(P.position+e,f+r-P.position-e),P.stringsPosition=f-e;let n=P;P=null,t(n[0]),t(n[1])}}function or(e,t){return e.isCompatible=r=>{let n=!r||(t.lastNamedStructuresLength||0)===r.length;return n||t._mergeStructures(r),n},e}let ht=new Re({useRecords:!1});ht.pack,ht.pack;const ar=512,cr=1024,ur=2048,lr=e=>new Re({structuredClone:!0}).unpack(new Uint8Array(e));function dr(e){return Ee(e)?gr(e):xr(e)}async function xr(e){const t=await ee(e);return Ae(t)}function gr(e){const t=Be(e);return Ae(t)}const yt=(e,t="application/octet-stream")=>e instanceof Blob?e:e instanceof ArrayBuffer?new Blob([e],{type:t}):typeof e=="string"?new Blob([e],{type:t}):ArrayBuffer.isView(e)?new Blob([e],{type:t}):Array.isArray(e)?new Blob([me(e)],{type:t}):new Blob([]),G={toMsgPack:e=>{const t=new Re({structuredClone:!0});return new Uint8Array(t.encode(e))},msgPackToObject:lr,typeOfBytes:e=>{if(e instanceof Blob)return"Blob";if(e instanceof ArrayBuffer)return"ArrayBuffer";if(typeof e=="string")return"string";if(ArrayBuffer.isView(e))return"ArrayBufferView";if(Array.isArray(e))return"Array"},toDataUrl:async e=>{const t=yt(e),r=new FileReader;return new Promise((n,i)=>{const c=u=>typeof u=="string"?n(u):(console.log({bytes:e}),i("Unable to convert to data URL"));r.onload=function(u){c(u.target?.result)},r.readAsDataURL(t)})},dataUrlToBlob:zt,lengthOf:Qt,isByteLike:Ht,isImmediateByteLike:Ee,hashOf:ue,immediateHashOf:Jt,addressStringOf:le,toArrayBuffer:ee,immediateToArrayBuffer:Be,toBlob:yt,toText:He,toBase64:dr,encodeAsString:Je,test:Ct,assignMediaTypeToBlob:$t,utf8ToUint8Array:e=>new TextEncoder().encode(e),base64ToArrayBuffer:Ft,arrayBufferToHex:Nt,arrayBufferToUtf8:qt,arrayBufferToBase64:Ae,ALL_ALGORITHMS:Se,ALGORITHM_BYTE_LENGTHS:Fe},hr=e=>typeof e=="function",wt=e=>e==null||Number.isNaN(e),pt=e=>!wt(e),yr=e=>hr(e)?e():e,wr={isDefined:pt,isUndefined:wt,safe:(e,t={})=>{const{quiet:r=!1,def:n=void 0,onError:i}=t;try{return e()}catch(c){return r||(console.error(c),pt(i)&&console.log(yr(i))),n}}},{isDefined:Le,isUndefined:pr,safe:St}=wr,De=e=>{const{message:t,stack:r,extra:n,cause:i}=e,c=i?`
Caused by: ${De(i)}`:"",u=n?`
Extra: ${JSON.stringify(n,void 0,2)}`:"";return[t,r].filter(Le).join(`
`)+u+c},bt=e=>typeof e=="string"?e:e instanceof Response?`${e.url} ${e.status} ${e.statusText}`:typeof e=="object"&&e!==null&&"message"in e?De(e):St(()=>JSON.stringify(e,void 0,2))??"",Sr=async e=>{if(typeof e=="string")return e;if(e instanceof Response){const t=await e.text();return`${e.url} ${e.status} ${e.statusText} ${t}`}return typeof e=="object"&&e!==null&&"message"in e?De(e):St(()=>JSON.stringify(e,void 0,2))??""},mt=({error:e,extra:t,stack:r})=>{if(e instanceof Error){const n=Le(e.cause)?mt({error:e.cause}):void 0;return{message:e.message,stack:e.stack??r,extra:t,cause:n}}return{message:bt(e),stack:r,extra:t}},br={errorToErrorDetail:mt,errorToText:bt,errorToTextAsync:Sr},At=async({channel:e,subject:t,connectionListener:r,options:n={}})=>{const{log:i=()=>{},signal:c}=n;i("connectConnectionListenerToSubject: subject: ",t);for await(const u of e.listenOn(t,{callback:async y=>{const w=G.msgPackToObject(y),{data:B,meta:S}=w;if($e(w))throw console.error("Error in message: ",w),new Error(`connectConnectionListenerToSubject: Unexpected error in request message: ${w?.data?.message}`);try{const b=await r(B,{headers:S?.headers,signal:c});return G.toMsgPack({data:b})}catch(b){const M=br.errorToErrorDetail({error:b});return G.toMsgPack({data:M,meta:{hasError:!0,code:500,status:M.message}})}}}));},mr=async({channel:e,subscribers:t={},options:r={}})=>{const{log:n=()=>{},defaultTimeoutMs:i=60*1e3,signal:c}=r,u=Object.entries(t);n("connect: subscribers: ",u);for(const[y,w]of u)pr(w)||At({channel:e,subject:y,connectionListener:w,options:r});return{requestMany:async(y,w,B={})=>{const{timeoutMs:S=60*1e3,headers:b,callback:M}=B,L=G.toMsgPack({data:w,meta:{headers:b}}),F=await e.requestMany(y,L,{timeoutMs:S});for await(const V of F){if(c?.aborted)return;const oe=G.msgPackToObject(V);await M?.(oe)}},request:async(y,w,B={})=>{const{timeoutMs:S=i,headers:b}=B,M=G.toMsgPack({data:w,meta:{headers:b}}),L=await e.request(y,M,{timeoutMs:S});return G.msgPackToObject(L)},publish:async(y,w,B={})=>{const{headers:S}=B,b=G.toMsgPack({data:w,meta:{headers:S}});return e.postOn(y,b)},subscribe:async(y,w,B={})=>At({channel:e,subject:y,connectionListener:w,options:B})}},Bt=({posterProducer:e,listenerProducer:t})=>{const r={postOn:(n,i,c={})=>{const{signal:u,reply:y}=c;e(u)({subject:n,data:i,reply:y})},listenOn:function(n,i={}){const{signal:c,once:u,callback:y}=i,w=new AbortController;c?.addEventListener("abort",()=>{w.abort()});const B=t(w.signal)(async S=>{if(typeof n=="string"?S.subject===n:n.test(S.subject)){const b=await y?.(S.data,{finished:S.finished??!1});if(S.reply&&b&&(Et(b)?(async()=>{for await(const M of b)e(w.signal)({subject:S.reply,data:M});e(w.signal)({subject:S.reply,data:void 0,finished:!0})})():e(w.signal)({subject:S.reply,data:b,finished:!0}),u&&w.abort()),b&&!Et(b))return{...S,data:b}}return S});return async function*(){for await(const S of B)yield S.data}()},request:async(n,i,c={})=>{const{signal:u,timeoutMs:y}=c,w=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((B,S)=>{u?.addEventListener("abort",()=>{S(new Error("Request aborted"))});let b;y&&(b=setTimeout(()=>{S(new Error(`Request timed out for ${n}`))},y)),r.listenOn(w,{callback:M=>{clearTimeout(b),B(M)},signal:u,once:!0}),r.postOn(n,i,{reply:w,signal:u})})},requestMany:async(n,i,c={})=>{const{signal:u,timeoutMs:y,callback:w}=c,B=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((S,b)=>{u?.addEventListener("abort",()=>{b(new Error("Request aborted"))});let M;y&&(M=setTimeout(()=>{b(new Error(`Request timed out for ${n}`))},y));const L=r.listenOn(B,{callback:(F,V)=>{if(F!==void 0&&w?.(F),V.finished)return clearTimeout(M),S(L)},signal:u});return r.postOn(n,i,{reply:B,signal:u}),L})}};return r};function Et(e){return e!=null&&typeof e[Symbol.asyncIterator]=="function"}const Ar=(e,t="channel_message")=>Bt({posterProducer:r=>n=>{r?.aborted||e.emit(t,n)},listenerProducer:r=>n=>{const i=[],c={resolve:void 0},u=async y=>{if(r?.aborted)return;const w=await n?.(y),B=Le(w)?w:y;i.push(B),c.resolve?.()};return r?.addEventListener("abort",()=>{e.off(t,u)}),e.on(t,u),{[Symbol.asyncIterator]:async function*(){for(;!r?.aborted;)i.length>0?yield i.shift():await new Promise(y=>{c.resolve=y})}}}});N.Channel=Bt,N.EmitterChannel=Ar,N.MessageBus=mr,N.isError=Ne,N.isErrorMsg=$e,N.isMsg=qe,N.isValue=Ce,N.isValueOrError=Mt,N.parseSubject=re,Object.defineProperty(N,Symbol.toStringTag,{value:"Module"})});
