(function(m,b){typeof exports=="object"&&typeof module<"u"?b(exports):typeof define=="function"&&define.amd?define(["exports"],b):(m=typeof globalThis<"u"?globalThis:m||self,b(m.Module={}))})(this,function(m){"use strict";const b=e=>{const t=e.split("."),r=t.shift(),s=t.join(".");return{root:r,segments:t,subpath:s}},E=e=>"value"in e&&e.value!==void 0,T=e=>"error"in e&&e.error!==void 0,A=e=>E(e)||T(e),x=e=>{const t=e;return typeof t=="object"&&t!==null&&"data"in t},O=e=>{const t=e;return x(e)&&t.meta?.hasError||!1},V=e=>typeof e=="function",D=e=>e==null||Number.isNaN(e),I=e=>!D(e),B=e=>V(e)?e():e,J={isDefined:I,isUndefined:D,safe:(e,t={})=>{const{quiet:r=!1,def:s=void 0,onError:n}=t;try{return e()}catch(i){return r||(console.error(i),I(n)&&console.log(B(n))),s}}},{isDefined:S,isUndefined:P,safe:C}=J,z=e=>e==null||Number.isNaN(e),G=e=>!z(e),K={isDefined:G,isUndefined:z},{isDefined:M,isUndefined:Q}=K,F=(e,t,r)=>{if(Q(e))return;const s=t.get(e);if(M(s))return s;if(M(r)){const n=r();return t.set(e,n),n}},H=()=>{const e=new Map;let t=performance.now();const r={get:(s,n)=>F(s,e,n),set:(s,n)=>(e.set(s,n),r),delete:s=>e.delete(s),entries:()=>Array.from(e.entries()),clear:()=>e.clear(),size:()=>e.size,findKeys:s=>Array.from(e.entries()).filter(([n,i])=>i===s).map(([n,i])=>n),lastUpdate:()=>t};return r},W={create:H},X=e=>t=>{if(typeof e=="string")return new RegExp(e).test(t.traceId);const{traceId:r,message:s,extra:n=()=>!0,timestamp:i=()=>!0}=e;return!(r&&!new RegExp(r).test(t.traceId)||s&&!new RegExp(s).test(t.message)||t.timestamp&&!i(t.timestamp)||t.extra&&!n(t.extra))},Y=e=>t=>{for(const r of e)if(X(r)(t))return r;return!1},Z=e=>t=>typeof e=="string"?t:e.transform?e.transform(t):t,$=e=>{const t=[],r={length:0,push:s=>{t.length>=e&&t.shift(),t.push(s),r.length=t.length},get:()=>t,clear:()=>{t.length=0,r.length=0},last:()=>t[t.length-1]};return r},U=()=>{let e=performance.now(),t;const r={end:()=>(M(t)||(t=performance.now()),r),getDuration:()=>(t??performance.now())-e};return r},_=(e=100)=>{let t=0;const r=new Map,s=new Map,n=new Map,i=$(e),c={clear:()=>(t=0,r.clear(),s.clear(),n.clear(),i.clear(),c),lastTime:()=>i.last(),time:()=>{const a=c.lastTime();M(a)&&a.end();const l=U();return i.push(l),l},getTimes:()=>i.get(),timer:a=>{const l=n.get(a)??$(e);n.set(a,l);const o=U();return l.push(o),o},increment:(a,l=1)=>{const o=r.get(a)??0;r.set(a,o+l)},gauge:(a,l=0)=>{s.set(a,l)},getCounters:()=>new Map(r),getCounter:a=>r.get(a)??0,getGauge:a=>s.get(a)??0,getGauges:()=>new Map(s),count:(a=1)=>{t+=a},getCount:()=>t,getTimers:a=>(n.get(a)??$(e)).get()};return c},ee=({logMatchers:e=[],logger:t=console.log,clock:r=performance,maxSampleSize:s=100}={})=>{const n=W.create(),i={getTraceIds:()=>n.entries().map(([c])=>c),start:(c,...a)=>{i.getStats(c).count(),i.getStats(c).time(),i.log({traceId:c,message:"start",extra:a})},getStats:c=>n.get(c,()=>_(s)),log:({traceId:c,message:a,timestamp:l=r.now(),extra:o=[]})=>{const f={traceId:c,message:a,timestamp:l,extra:o},g=Y(e)(f);if(!g)return;const u=Z(g)(f);t(`${u.timestamp} ${u.traceId}: ${u.message}`,...u.extra??[])},end:(c,...a)=>{i.getStats(c).lastTime()?.end(),i.log({traceId:c,message:"end",extra:a})}};return i},v=(e="",t=ee())=>{t.start(e);const r={span:s=>v(`${e}.${s}`,t),increment:(s,n=1)=>(t.getStats(e).increment(s,n),r),sample:(s,n,i)=>{if(Math.random()<s){const c=i();r.gauge(n,c)}return r},when:(s,n,i)=>{if(s()){const c=i();r.gauge(n,c)}return r},gauge:(s,n)=>(t.getStats(e).gauge(s,n),r),timer:s=>t.getStats(e).timer(s),end:()=>(t.end(e),r),log:(s,...n)=>(t.log({traceId:e,message:s,extra:n}),r)};return r},q=e=>{const{message:t,stack:r,extra:s,cause:n}=e,i=n?`
Caused by: ${q(n)}`:"",c=s?`
Extra: ${JSON.stringify(s,void 0,2)}`:"";return[t,r].filter(S).join(`
`)+c+i},R=e=>typeof e=="string"?e:e instanceof Response?`${e.url} ${e.status} ${e.statusText}`:typeof e=="object"&&e!==null&&"message"in e?q(e):C(()=>JSON.stringify(e,void 0,2))??"",te=async e=>{if(typeof e=="string")return e;if(e instanceof Response){const t=await e.text();return`${e.url} ${e.status} ${e.statusText} ${t}`}return typeof e=="object"&&e!==null&&"message"in e?q(e):C(()=>JSON.stringify(e,void 0,2))??""},j=({error:e,extra:t,stack:r})=>{if(e instanceof Error){const s=S(e.cause)?j({error:e.cause}):void 0;return{message:e.message,stack:e.stack??r,extra:t,cause:s}}return{message:R(e),stack:r,extra:t}},ne={errorToErrorDetail:j,errorToText:R,errorToTextAsync:te},k=async({channel:e,subject:t,connectionListener:r,serializer:s,options:n={}})=>{const{log:i=()=>{},signal:c}=n;i("connectConnectionListenerToSubject: subject: ",t);for await(const a of e.listenOn(t,{callback:async l=>{const o=s.deserialize(l),{data:f,meta:g}=o;if(O(o))throw console.error("Error in message: ",o),new Error(`connectConnectionListenerToSubject: Unexpected error in request message: ${o?.data?.message}`);try{const u=await r(f,{headers:g?.headers,signal:c});return s.serialize({data:u})}catch(u){const d=ne.errorToErrorDetail({error:u});return s.serialize({data:d,meta:{hasError:!0,code:500,status:d.message}})}}}));},se=()=>({serialize:e=>e,deserialize:e=>e}),re=async({channel:e,subscribers:t={},options:r={},obs:s=v()})=>{const n=s.span("MessageBus"),{defaultTimeoutMs:i=60*1e3,signal:c,serializer:a=se()}=r,l=Object.entries(t);n.log("connect: subscribers: ",l);for(const[o,f]of l)P(f)||k({serializer:a,channel:e,subject:o,connectionListener:f,options:r});return{requestMany:async(o,f,g={})=>{const u=n.span("requestMany"),{timeoutMs:d=60*1e3,headers:p,callback:y}=g,h=a.serialize({data:f,meta:{headers:p}}),w=u.span("channel requestMany").log("start requestMany",o),oe=await e.requestMany(o,h,{timeoutMs:d});for await(const ie of oe){if(c?.aborted)return;const ce=a.deserialize(ie);await y?.(ce)}w.end(),u.end()},request:async(o,f,g={})=>{const u=n.span("request").log("subject",o),{timeoutMs:d=i,headers:p}=g,y=a.serialize({data:f,meta:{headers:p}}),h=u.span(`channel:request:${o}`),w=await e.request(o,y,{timeoutMs:d});return h.end(),u.end(),a.deserialize(w)},publish:async(o,f,g={})=>{const{headers:u}=g,d=a.serialize({data:f,meta:{headers:u}});return n.span("publish").log("subject",o),e.postOn(o,d)},subscribe:async(o,f,g={})=>(n.span("subscribe").log("subject",o),k({channel:e,serializer:a,subject:o,connectionListener:f,options:g}))}},L=({posterProducer:e,listenerProducer:t,obs:r})=>{const s={postOn:(n,i,c={})=>{const a=r.span("postOn"),{signal:l,reply:o}=c;e(l)(n)({subject:n,data:i,reply:o}),a.end()},listenOn:function(n,i={}){const c=r.span("listenOn"),{signal:a,once:l,callback:o}=i,f=new AbortController;if(a?.aborted)throw new Error(`listenOn: Signal is already aborted for ${n}`);a?.addEventListener("abort",()=>{f.abort()});const g=t(f.signal)(n)(async u=>{if(u.subject===n){l&&f.abort();const d=await o?.(u.data,{finished:u.finished??!1});if(u.reply&&d&&(N(d)?(async()=>{for await(const p of d)e(f.signal)(u.reply)({subject:u.reply,data:p});e(f.signal)(u.reply)({subject:u.reply,data:void 0,finished:!0})})():e(f.signal)(u.reply)({subject:u.reply,data:d,finished:!0})),d&&!N(d))return{...u,data:d}}return u});return c.end(),async function*(){for await(const u of g)yield u.data}()},request:async(n,i,c={})=>{const a=r.span(`request:${n}`),{signal:l,timeoutMs:o}=c,f=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((g,u)=>{l?.aborted&&u(new Error(`request: Signal is already aborted for ${n}`)),l?.addEventListener("abort",()=>{u(new Error("Request aborted"))});let d;o&&(d=setTimeout(()=>{u(new Error(`request: Request timed out after ${o}ms for ${n}`))},o)),s.listenOn(f,{callback:p=>{clearTimeout(d),a.end(),g(p)},signal:l,once:!0}),s.postOn(n,i,{reply:f,signal:l})})},requestMany:async(n,i,c={})=>{const a=r.span(`requestMany:${n}`),{signal:l,timeoutMs:o,callback:f}=c,g=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((u,d)=>{l?.aborted&&d(new Error(`requestMany: Signal is already aborted for ${n}`)),l?.addEventListener("abort",()=>{d(new Error("Request aborted"))});let p;o&&(p=setTimeout(()=>{d(new Error(`requestMany: Request timed out after ${o}ms for ${n}`))},o));const y=s.listenOn(g,{callback:(h,w)=>{if(h!==void 0&&f?.(h),w.finished)return clearTimeout(p),a.end(),u(y)},signal:l});return s.postOn(n,i,{reply:g,signal:l}),y})}};return s};function N(e){return e!=null&&typeof e[Symbol.asyncIterator]=="function"}const ae=(e,t)=>L({obs:t,posterProducer:r=>s=>n=>{r?.aborted||e.emit(s,n)},listenerProducer:r=>s=>n=>{const i=[],c={resolve:void 0},a=async l=>{if(r?.aborted)return;const o=await n?.(l),f=S(o)?o:l;i.push(f),c.resolve?.()};return r?.addEventListener("abort",()=>{e.off(s,a)}),e.on(s,a),{[Symbol.asyncIterator]:async function*(){for(;!r?.aborted;)i.length>0?yield i.shift():await new Promise(l=>{c.resolve=l})}}}});m.Channel=L,m.EmitterChannel=ae,m.MessageBus=re,m.isError=T,m.isErrorMsg=O,m.isMsg=x,m.isValue=E,m.isValueOrError=A,m.parseSubject=b,Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
