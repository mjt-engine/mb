(function(g,b){typeof exports=="object"&&typeof module<"u"?b(exports):typeof define=="function"&&define.amd?define(["exports"],b):(g=typeof globalThis<"u"?globalThis:g||self,b(g.Module={}))})(this,function(g){"use strict";const b=e=>{const t=e.split("."),a=t.shift(),n=t.join(".");return{root:a,segments:t,subpath:n}},q=e=>"value"in e&&e.value!==void 0,T=e=>"error"in e&&e.error!==void 0,U=e=>q(e)||T(e),S=e=>{const t=e;return typeof t=="object"&&t!==null&&"data"in t},k=e=>{const t=e;return S(e)&&t.meta?.hasError||!1},B=e=>typeof e=="function",O=e=>e==null||Number.isNaN(e),x=e=>!O(e),N=e=>B(e)?e():e,V={isDefined:x,isUndefined:O,safe:(e,t={})=>{const{quiet:a=!1,def:n=void 0,onError:s}=t;try{return e()}catch(i){return a||(console.error(i),x(s)&&console.log(N(s))),n}}},{isDefined:w,isUndefined:A,safe:D}=V,J=e=>t=>{if(typeof e=="string")return new RegExp(e).test(t.traceId);const{traceId:a,message:n,extra:s=()=>!0,timestamp:i=()=>!0}=e;return!(a&&!new RegExp(a).test(t.traceId)||n&&!new RegExp(n).test(t.message)||t.timestamp&&!i(t.timestamp)||t.extra&&!s(t.extra))},F=e=>t=>{for(const a of e)if(J(a)(t))return!0;return!1},Q=({logMatchers:e=[],logger:t=console.log,clock:a=performance}={})=>{const n={start:(s,...i)=>{n.addLog({traceId:s,message:"start",extra:i})},addLog:({traceId:s,message:i,timestamp:u=a.now(),extra:d=[]})=>{F(e)({traceId:s,message:i,timestamp:u,extra:d})&&t(`${u} ${s}: ${i}`,...d)},end:(s,...i)=>{n.addLog({traceId:s,message:"end",extra:i})}};return n},I=(e="",t=Q())=>{t.start(e);const a={span:n=>I(`${e}.${n}`,t),end:()=>(t.end(e),a),log:(n,...s)=>(t.addLog({traceId:e,message:n,extra:s}),a)};return a},M=e=>{const{message:t,stack:a,extra:n,cause:s}=e,i=s?`
Caused by: ${M(s)}`:"",u=n?`
Extra: ${JSON.stringify(n,void 0,2)}`:"";return[t,a].filter(w).join(`
`)+u+i},j=e=>typeof e=="string"?e:e instanceof Response?`${e.url} ${e.status} ${e.statusText}`:typeof e=="object"&&e!==null&&"message"in e?M(e):D(()=>JSON.stringify(e,void 0,2))??"",z=async e=>{if(typeof e=="string")return e;if(e instanceof Response){const t=await e.text();return`${e.url} ${e.status} ${e.statusText} ${t}`}return typeof e=="object"&&e!==null&&"message"in e?M(e):D(()=>JSON.stringify(e,void 0,2))??""},L=({error:e,extra:t,stack:a})=>{if(e instanceof Error){const n=w(e.cause)?L({error:e.cause}):void 0;return{message:e.message,stack:e.stack??a,extra:t,cause:n}}return{message:j(e),stack:a,extra:t}},G={errorToErrorDetail:L,errorToText:j,errorToTextAsync:z},P=()=>({msgPackToObject:e=>e,toMsgPack:e=>e}),$=P(),C=async({channel:e,subject:t,connectionListener:a,options:n={}})=>{const{log:s=()=>{},signal:i}=n;s("connectConnectionListenerToSubject: subject: ",t);for await(const u of e.listenOn(t,{callback:async d=>{const r=$.msgPackToObject(d),{data:l,meta:o}=r;if(k(r))throw console.error("Error in message: ",r),new Error(`connectConnectionListenerToSubject: Unexpected error in request message: ${r?.data?.message}`);try{const c=await a(l,{headers:o?.headers,signal:i});return $.toMsgPack({data:c})}catch(c){const f=G.errorToErrorDetail({error:c});return $.toMsgPack({data:f,meta:{hasError:!0,code:500,status:f.message}})}}}));},p=P(),H=async({channel:e,subscribers:t={},options:a={},obs:n=I()})=>{const s=n.span("MessageBus"),{defaultTimeoutMs:i=60*1e3,signal:u}=a,d=Object.entries(t);s.log("connect: subscribers: ",d);for(const[r,l]of d)A(l)||C({channel:e,subject:r,connectionListener:l,options:a});return{requestMany:async(r,l,o={})=>{const c=s.span("requestMany"),{timeoutMs:f=60*1e3,headers:m,callback:y}=o,h=p.toMsgPack({data:l,meta:{headers:m}}),E=c.span("channel requestMany").log("start requestMany",r),W=await e.requestMany(r,h,{timeoutMs:f});for await(const X of W){if(u?.aborted)return;const Y=p.msgPackToObject(X);await y?.(Y)}E.end(),c.end()},request:async(r,l,o={})=>{const c=s.span("request").log("subject",r),{timeoutMs:f=i,headers:m}=o,y=p.toMsgPack({data:l,meta:{headers:m}}),h=c.span("channel request").log("requestData",y),E=await e.request(r,y,{timeoutMs:f});return h.end(),c.end(),p.msgPackToObject(E)},publish:async(r,l,o={})=>{const{headers:c}=o,f=p.toMsgPack({data:l,meta:{headers:c}});return s.span("publish").log("subject",r),e.postOn(r,f)},subscribe:async(r,l,o={})=>(s.span("subscribe").log("subject",r),C({channel:e,subject:r,connectionListener:l,options:o}))}},R=({posterProducer:e,listenerProducer:t})=>{const a={postOn:(n,s,i={})=>{const{signal:u,reply:d}=i;e(u)(n)({subject:n,data:s,reply:d})},listenOn:function(n,s={}){const{signal:i,once:u,callback:d}=s,r=new AbortController;if(i?.aborted)throw new Error(`listenOn: Signal is already aborted for ${n}`);i?.addEventListener("abort",()=>{r.abort()});const l=t(r.signal)(n)(async o=>{if(o.subject===n){u&&r.abort();const c=await d?.(o.data,{finished:o.finished??!1});if(o.reply&&c&&(v(c)?(async()=>{for await(const f of c)e(r.signal)(o.reply)({subject:o.reply,data:f});e(r.signal)(o.reply)({subject:o.reply,data:void 0,finished:!0})})():e(r.signal)(o.reply)({subject:o.reply,data:c,finished:!0})),c&&!v(c))return{...o,data:c}}return o});return async function*(){for await(const o of l)yield o.data}()},request:async(n,s,i={})=>{const{signal:u,timeoutMs:d}=i,r=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((l,o)=>{u?.aborted&&o(new Error(`request: Signal is already aborted for ${n}`)),u?.addEventListener("abort",()=>{o(new Error("Request aborted"))});let c;d&&(c=setTimeout(()=>{o(new Error(`request: Request timed out after ${d}ms for ${n}`))},d)),a.listenOn(r,{callback:f=>{clearTimeout(c),l(f)},signal:u,once:!0}),a.postOn(n,s,{reply:r,signal:u})})},requestMany:async(n,s,i={})=>{const{signal:u,timeoutMs:d,callback:r}=i,l=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((o,c)=>{u?.aborted&&c(new Error(`requestMany: Signal is already aborted for ${n}`)),u?.addEventListener("abort",()=>{c(new Error("Request aborted"))});let f;d&&(f=setTimeout(()=>{c(new Error(`requestMany: Request timed out after ${d}ms for ${n}`))},d));const m=a.listenOn(l,{callback:(y,h)=>{if(y!==void 0&&r?.(y),h.finished)return clearTimeout(f),o(m)},signal:u});return a.postOn(n,s,{reply:l,signal:u}),m})}};return a};function v(e){return e!=null&&typeof e[Symbol.asyncIterator]=="function"}const K=e=>R({posterProducer:t=>a=>n=>{t?.aborted||e.emit(a,n)},listenerProducer:t=>a=>n=>{const s=[],i={resolve:void 0},u=async d=>{if(t?.aborted)return;const r=await n?.(d),l=w(r)?r:d;s.push(l),i.resolve?.()};return t?.addEventListener("abort",()=>{e.off(a,u)}),e.on(a,u),{[Symbol.asyncIterator]:async function*(){for(;!t?.aborted;)s.length>0?yield s.shift():await new Promise(d=>{i.resolve=d})}}}});g.Channel=R,g.EmitterChannel=K,g.MessageBus=H,g.isError=T,g.isErrorMsg=k,g.isMsg=S,g.isValue=q,g.isValueOrError=U,g.parseSubject=b,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
