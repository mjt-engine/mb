(function(g,b){typeof exports=="object"&&typeof module<"u"?b(exports):typeof define=="function"&&define.amd?define(["exports"],b):(g=typeof globalThis<"u"?globalThis:g||self,b(g.Module={}))})(this,function(g){"use strict";const b=e=>{const t=e.split("."),s=t.shift(),n=t.join(".");return{root:s,segments:t,subpath:n}},T=e=>"value"in e&&e.value!==void 0,q=e=>"error"in e&&e.error!==void 0,A=e=>T(e)||q(e),x=e=>{const t=e;return typeof t=="object"&&t!==null&&"data"in t},D=e=>{const t=e;return x(e)&&t.meta?.hasError||!1},V=e=>typeof e=="function",I=e=>e==null||Number.isNaN(e),O=e=>!I(e),B=e=>V(e)?e():e,J={isDefined:O,isUndefined:I,safe:(e,t={})=>{const{quiet:s=!1,def:n=void 0,onError:r}=t;try{return e()}catch(i){return s||(console.error(i),O(r)&&console.log(B(r))),n}}},{isDefined:w,isUndefined:P,safe:C}=J,z=e=>e==null||Number.isNaN(e),G=e=>!z(e),K={isDefined:G,isUndefined:z},{isDefined:h,isUndefined:Q}=K,F=(e,t,s)=>{if(Q(e))return;const n=t.get(e);if(h(n))return n;if(h(s)){const r=s();return t.set(e,r),r}},H=()=>{const e=new Map;let t=performance.now();const s={get:(n,r)=>F(n,e,r),set:(n,r)=>(e.set(n,r),s),delete:n=>e.delete(n),entries:()=>Array.from(e.entries()),clear:()=>e.clear(),size:()=>e.size,findKeys:n=>Array.from(e.entries()).filter(([r,i])=>i===n).map(([r,i])=>r),lastUpdate:()=>t};return s},W={create:H},X=e=>t=>{if(typeof e=="string")return new RegExp(e).test(t.traceId);const{traceId:s,message:n,extra:r=()=>!0,timestamp:i=()=>!0}=e;return!(s&&!new RegExp(s).test(t.traceId)||n&&!new RegExp(n).test(t.message)||t.timestamp&&!i(t.timestamp)||t.extra&&!r(t.extra))},Y=e=>t=>{for(const s of e)if(X(s)(t))return s;return!1},Z=e=>t=>typeof e=="string"?t:e.transform?e.transform(t):t,S=e=>{const t=[],s={length:0,push:n=>{t.length>=e&&t.shift(),t.push(n),s.length=t.length},get:()=>t,clear:()=>{t.length=0,s.length=0},last:()=>t[t.length-1]};return s},U=()=>{let e=performance.now(),t;const s={end:()=>(h(t)||(t=performance.now()),s),getDuration:()=>(t??performance.now())-e};return s},_=(e=100)=>{let t=0;const s=new Map,n=new Map,r=new Map,i=S(e),o={clear:()=>(t=0,s.clear(),n.clear(),r.clear(),i.clear(),o),lastTime:()=>i.last(),time:()=>{const a=o.lastTime();h(a)&&a.end();const l=U();return i.push(l),l},getTimes:()=>i.get(),timer:a=>{const l=r.get(a)??S(e);r.set(a,l);const u=U();return l.push(u),u},increment:(a,l=1)=>{const u=s.get(a)??0;s.set(a,u+l)},gauge:(a,l=0)=>{n.set(a,l)},getCounters:()=>new Map(s),getCounter:a=>s.get(a)??0,getGauge:a=>n.get(a)??0,getGauges:()=>new Map(n),count:(a=1)=>{t+=a},getCount:()=>t,getTimers:a=>(r.get(a)??S(e)).get()};return o},ee=({logMatchers:e=[],logger:t=console.log,clock:s=performance,maxSampleSize:n=100}={})=>{const r=W.create(),i={getTraceIds:()=>r.entries().map(([o])=>o),start:(o,...a)=>{i.getStats(o).count(),i.getStats(o).time(),i.log({traceId:o,message:"start",extra:a})},getStats:o=>r.get(o,()=>_(n)),log:({traceId:o,message:a,timestamp:l=s.now(),extra:u=[]})=>{const c={traceId:o,message:a,timestamp:l,extra:u},f=Y(e)(c);if(!f)return;const d=Z(f)(c);t(`${d.timestamp} ${d.traceId}: ${d.message}`,...d.extra??[])},end:(o,...a)=>{i.getStats(o).lastTime()?.end(),i.log({traceId:o,message:"end",extra:a})}};return i},v=(e="",t=ee())=>{t.start(e);const s={span:n=>v(`${e}.${n}`,t),increment:(n,r=1)=>(t.getStats(e).increment(n,r),s),sample:(n,r,i)=>{if(Math.random()<n){const o=i();s.gauge(r,o)}return s},when:(n,r,i)=>{if(n()){const o=i();s.gauge(r,o)}return s},gauge:(n,r)=>(t.getStats(e).gauge(n,r),s),timer:n=>t.getStats(e).timer(n),end:()=>(t.end(e),s),log:(n,...r)=>(t.log({traceId:e,message:n,extra:r}),s)};return s},M=e=>{const{message:t,stack:s,extra:n,cause:r}=e,i=r?`
Caused by: ${M(r)}`:"",o=n?`
Extra: ${JSON.stringify(n,void 0,2)}`:"";return[t,s].filter(w).join(`
`)+o+i},R=e=>typeof e=="string"?e:e instanceof Response?`${e.url} ${e.status} ${e.statusText}`:typeof e=="object"&&e!==null&&"message"in e?M(e):C(()=>JSON.stringify(e,void 0,2))??"",te=async e=>{if(typeof e=="string")return e;if(e instanceof Response){const t=await e.text();return`${e.url} ${e.status} ${e.statusText} ${t}`}return typeof e=="object"&&e!==null&&"message"in e?M(e):C(()=>JSON.stringify(e,void 0,2))??""},j=({error:e,extra:t,stack:s})=>{if(e instanceof Error){const n=w(e.cause)?j({error:e.cause}):void 0;return{message:e.message,stack:e.stack??s,extra:t,cause:n}}return{message:R(e),stack:s,extra:t}},ne={errorToErrorDetail:j,errorToText:R,errorToTextAsync:te},k=async({channel:e,subject:t,connectionListener:s,serializer:n,options:r={}})=>{const{log:i=()=>{},signal:o}=r;i("connectConnectionListenerToSubject: subject: ",t);for await(const a of e.listenOn(t,{callback:async l=>{const u=n.deserialize(l),{data:c,meta:f}=u;if(D(u))throw console.error("Error in message: ",u),new Error(`connectConnectionListenerToSubject: Unexpected error in request message: ${u?.data?.message}`);try{const d=await s(c,{headers:f?.headers,signal:o});return n.serialize({data:d})}catch(d){const m=ne.errorToErrorDetail({error:d});return n.serialize({data:m,meta:{hasError:!0,code:500,status:m.message}})}}}));},se=()=>({serialize:e=>e,deserialize:e=>e}),re=async({channel:e,subscribers:t={},options:s={},obs:n=v()})=>{const r=n.span("MessageBus"),{defaultTimeoutMs:i=60*1e3,signal:o,serializer:a=se()}=s,l=Object.entries(t);r.log("connect: subscribers: ",l);for(const[u,c]of l)P(c)||k({serializer:a,channel:e,subject:u,connectionListener:c,options:s});return{requestMany:async(u,c,f={})=>{const d=r.span("requestMany"),{timeoutMs:m=60*1e3,headers:p,callback:y}=f,$=a.serialize({data:c,meta:{headers:p}}),E=d.span("channel requestMany").log("start requestMany",u),oe=await e.requestMany(u,$,{timeoutMs:m});for await(const ie of oe){if(o?.aborted)return;const ce=a.deserialize(ie);await y?.(ce)}E.end(),d.end()},request:async(u,c,f={})=>{const d=r.span("request").log("subject",u),{timeoutMs:m=i,headers:p}=f,y=a.serialize({data:c,meta:{headers:p}}),$=d.span(u).log("requestData",y),E=await e.request(u,y,{timeoutMs:m});return $.end(),d.end(),a.deserialize(E)},publish:async(u,c,f={})=>{const{headers:d}=f,m=a.serialize({data:c,meta:{headers:d}});return r.span("publish").log("subject",u),e.postOn(u,m)},subscribe:async(u,c,f={})=>(r.span("subscribe").log("subject",u),k({channel:e,serializer:a,subject:u,connectionListener:c,options:f}))}},L=({posterProducer:e,listenerProducer:t})=>{const s={postOn:(n,r,i={})=>{const{signal:o,reply:a}=i;e(o)(n)({subject:n,data:r,reply:a})},listenOn:function(n,r={}){const{signal:i,once:o,callback:a}=r,l=new AbortController;if(i?.aborted)throw new Error(`listenOn: Signal is already aborted for ${n}`);i?.addEventListener("abort",()=>{l.abort()});const u=t(l.signal)(n)(async c=>{if(c.subject===n){o&&l.abort();const f=await a?.(c.data,{finished:c.finished??!1});if(c.reply&&f&&(N(f)?(async()=>{for await(const d of f)e(l.signal)(c.reply)({subject:c.reply,data:d});e(l.signal)(c.reply)({subject:c.reply,data:void 0,finished:!0})})():e(l.signal)(c.reply)({subject:c.reply,data:f,finished:!0})),f&&!N(f))return{...c,data:f}}return c});return async function*(){for await(const c of u)yield c.data}()},request:async(n,r,i={})=>{const{signal:o,timeoutMs:a}=i,l=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((u,c)=>{o?.aborted&&c(new Error(`request: Signal is already aborted for ${n}`)),o?.addEventListener("abort",()=>{c(new Error("Request aborted"))});let f;a&&(f=setTimeout(()=>{c(new Error(`request: Request timed out after ${a}ms for ${n}`))},a)),s.listenOn(l,{callback:d=>{clearTimeout(f),u(d)},signal:o,once:!0}),s.postOn(n,r,{reply:l,signal:o})})},requestMany:async(n,r,i={})=>{const{signal:o,timeoutMs:a,callback:l}=i,u=`response-${Date.now()}-${crypto.randomUUID()}`;return new Promise((c,f)=>{o?.aborted&&f(new Error(`requestMany: Signal is already aborted for ${n}`)),o?.addEventListener("abort",()=>{f(new Error("Request aborted"))});let d;a&&(d=setTimeout(()=>{f(new Error(`requestMany: Request timed out after ${a}ms for ${n}`))},a));const m=s.listenOn(u,{callback:(p,y)=>{if(p!==void 0&&l?.(p),y.finished)return clearTimeout(d),c(m)},signal:o});return s.postOn(n,r,{reply:u,signal:o}),m})}};return s};function N(e){return e!=null&&typeof e[Symbol.asyncIterator]=="function"}const ae=e=>L({posterProducer:t=>s=>n=>{t?.aborted||e.emit(s,n)},listenerProducer:t=>s=>n=>{const r=[],i={resolve:void 0},o=async a=>{if(t?.aborted)return;const l=await n?.(a),u=w(l)?l:a;r.push(u),i.resolve?.()};return t?.addEventListener("abort",()=>{e.off(s,o)}),e.on(s,o),{[Symbol.asyncIterator]:async function*(){for(;!t?.aborted;)r.length>0?yield r.shift():await new Promise(a=>{i.resolve=a})}}}});g.Channel=L,g.EmitterChannel=ae,g.MessageBus=re,g.isError=q,g.isErrorMsg=D,g.isMsg=x,g.isValue=T,g.isValueOrError=A,g.parseSubject=b,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
